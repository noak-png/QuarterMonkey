<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Summit Forecast - Financial Forecaster</title>

<style>
/* ========== Base Theme Variables ========== */
:root {
  --bg: #f0f2f5; --card: #ffffff; --text: #1a1a1a; --muted: #6b7280;
  --accent: #059669; --ok: #16a34a; --danger: #ef4444; --pending: #e0f2fe; --pending-text: #075985; --pending-border: #bae6fd;
  --paid: #d1fae5; --paid-text: #065f46; --border: #dcdfe3;
  --shadow: 0 6px 16px rgba(0,0,0,.08);
  --font-family: system-ui, sans-serif; --font-size: 15px; /* Reduced base font size */
  --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --glass-tint: 255,255,255; --glass-alpha: 0.8; --glass-stroke: rgba(0,0,0,.08);
  --glass-shadow: 0 8px 28px rgba(0,0,0,.12); --glass-backdrop-sat: 150%;
  --glass-backdrop-blur: 8px; --slide-duration: 800ms; --slide-ease: cubic-bezier(.22,.61,.36,1);
}
.dark {
  --bg:#0b0d10; --card:#0f1418; --text:#e6eef6; --muted:#9aa4b2;
  --accent:#10b981; --ok:#22c55e; --danger:#f87171; --pending: #1e293b; --pending-text: #7dd3fc; --pending-border: #384252;
  --paid: #064e3b; --paid-text: #a7f3d0; --border:#1b2430;
  --shadow: 0 14px 36px rgba(0,0,0,.45); --glass-tint: 15,20,24;
  --glass-alpha: 0.65; --glass-stroke: rgba(255,255,255,.08);
  --glass-shadow: 0 18px 56px rgba(0,0,0,.55);
}

/* ========== Global & App Layout ========== */
*{box-sizing:border-box}
html { height: 100%; }
body {
  margin:0; min-height: 100vh; font-family:var(--font-family); font-size:var(--font-size);
  color:var(--text); background:var(--bg); line-height:1.4;
  transition: background .25s ease, color .25s ease;
  background-position:center center; background-repeat:no-repeat; background-size:cover;
  background-attachment:fixed; display: grid; place-items: center; padding: 20px;
}
.glass { background: rgba(var(--glass-tint), var(--glass-alpha)); backdrop-filter: saturate(var(--glass-backdrop-sat)) blur(var(--glass-backdrop-blur)); -webkit-backdrop-filter: saturate(var(--glass-backdrop-sat)) blur(var(--glass-backdrop-blur)); border: 1px solid var(--glass-stroke); box-shadow: var(--glass-shadow); }
.app { width:100%; max-width:980px; display:flex; flex-direction:column; gap:20px; z-index: 10;}
.title-wrap { width: 100%; padding:10px 16px; border-radius:14px; display: flex; justify-content: space-between; align-items: center; }
.title-wrap h1 { margin:0; font-size:24px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
.title-wrap h1 svg { width: 26px; height: 26px; fill: var(--accent); }
.header-controls { display: flex; align-items: center; gap: 8px; }
.ctrl-btn { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 8px; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
.ctrl-btn.active { background-color: var(--accent); color: white; border-color: var(--accent); }
.ctrl-btn svg { width: 20px; height: 20px; fill: currentColor; }

/* ========== Cards & Grids ========== */
.dashboard-container { display: flex; flex-direction: column; gap: 20px; width: 100%; }
.dashboard-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
.card, .summary-card, .finance-card, #pendingBillsCard, #expenseTrackerCard, #next30DaysCard { padding: 16px; border-radius: 16px; text-align: center; display: flex; flex-direction: column; }
.summary-card { justify-content: space-between; }
.card { border-radius:16px; width:100%; overflow:hidden; padding-bottom:10px; }
h2, h3 { margin: 0 0 10px; font-size: 14px; color: var(--muted); font-weight: 600; }
.card h2 { padding: 0 4px; }
.card-header { display: flex; justify-content: flex-end; align-items: center; margin: -4px -4px 12px; }
.card-header h2 { padding: 0; }
.add-bill-header-btn {
    background: var(--accent);
    color: white;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: background-color .2s ease-in-out;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow);
    height: 38px;
    width: auto;
    padding: 0 24px;
    border-radius: 999px;
    position: relative;
    z-index: 10;
    margin: -20px 0;
}
.add-bill-header-btn:hover { background: color-mix(in srgb, var(--accent) 90%, black); }
.link-button { background: transparent; border: none; color: var(--accent); cursor: pointer; font-size: 14px; padding: 8px; font-weight: 600; }
.link-button:hover { text-decoration: underline; }
.summary-card .amount { font-size: 36px; font-weight: 700; line-height: 1.1; }
.summary-card .projected-balance { font-size: 12px; color: var(--muted); margin-top: 4px; height: 1.2em; font-weight: 600; }
.summary-card .amount.paid { color: var(--ok); } .summary-card .amount.unpaid { color: var(--danger); } .summary-card .amount.total { color: var(--accent); }
.finance-card .finance-row { display: grid; grid-template-columns: max-content 1fr; gap: 12px; align-items: center; }
.finance-card label { font-weight: 600; font-size: 13px; text-align: right; }
.finance-card input, .finance-card select, #expenseTrackerCard input, #expenseTrackerCard select { flex-grow: 1; padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; background: transparent; color: var(--text); font-size: 14px; width: 100%; min-width: 0; }
#expenseTrackerCard form { display: flex; flex-direction: column; gap: 10px; margin-top: auto; }
#expenseTrackerCard button { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; }

/* Pending & 30-Day Bills */
#pendingBillsList, #next30DaysList { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; overflow-y: auto; padding-right: 5px; min-height: 80px; }
#next30DaysList { max-height: 207px; /* Approx 4 items */ }
#pendingBillsList { max-height: 95px; }
.upcoming-item { display: flex; justify-content: space-between; align-items: center; background: rgba(128,128,128,0.05); padding: 6px 10px; border-radius: 8px; }
.upcoming-item .name { font-weight: 600; font-size: 14px; }
.upcoming-item .details { font-size: 13px; text-align: right; }
.upcoming-item .amount { font-weight: 700; font-family: var(--font-mono); }
.upcoming-item .countdown { color: var(--muted); font-size: 11px; }

/* Add Bill Form & Bill List Table */
main.card { max-height: calc(100vh - 338px); }
.bill-table-wrapper { width: 100%; overflow-y: auto; flex-grow: 1; }
.bill-table-wrapper.scrollable {
    max-height: 300px; /* Approx height of 4-5 rows */
    overflow-y: auto;
    padding-right: 5px;
}
details#addBillSection > summary { list-style: none; cursor: pointer; font-weight: 600; padding: 12px 16px; border-bottom: 1px solid var(--border); margin: -16px -16px 16px; background: rgba(128,128,128,0.05); }
details#addBillSection > summary::-webkit-details-marker { display: none; }
.add-bill-form { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; padding: 0 16px 16px; border-bottom: 1px solid var(--border); align-items: center; }
#billNotes { grid-column: 1 / -1; } #addBtn { grid-column: 1 / -1; }
#splitBillInputs { grid-column: 1 / -1; display: none; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 6px; }
.add-bill-form input, .add-bill-form select { padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; background: var(--bg); color: var(--text); outline: none; font-size: 14px; }
.add-bill-form button { padding: 10px 14px; border: none; background: var(--accent); color: white; border-radius: 10px; cursor: pointer; font-weight: 600; }
table.bill-table { width: 100%; border-collapse: collapse; text-align: left; }
table.bill-table th, table.bill-table td { padding: 12px 16px; font-size: 14px; }
table.bill-table tbody tr { cursor: pointer; border-bottom: 1px dashed var(--border); }
.bill-details-cell { line-height: 1.3; }
.bill-name { font-weight: 600; }
.bill-sub-details { display: flex; gap: 8px; margin-top: 4px; }
.bill-category-badge, .bill-frequency-badge { font-size: 10px; padding: 2px 8px; border-radius: 999px; background: var(--bg); border: 1px solid var(--border); color: var(--muted); font-weight: 500;}
.split-info-icon { font-size: 11px; margin-left: 6px; color: var(--muted); border: 1px solid; padding: 1px 4px; border-radius: 6px; }
.bill-notes {
    font-size: 13px;
    color: var(--muted);
    white-space: pre-wrap; /* Allow wrapping */
    word-break: break-word; /* Break long words */
    max-height: 60px; /* Limit height to about 3-4 lines */
    overflow-y: auto; /* Add scroll for longer notes */
    padding: 4px 8px;
    background-color: rgba(128,128,128,0.05);
    border-radius: 6px;
    line-height: 1.4;
}
.bill-amount-cell .bill-amount { font-weight: 700; }
.bill-amount-cell .split-info-total { font-size: 11px; color: var(--muted); display: block; }
tr.paid { background-color: color-mix(in srgb, var(--ok) 8%, transparent); color: var(--paid-text); }
tr.paid td { box-shadow: inset 0 1px 0 0 var(--ok), inset 0 -1px 0 0 var(--ok); }
tr.paid td:first-child { box-shadow: inset 1px 1px 0 0 var(--ok), inset 0 -1px 0 0 var(--ok); border-radius: 8px 0 0 8px;}
tr.paid td:last-child { box-shadow: inset -1px 1px 0 0 var(--ok), inset 0 -1px 0 0 var(--ok); border-radius: 0 8px 8px 0;}
tr.paid .split-info-total, tr.paid .split-info-icon, tr.paid .bill-category-badge, tr.paid .bill-frequency-badge { color: var(--paid-text); border-color: currentColor; background: transparent; }
.date-box { text-align: center; border-radius: 8px; padding: 4px; width: 48px; flex-shrink: 0; border: 1px solid var(--border); }
.date-box .month { font-size: 10px; font-weight: 600; text-transform: uppercase; display: block; background-color: var(--accent); color: white; border-radius: 5px 5px 0 0; margin: -4px -4px 2px; padding: 2px; }
tr.paid .date-box .month { background-color: var(--ok); }

tr.pending { background-color: color-mix(in srgb, var(--pending) 8%, transparent); color: var(--pending-text); }
tr.pending td { box-shadow: inset 0 1px 0 0 var(--pending-border), inset 0 -1px 0 0 var(--pending-border); }
tr.pending td:first-child { box-shadow: inset 1px 1px 0 0 var(--pending-border), inset 0 -1px 0 0 var(--pending-border); border-radius: 8px 0 0 8px;}
tr.pending td:last-child { box-shadow: inset -1px 1px 0 0 var(--pending-border), inset 0 -1px 0 0 var(--pending-border); border-radius: 0 8px 8px 0;}
tr.pending .split-info-total, tr.pending .split-info-icon, tr.pending .bill-category-badge, tr.pending .bill-frequency-badge { color: var(--pending-text); border-color: currentColor; background: transparent; }
tr.pending .date-box .month { background-color: var(--pending-text); color: var(--pending); }

.date-box .day { font-size: 20px; font-weight: 700; line-height: 1; display: block; }
.countdown.overdue { color: var(--danger); font-weight: 600; }
.countdown.paid { color: var(--ok); font-weight: 600; }
.countdown.pending { color: var(--pending-text); font-weight: 600; }
.actions-cell { text-align: right; white-space: nowrap; cursor: default; width: 1%; }
.actions-cell button { background: transparent; border: 1px solid var(--border); padding: 6px 10px; border-radius: 8px; cursor: pointer; margin-left: 8px; }
.actions-cell .pay-btn { color: var(--ok); }
.actions-cell .pending-btn { color: var(--pending-text); }
.actions-cell .remove-btn { color: var(--danger); }

/* Default state for buttons inside a row */
.actions-cell .unpay-btn,
.actions-cell .pay-btn,
.actions-cell .pending-btn {
    display: none;
}

/* Show buttons based on row status */
tr.unpaid .pay-btn,
tr.unpaid .pending-btn {
    display: inline-block;
}

tr.pending .pay-btn,
tr.pending .unpay-btn {
    display: inline-block;
}

tr.paid .unpay-btn {
    display: inline-block;
}
.no-bills-message { padding: 40px; text-align: center; color: var(--muted); }
#pastBillsCard > summary { list-style: none; cursor: pointer; font-weight: 600; padding: 12px 16px; margin: -16px; background: rgba(128,128,128,0.05); }
#pastBillsCard > summary::-webkit-details-marker { display: none; }
#pastBillsCard[open] { padding-bottom: 16px; }

/* ========== Calendar View ========== */
#calendarView { padding: 16px; }
.calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 8px; }
.calendar-header button { background: none; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; width: 36px; height: 36px; }
.calendar-grid-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: var(--border); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
.calendar-day-name { text-align: center; font-weight: 600; font-size: 12px; padding: 8px 4px; background: var(--bg); color: var(--muted); }
.calendar-day { background: var(--card); min-height: 120px; padding: 4px; font-size: 12px; display: flex; flex-direction: column; }
.calendar-day.other-month { background: var(--bg); opacity: 0.7; }
.calendar-day .day-header { display: flex; justify-content: space-between; align-items: flex-start; }
.day-number { font-weight: 600; }
.calendar-day.today .day-number { color: white; background-color: var(--accent); border-radius: 50%; width: 22px; height: 22px; display: inline-flex; align-items: center; justify-content: center; }
.day-balance { font-size: 10px; font-weight: 700; color: var(--accent); }
.day-balance.negative { color: var(--danger); }
.bills-on-day { margin-top: 4px; display: flex; flex-direction: column; gap: 4px; flex-grow: 1; }
.bill-item-calendar { font-size: 11px; padding: 2px 6px; border-radius: 6px; background-color: var(--accent); color: white; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.bill-item-calendar.expense { background-color: var(--muted); }
.bill-item-calendar.paid { background-color: var(--ok); text-decoration: line-through; }

/* ========== Edit Modal ========== */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: grid; place-items: center; opacity: 0; visibility: hidden; transition: opacity .2s ease, visibility .2s; }
.modal-overlay.visible { opacity: 1; visibility: visible; }
.modal-content { width: 90%; max-width: 500px; padding: 24px; border-radius: 16px; transform: scale(0.95); transition: transform .2s ease; }
.modal-overlay.visible .modal-content { transform: scale(1); }
.modal-content h2 { margin-top: 0; }
.modal-form { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.modal-form label { font-weight: 600; font-size: 14px; text-align: left; grid-column: 1 / -1; margin-bottom: -8px; }
.modal-form .full-width { grid-column: 1 / -1; }
.modal-form input, .modal-form select, .modal-form textarea { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg); color: var(--text); }
.modal-form textarea { resize: vertical; min-height: 80px; }
.modal-buttons { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; grid-column: 1 / -1; }
.modal-buttons button { padding: 10px 16px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
.modal-buttons .save-btn { background: var(--accent); color: white; }
.modal-buttons .cancel-btn { background: var(--bg); color: var(--text); border: 1px solid var(--border); }

#dayBreakdownContent ul {
    list-style: none;
    padding: 0;
    margin: 0;
}
#dayBreakdownContent li {
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
}
#dayBreakdownContent li:last-child {
    border-bottom: none;
}
#dayBreakdownContent h3 {
    margin-top: 16px;
    margin-bottom: 8px;
}

/* ========== Natural Slide Animations ========== */
tr.slide-enter { opacity:0; transform:translateY(10px); }
tr.slide-enter-active { transition: opacity var(--slide-duration) var(--slide-ease), transform var(--slide-duration) var(--slide-ease); opacity:1; transform:translateY(0); }
tr.slide-out { transition: opacity calc(var(--slide-duration) / 2) ease, transform calc(var(--slide-duration) / 2) ease; opacity:0; transform:translateX(14px); }
tr.collapsing { overflow:hidden; height:0 !important; padding-top:0 !important; padding-bottom:0 !important; margin:0 !important; border:0 !important; transition: height var(--slide-duration) var(--slide-ease) !important; }

/* ========== Clock & Settings Menu (Condensed) ========== */
.clock-display{ position:fixed; padding:8px 12px; border-radius:12px; z-index:1100; }
.pos-top-left{ top:10px; left:10px; } .pos-top-center{ top:10px; left:50%; transform:translateX(-50%); } .pos-top-right{ top:10px; right:20px; }
.pos-bottom-left{ bottom:10px; left:10px; } .pos-bottom-center{ bottom:10px; left:50%; transform:translateX(-50%); } .pos-bottom-right{ bottom:10px; right:10px; }
#ambianceCanvas{ position:fixed; inset:0; pointer-events:none; z-index: 5; }
.menu-panel{ position:fixed; top:78px; right:20px; border-radius:12px; padding:14px; width:540px; display:none; z-index:1100; max-height:calc(100vh - 100px); overflow:auto; }
.menu-panel .section, .sub-section { border:1px solid var(--border); border-radius:10px; overflow:hidden; margin-top: 10px; }
.menu-panel summary{ list-style:none; cursor:pointer; padding:12px 14px; display:flex; align-items:center; justify-content:space-between; font-weight:700; background:rgba(128,128,128,0.08); border-radius: 8px; }
.sub-section summary { font-weight: 600; font-size: 14px; background: rgba(128,128,128,0.04); padding: 10px 12px; }
.menu-panel .content{ padding:10px 12px 14px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:10px; }
.slider-row{ display:flex; align-items:center; gap:10px; } .slider-row label{ min-width:148px; } .slider-row input[type=range]{ flex:1; }
.pct{ min-width:48px; text-align:right; font-size:12px; color:var(--muted); }
.menu-notch{ position:sticky; bottom:0; display:flex; justify-content:center; padding:12px 0 2px; margin-top:8px; }
.menu-notch button{ border:none; cursor:pointer; font-weight:600; padding:12px 16px; border-radius:999px; background:var(--card); color:var(--text); border:1px solid var(--border); box-shadow:var(--shadow); }
.stack{ display:flex; flex-direction:column; gap:8px; } .hr{ border:none; border-top:1px solid var(--border); margin:6px 0; }

@media (max-width: 768px) { body { padding: 10px; } .app { gap: 16px; } .dashboard-container, .dashboard-row { grid-template-columns: 1fr; } main#billTrackerCard { max-height: calc(100vh - 188px); } .menu-panel{ right:8px; left:8px; width:auto; top:70px; } .calendar-day { min-height: 80px; } }

@media print {
    body > *:not(#app), 
    #app > *:not(#calendarView),
    .menu-panel, .clock-display, #editModal, #archiveView {
        display: none !important;
    }
    .app, body {
        padding: 0;
        margin: 0;
        background: none;
    }
    #calendarView {
        display: block !important;
        max-width: 100% !important;
        box-shadow: none !important;
        border: none !important;
        background: white !important;
        color: black !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    .glass {
        background: transparent !important;
        backdrop-filter: none !important;
        --glass-stroke: #ccc !important;
        border-color: #ccc !important;
    }
    .calendar-header .ctrl-btn {
        display: none !important;
    }
    .calendar-header h2 {
        color: black !important;
    }
    .bill-item-calendar {
        background-color: #eee !important;
        color: #333 !important;
        border: 1px solid #ddd;
    }
    .bill-item-calendar.paid {
        background-color: #e8f5e9 !important;
        color: #2e7d32 !important;
        text-decoration: none;
    }
    .calendar-day.today .day-number {
        background-color: #ddd !important;
        color: black !important;
    }
    :root {
        --text: #000;
        --muted: #555;
        --card: #fff;
        --bg: #fff;
        --border: #ccc;
    }
}

/* Custom styles for pending state */
tr.pending { background-color: color-mix(in srgb, var(--pending) 8%, transparent); color: var(--pending-text); }
tr.pending td { box-shadow: inset 0 1px 0 0 var(--pending-border), inset 0 -1px 0 0 var(--pending-border); }
tr.pending td:first-child { box-shadow: inset 1px 1px 0 0 var(--pending-border), inset 0 -1px 0 0 var(--pending-border); border-radius: 8px 0 0 8px;}
tr.pending td:last-child { box-shadow: inset -1px 1px 0 0 var(--pending-border), inset 0 -1px 0 0 var(--pending-border); border-radius: 0 8px 8px 0;}
tr.pending .split-info-total, tr.pending .split-info-icon, tr.pending .bill-category-badge, tr.pending .bill-frequency-badge { color: var(--pending-text); border-color: currentColor; background: transparent; }
tr.pending .date-box .month { background-color: var(--pending-text); color: var(--pending); }
.countdown.pending { color: var(--pending-text); font-weight: 600; }
.actions-cell .pending-btn { color: var(--pending-text); }

/* Default state for buttons inside a row */
.actions-cell .unpay-btn,
.actions-cell .pay-btn,
.actions-cell .pending-btn {
    display: none;
}

/* Show buttons based on row status */
tr.unpaid .pay-btn,
tr.unpaid .pending-btn {
    display: inline-block;
}

tr.pending .pay-btn,
tr.pending .unpay-btn {
    display: inline-block;
}

tr.paid .unpay-btn {
    display: inline-block;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf-autotable.umd.min.js"></script>
</head>
<body>
  <canvas id="ambianceCanvas"></canvas>
  <div class="app" id="app">
    <header class="title-wrap glass">
      <h1><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2ZM13,17H11V15H13V17ZM13,13H11V7H13V13Z" /></svg>Summit Forecast</h1>
      <div class="header-controls">
        <button id="darkToggle" class="ctrl-btn dark-toggle" title="Toggle Dark Mode">🌙</button>
        <button id="calendarToggleBtn" class="ctrl-btn" title="Toggle Calendar View"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,19H5V8H19M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M16.53,11.06L15.47,10L10.5,14.97L8.47,12.94L7.41,14L10.5,17.09L16.53,11.06Z"/></svg></button>
        <button id="menuBtn" class="ctrl-btn menu-btn" title="Open Settings"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg></button>
      </div>
    </header>

    <div class="dashboard-container">
        <div class="dashboard-row">
            <div class="summary-card glass"><h3 id="totalAmountLabel">Current Balance</h3><div class="amount total" id="totalAmount">$0.00</div></div>
            <div class="summary-card glass"><h3 id="totalDueNext10DaysLabel">Total Due (Next 10 Days)</h3><div class="amount unpaid" id="totalDueNext10Days">$0.00</div><div class="projected-balance" id="projectedBalanceTotal"></div></div>
            <div class="summary-card glass" id="yourShareCard"><h3 id="yourShareNext10DaysLabel">Your Share (Next 10 Days)</h3><div class="amount total" id="yourShareNext10Days">$0.00</div><div class="projected-balance" id="projectedBalanceShare"></div></div>
            <div id="pendingBillsCard" class="glass"><h2>Pending</h2><div id="pendingBillsList"></div></div>
        </div>
        <div class="dashboard-row">
            <div id="next30DaysCard" class="glass"><h2>Next 30 Days</h2><div id="next30DaysList"></div></div>
            <div class="finance-card glass">
                <h3>My Finances</h3>
                <div class="stack">
                    <div class="finance-row"><label for="currentBalance">Balance:</label><input type="number" id="currentBalance" placeholder="$0.00"></div>
<div class="finance-row"><label for="dontAutoDeduct">Don't auto-deduct:</label><input type="checkbox" id="dontAutoDeduct" style="width: auto; justify-self: start;"></div>
                    <div class="finance-row"><label for="paycheckAmount">Next/Est Paycheck:</label><input type="number" id="paycheckAmount" placeholder="$0.00"></div>
                    <div class="finance-row"><label for="nextPayday">Next Payday:</label><input type="date" id="nextPayday"></div>
                    <div class="finance-row"><label for="payFrequency">Frequency:</label><select id="payFrequency"><option>Weekly</option><option selected>Bi-Weekly</option><option>Monthly</option></select></div>
                </div>
            </div>
            <div id="expenseTrackerCard" class="glass">
                <h3>Log an Expense</h3>
                <div id="expenseQuickOptions" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <button class="ctrl-btn quick-expense-btn" data-expense="Food" style="width:100%; height:auto; padding: 12px;">Food 🍔</button>
                    <button class="ctrl-btn quick-expense-btn" data-expense="Gas" style="width:100%; height:auto; padding: 12px;">Gas ⛽</button>
                    <button class="ctrl-btn quick-expense-btn" data-expense="Coffee" style="width:100%; height:auto; padding: 12px;">Coffee ☕</button>
                    <button class="ctrl-btn quick-expense-btn" data-expense="Cigarettes" style="width:100%; height:auto; padding: 12px;">Cigarettes 🚬</button>
                    <button class="ctrl-btn quick-expense-btn" data-expense="Baseball Cards" style="width:100%; height:auto; padding: 12px;">Cards 🃏</button>
                    <button class="ctrl-btn quick-expense-btn" data-expense="Groceries" style="width:100%; height:auto; padding: 12px;">Groceries 🛒</button>
                    <button class="ctrl-btn" id="customExpenseBtn" style="width:100%; height:auto; padding: 12px; grid-column: 1 / -1;">Custom</button>
                </div>
                <form id="expenseForm" style="display: none;">
                    <input type="text" id="expenseDescription" placeholder="e.g., Lunch" required>
                    <input type="number" id="expenseAmount" placeholder="$ Amount" required>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button type="button" id="cancelCustomExpenseBtn">Cancel</button>
                        <button type="submit">Log Expense</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <main id="billTrackerCard" class="card glass" role="main">
      <div class="bill-table-wrapper">
        <table class="bill-table" id="billList">
            <tbody id="billListBody"></tbody>
        </table>
        <div class="no-bills-message" id="noBillsMessage"><p>No upcoming bills. Add one to get started! 💸</p></div>
      </div>
    </main>

    <div style="text-align: right; padding-right: 25%;">
        <button id="addBillBtnHeader" class="add-bill-header-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="vertical-align: middle; margin-right: 8px;"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6z"></path></svg>Add Bill
        </button>
    </div>

    <details id="pastBillsCard" class="card glass">
        <summary>Past Bills</summary>
        <div class="bill-table-wrapper">
            <table class="bill-table" id="pastBillsTable">
                <thead><tr><th>Due Date</th><th>Bill Details</th><th>Notes</th><th>Amount</th><th style="text-align: right;">Actions</th></tr></thead>
                <tbody id="pastBillsListBody"></tbody>
            </table>
             <div class="no-bills-message" id="noPastBillsMessage" style="display: none;"><p>No paid bills yet.</p></div>
        </div>
        <div class="card-footer" style="text-align: center; padding-top: 10px;">
            <button id="archiveBtn" class="link-button">View Full Archive</button>
        </div>
    </details>

    <div id="calendarView" class="card glass" style="display: none;"></div>
  </div>

  <div id="archiveView" class="app" style="display: none;">
    <main class="card glass" role="main">
        <div class="card-header">
            <h2>Bill Archive</h2>
            <button id="backFromArchiveBtn" class="add-bill-header-btn">← Go Back</button>
        </div>
        <div class="bill-table-wrapper" id="archive-table-wrapper">
            <table class="bill-table" id="archiveBillsTable">
                <thead><tr><th>Paid Date</th><th>Bill Details</th><th>Notes</th><th>Amount</th><th style="text-align: right;">Actions</th></tr></thead>
                <tbody id="archiveBillsListBody"></tbody>
            </table>
            <div class="no-bills-message" id="noArchivedBillsMessage" style="display: none;"><p>No archived bills found.</p></div>
        </div>
    </main>
  </div>
  
  <div class="clock-display glass" id="clockDisplay" style="display:none;"></div>

  <div id="editModal" class="modal-overlay"><div class="modal-content glass"><h2>Edit Bill</h2><div class="modal-form"><label for="editBillName">Bill Name</label><input type="text" id="editBillName" class="full-width"><label for="editBillAmount">Total Amount</label><input type="number" step="0.01" id="editBillAmount" class="full-width"><label for="editBillDate">Due Date</label><input type="date" id="editBillDate" class="full-width"><label for="editBillCategory">Category</label><select id="editBillCategory" class="full-width"></select><label for="editBillFrequency">Frequency</label><select id="editBillFrequency" class="full-width"></select><label for="editBillNotes">Notes</label><textarea id="editBillNotes" class="full-width"></textarea><div id="editSplitBillInputs" class="full-width" style="display: none;"><hr><label>Split Info</label><input type="text" id="editBillSplitName" placeholder="Split with (Name)"><input type="number" id="editBillSplitAmount" placeholder="Their Share ($)"></div><div class="modal-buttons"><button type="button" class="cancel-btn" id="closeModalBtn">Cancel</button><button type="button" class="save-btn" id="saveEditBtn">Save Changes</button></div></div></div></div>
  
  <div id="dayBreakdownModal" class="modal-overlay">
    <div class="modal-content glass">
      <h2 id="dayBreakdownTitle">Day Breakdown</h2>
      <div id="dayBreakdownContent"></div>
      <div class="modal-buttons">
        <button type="button" class="cancel-btn" id="closeDayBreakdownModalBtn">Close</button>
      </div>
    </div>
  </div>

  <div id="addBillModal" class="modal-overlay">
    <div class="modal-content glass">
      <h2>Add New Bill</h2>
      <form class="add-bill-form" id="addBillForm" style="border-bottom: none; padding-bottom: 0;">
          <input id="billName" type="text" placeholder="Bill Name (e.g., Netflix)" required class="full-width" />
          <input id="billAmount" type="number" placeholder="Total Amount ($)" step="0.01" min="0" />
          <input id="billDate" type="date" required />
          <select id="billFrequency"><option>One-Time</option><option selected>Monthly</option><option>Quarterly</option><option>Annually</option></select>
          <select id="billCategory"><option>Utilities</option><option>Subscription</option><option>Rent/Mortgage</option><option>Loan</option><option>Insurance</option><option>Groceries</option><option>Personal</option><option>Other</option><option value="Expense">Expense</option></select>
          <input id="billNotes" type="text" placeholder="Notes (optional)" class="full-width" />
          <div id="splitBillInputs" class="full-width"><input type="text" id="billSplitName" placeholder="Split with (Name)"><input type="number" id="billSplitAmount" placeholder="Their Share ($)"></div>
          <div class="modal-buttons full-width">
            <button type="button" class="cancel-btn" id="closeAddBillModalBtn">Cancel</button>
            <button id="addBtn" type="button" class="save-btn">Add Bill</button>
          </div>
      </form>
    </div>
  </div>

  <div class="menu-panel glass" id="menuPanel" aria-hidden="true">
    <div class="section"><details><summary>Appearance</summary>
        <div class="content">
          <div class="sub-section"><details><summary>User Interface</summary><div class="content"><div class="stack"><label for="uiStyleSelect">Style</label><select id="uiStyleSelect"></select></div><div class="slider-row"><label for="glassOpacity">Opacity</label><input type="range" id="glassOpacity" min="10" max="100" value="80" /><span class="pct" id="glassOpacityPct"></span></div><div class="slider-row"><label for="glassBlurSlider">Blur</label><input type="range" id="glassBlurSlider" min="0" max="20" value="8" /><span class="pct" id="glassBlurPct"></span></div></div></details></div>
          <div class="sub-section"><details><summary>Animations</summary><div class="content"><label><input type="checkbox" id="enableNaturalSlide"> Natural Slide Animation</label><div class="slider-row"><label for="slideSpeed">Speed</label><input type="range" id="slideSpeed" min="200" max="1400" value="800" /><span class="pct" id="slideSpeedPct"></span></div></div></details></div>
          <div class="sub-section"><details><summary>Background</summary><div class="content"><div class="stack"><label><input type="checkbox" id="enableCustomBackground">Enable Custom Background</label></div><div id="customBackgroundOptions" class="stack" style="display:none;"><div class="hr"></div><div class="stack"><label for="backgroundType">Type</label><select id="backgroundType"><option value="theme" selected>Theme</option><option value="image">Image</option><option value="color">Gradient</option></select></div><div id="imageWallpaperControls" style="display:none; margin-top: 10px;"><input type="file" id="wallpaperFile" accept="image/*" /></div><div id="colorWallpaperControls" class="stack" style="display:none; margin-top: 10px;"><label>Start Color: <input type="color" id="wallpaperColor3" value="#1e1b4b"></label><label>End Color: <input type="color" id="wallpaperColor2" value="#4c1d95"></label><div class="slider-row"><label for="gradientAngle">Angle</label><input type="range" id="gradientAngle" min="0" max="360" value="145"><span class="pct" id="gradientAnglePct"></span></div><div class="stack"><label><input type="checkbox" id="gradientSpinToggle">Enable Spinning</label><div class="slider-row" id="gradientSpinControls" style="display:none;"><label for="gradientSpinSpeed">Speed</label><input type="range" id="gradientSpinSpeed" min="1" max="100" value="10"><span class="pct" id="gradientSpinSpeedPct"></span></div></div></div></div><div class="hr"></div><div class="stack"><label><input type="checkbox" id="enableAmbiance">Enable Live Effects</label><div id="ambianceSettings" class="stack" style="display:none; margin-top: 10px;"><select id="ambianceSelect"><option value="none" selected>None</option><option value="snowflakes">Snowflakes</option><option value="orbs">Orbs</option><option value="starfield">Starfield</option></select><div id="ambianceControls" class="stack" style="display:none; border:1px solid var(--border); border-radius:8px; padding:10px; gap: 10px;"><div id="snowControls" class="stack" style="display:none;"><div class="slider-row"><label>Density</label><input type="range" id="snowDensity" min="0" max="300" value="100"><span class="pct" id="snowDensityPct"></span></div><div class="slider-row"><label>Size</label><input type="range" id="snowSize" min="10" max="40" value="20"><span class="pct" id="snowSizePct"></span></div><div class="slider-row"><label>Speed</label><input type="range" id="snowSpeed" min="10" max="100" value="30"><span class="pct" id="snowSpeedPct"></span></div></div><div id="orbsControls" class="stack" style="display:none;"><div class="slider-row"><label>Density</label><input type="range" id="orbsDensity" min="10" max="150" value="40"><span class="pct" id="orbsDensityPct"></span></div><div class="slider-row"><label>Size</label><input type="range" id="orbsSize" min="20" max="150" value="70"><span class="pct" id="orbsSizePct"></span></div><div class="slider-row"><label>Speed</label><input type="range" id="orbsSpeed" min="5" max="100" value="20"><span class="pct" id="orbsSpeedPct"></span></div><label>Color: <input type="color" id="orbsColor" value="#9aa4b2"></label></div><div id="starfieldControls" class="stack" style="display:none;"><div class="slider-row"><label>Density</label><input type="range" id="starfieldDensity" min="50" max="1500" value="500"><span class="pct" id="starfieldDensityPct"></span></div><div class="slider-row"><label>Speed</label><input type="range" id="starfieldSpeed" min="1" max="100" value="25"><span class="pct" id="starfieldSpeedPct"></span></div></div></div></div></div></div></details></div>
    </div></details></div>
    <div class="section"><details><summary>Utility</summary><div class="content"><div class="stack"><label><input type="checkbox" id="enableClock"> Enable Clock</label><div id="clockOptionsWrapper" class="stack" style="display:none;"><label for="clockPosition">Position</label><select id="clockPosition"><option value="pos-top-left">Top Left</option><option value="pos-top-center">Top Center</option><option value="pos-top-right" selected>Top Right</option><option value="pos-bottom-left">Bottom Left</option><option value="pos-bottom-center">Bottom Center</option><option value="pos-bottom-right">Bottom Right</option></select><label for="clockDetail">Detail Level</label><select id="clockDetail"><option value="time">Time</option><option value="timeSec">Time w/ Seconds</option><option value="dateTime" selected>Date & Time</option></select></div></div><div class="hr"></div><div class="sub-section"><details open><summary>Data Management</summary><div class="content"><div class="stack"><p style="font-size:12px;color:var(--muted);margin:4px 0 0;">Import or export your full application profile. This includes all bills, settings, and appearance customizations.</p><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;"><button id="importProfileBtn" class="ctrl-btn" style="width:100%; height:auto; padding: 10px;">Import Profile</button><button id="exportProfileBtn" class="ctrl-btn" style="width:100%; height:auto; padding: 10px;">Export Profile</button></div></div></div></details></div><div class="hr"></div><div class="sub-section"><details><summary>Experimental</summary><div class="content"><label><input type="checkbox" id="enableSplitBillMode"> Enable Split Bill Mode</label><p style="font-size:12px;color:var(--muted);margin:4px 0 0;">Adds options to split a bill with another person.</p></div></details></div></div></details></div>
    <div class="menu-notch"><button id="closeMenuNotch">Close</button></div>
  </div>

<script>
// IFFE to encapsulate the entire application
(function(){
    "use strict";
    // --- All JavaScript logic from the previous functional version is included below ---
    // Key changes are documented in the function definitions.
    
    // --- STATE & DOM ---
    let bills = [], userFinances = {}, currentView = 'list', calendarDate = new Date(), clockInterval = null;
    const $ = (s) => document.getElementById(s);
    const billTrackerCard = $('billTrackerCard'), pastBillsCard = $('pastBillsCard'), calendarView = $('calendarView'), calendarToggleBtn = $('calendarToggleBtn'), billListBody = $('billListBody'), pastBillsListBody = $('pastBillsListBody');
    const addBillForm = $('addBillForm');
    const splitBillInputs = $('splitBillInputs');
    const addBtn = $('addBtn'), noBillsMessage = $('noBillsMessage'), noPastBillsMessage = $('noPastBillsMessage'), darkToggle = $('darkToggle'), menuBtn = $('menuBtn'), menuPanel = $('menuPanel'), closeMenuNotch = $('closeMenuNotch');
    const totalAmountEl = $('totalAmount'), totalDueNext10DaysEl = $('totalDueNext10Days'), yourShareNext10DaysEl = $('yourShareNext10Days');
    const pendingBillsList = $('pendingBillsList'), next30DaysList = $('next30DaysList');
    const currentBalance = $('currentBalance'), paycheckAmount = $('paycheckAmount'), nextPayday = $('nextPayday'), payFrequency = $('payFrequency');
    const expenseForm = $('expenseForm');
    const editModal = $('editModal'), closeModalBtn = $('closeModalBtn'), saveEditBtn = $('saveEditBtn');
    const addBillModal = $('addBillModal'), closeAddBillModalBtn = $('closeAddBillModalBtn');
    const editSplitBillInputs = $('editSplitBillInputs');
    const addBillBtnHeader = $('addBillBtnHeader');
    const archiveView = $('archiveView'), appView = $('app'), archiveBtn = $('archiveBtn'), backFromArchiveBtn = $('backFromArchiveBtn');
    const archiveBillsListBody = $('archiveBillsListBody'), noArchivedBillsMessage = $('noArchivedBillsMessage');
    const ambianceCanvas = $('ambianceCanvas'), ctxAmbiance = ambianceCanvas.getContext('2d');
    const uiStyleSelect = $('uiStyleSelect'), glassOpacity = $('glassOpacity'), glassBlurSlider = $('glassBlurSlider');
    const enableNaturalSlide = $('enableNaturalSlide'), slideSpeed = $('slideSpeed');
    const enableCustomBackground = $('enableCustomBackground'), customBackgroundOptions = $('customBackgroundOptions'), backgroundType = $('backgroundType');
    const wallpaperFile = $('wallpaperFile'), wallpaperColor2 = $('wallpaperColor2'), wallpaperColor3 = $('wallpaperColor3');
    const gradientAngle = $('gradientAngle'), gradientSpinToggle = $('gradientSpinToggle'), gradientSpinControls = $('gradientSpinControls'), gradientSpinSpeed = $('gradientSpinSpeed');
    const enableAmbiance = $('enableAmbiance'), ambianceSettings = $('ambianceSettings'), ambianceControls = $('ambianceControls'), ambianceSelect = $('ambianceSelect');
    const snowDensity = $('snowDensity'), snowSize = $('snowSize'), snowSpeed = $('snowSpeed');
    const orbsDensity = $('orbsDensity'), orbsSize = $('orbsSize'), orbsSpeed = $('orbsSpeed'), orbsColor = $('orbsColor');
    const starfieldDensity = $('starfieldDensity'), starfieldSpeed = $('starfieldSpeed');
    const enableSplitBillMode = $('enableSplitBillMode');
    const dontAutoDeduct = $('dontAutoDeduct');
    const clockDisplay = $('clockDisplay'), enableClock = $('enableClock'), clockOptionsWrapper = $('clockOptionsWrapper'), clockPosition = $('clockPosition'), clockDetail = $('clockDetail');
    let ambianceParticles = [], gradientAnimationAngle = 0;
    const materialPresets = { glass: { styles: { 'default': { name: 'Default', light: '255,255,255', dark: '15,20,24' }, 'twilight': { name: 'Twilight', light: '235, 230, 255', dark: '30, 25, 45' }, 'graphite': { name: 'Graphite', light: '240,240,245', dark: '35,35,40' }, 'emerald': { name: 'Emerald', light: '240,255,245', dark: '20,40,30' }, 'blue': { name: 'Blue', light: '235,245,255', dark: '20,30,45' }, }}};

    // --- UTILITY ---
    const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
    const formatDate = (dateStr) => { const d = new Date(dateStr + 'T00:00:00'); return { month: d.toLocaleString('default', { month: 'short' }).toUpperCase(), day: d.getDate() }; };
    const getCountdown = (dateStr) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const dueDate = new Date(dateStr + 'T00:00:00');
        const diffTime = dueDate.getTime() - today.getTime();
        const diffDays = Math.round(diffTime / 864e5);

        if (diffDays > 1) return `${diffDays} days left`;
        if (diffDays === 1) return 'Due tomorrow';
        if (diffDays === 0) return 'Due today';
        return `${Math.abs(diffDays)} days overdue`;
    };
    const resizeCanvas = (cv) => { const dpr = window.devicePixelRatio || 1; cv.width = window.innerWidth * dpr; cv.height = window.innerHeight * dpr; cv.getContext('2d').setTransform(dpr, 0, 0, dpr, 0, 0); };
    const getUserShare = bill => (enableSplitBillMode.checked && bill.isSplit && bill.splitWithAmount) ? bill.amount - bill.splitWithAmount : bill.amount;

    // --- DATA & STATE ---
    function saveData() {
        try {
            localStorage.setItem('summitForecast.bills', JSON.stringify(bills));
            const settings = { darkMode: document.documentElement.classList.contains('dark'), splitBillMode: enableSplitBillMode.checked, dontAutoDeduct: dontAutoDeduct.checked, finances: { balance: currentBalance.value, paycheck: paycheckAmount.value, payday: nextPayday.value, frequency: payFrequency.value }, clock: { enabled: enableClock.checked, position: clockPosition.value, detail: clockDetail.value }, naturalSlide: { enabled: enableNaturalSlide.checked, speed: slideSpeed.value }, uiStyle: uiStyleSelect.value, glassOpacity: glassOpacity.value, glassBlur: glassBlurSlider.value, customBg: enableCustomBackground.checked, bgType: backgroundType.value, bgColor2: wallpaperColor2.value, bgColor3: wallpaperColor3.value, bgGradientAngle: gradientAngle.value, bgGradientSpin: gradientSpinToggle.checked, bgGradientSpinSpeed: gradientSpinSpeed.value, ambiance: enableAmbiance.checked, ambianceEffect: ambianceSelect.value, snowDensity: snowDensity.value, snowSize: snowSize.value, snowSpeed: snowSpeed.value, orbsDensity: orbsDensity.value, orbsSize: orbsSize.value, orbsSpeed: orbsSpeed.value, orbsColor: orbsColor.value, starfieldDensity: starfieldDensity.value, starfieldSpeed: starfieldSpeed.value };
            localStorage.setItem('summitForecast.settings', JSON.stringify(settings));
        } catch (error) { console.error("Failed to save data:", error); }
    }
    function loadData() {
        try {
            // Migration to 'summitForecast'
            if (localStorage.getItem('quarterMonkey.bills')) {
                localStorage.setItem('summitForecast.bills', localStorage.getItem('quarterMonkey.bills'));
                if (localStorage.getItem('quarterMonkey.settings')) { localStorage.setItem('summitForecast.settings', localStorage.getItem('quarterMonkey.settings')); }
                if (localStorage.getItem('quarterMonkey.wallpaper')) { localStorage.setItem('summitForecast.wallpaper', localStorage.getItem('quarterMonkey.wallpaper')); }
                localStorage.removeItem('quarterMonkey.bills');
                localStorage.removeItem('quarterMonkey.settings');
                localStorage.removeItem('quarterMonkey.wallpaper');
            } else if (localStorage.getItem('coinMaster.bills')) {
                localStorage.setItem('summitForecast.bills', localStorage.getItem('coinMaster.bills'));
                if (localStorage.getItem('coinMaster.settings')) { localStorage.setItem('summitForecast.settings', localStorage.getItem('coinMaster.settings')); }
                if (localStorage.getItem('coinMaster.wallpaper')) { localStorage.setItem('summitForecast.wallpaper', localStorage.getItem('coinMaster.wallpaper')); }
                localStorage.removeItem('coinMaster.bills');
                localStorage.removeItem('coinMaster.settings');
                localStorage.removeItem('coinMaster.wallpaper');
            }

            bills = JSON.parse(localStorage.getItem('summitForecast.bills') || '[]');
            // --- MIGRATION FOR STATUS ---
            bills.forEach(bill => {
                if (typeof bill.paid === 'boolean' && !bill.status) {
                    bill.status = bill.paid ? 'paid' : 'unpaid';
                    delete bill.paid; // remove old property
                } else if (!bill.status) {
                    bill.status = 'unpaid';
                }
            });
            const settingsData = localStorage.getItem('summitForecast.settings');
            const settings = settingsData ? JSON.parse(settingsData) : {};
            if (settings.darkMode) { document.documentElement.classList.add('dark'); darkToggle.innerHTML = '☀️'; } else { darkToggle.innerHTML = '🌙';}
            enableSplitBillMode.checked = settings.splitBillMode || false;
            dontAutoDeduct.checked = settings.dontAutoDeduct || false;
            userFinances = settings.finances || {};
            currentBalance.value = userFinances.balance || ''; paycheckAmount.value = userFinances.paycheck || ''; nextPayday.value = userFinances.payday || ''; payFrequency.value = userFinances.frequency || 'Bi-Weekly';
            const clockSettings = settings.clock || {};
            enableClock.checked = clockSettings.enabled || false; clockPosition.value = clockSettings.position || 'pos-top-right'; clockDetail.value = clockSettings.detail || 'dateTime';
            const slideSettings = settings.naturalSlide || {};
            enableNaturalSlide.checked = slideSettings.enabled === false ? false : true; slideSpeed.value = slideSettings.speed || 800;
            populateStyleSelector();
            uiStyleSelect.value = settings.uiStyle || 'twilight';
            glassOpacity.value = settings.glassOpacity || 80; glassBlurSlider.value = settings.glassBlur || 8;
            enableCustomBackground.checked = settings.customBg || false; backgroundType.value = settings.bgType || 'theme';
            wallpaperColor2.value = settings.bgColor2 || '#1e1b4b'; wallpaperColor3.value = settings.bgColor3 || '#4c1d95';
            gradientAngle.value = settings.bgGradientAngle || 145; gradientSpinToggle.checked = settings.bgGradientSpin || false; gradientSpinSpeed.value = settings.bgGradientSpinSpeed || '10';
            enableAmbiance.checked = settings.ambiance || false; ambianceSelect.value = settings.ambianceEffect || 'none';
            
            // Ambiance settings
            const ambiance = settings.ambianceSettings || {};
            snowDensity.value = ambiance.snowDensity || 100;
            snowSize.value = ambiance.snowSize || 20;
            snowSpeed.value = ambiance.snowSpeed || 30;
            orbsDensity.value = ambiance.orbsDensity || 40;
            orbsSize.value = ambiance.orbsSize || 70;
            orbsSpeed.value = ambiance.orbsSpeed || 20;
            orbsColor.value = ambiance.orbsColor || '#9aa4b2';
            starfieldDensity.value = settings.starfieldDensity || 500;
            starfieldSpeed.value = settings.starfieldSpeed || 25;

        } catch (error) { console.error("Failed to load data:", error); }
        $('billDate').value = new Date().toISOString().split('T')[0];
        applyAllAppearance(); syncExperimentalFeatures(); renderApp(true);
    }

    // --- RENDERING ---
    function renderApp(isInitialLoad = false) {
        if (currentView === 'list') { billTrackerCard.style.display = 'flex'; pastBillsCard.style.display = 'block'; calendarView.style.display = 'none'; calendarToggleBtn.classList.remove('active'); renderLists(isInitialLoad); } 
        else { billTrackerCard.style.display = 'none'; pastBillsCard.style.display = 'none'; calendarView.style.display = 'block'; calendarToggleBtn.classList.add('active'); renderCalendar(); }
        updateSummary(); renderPendingBills(); renderNext30Days();
    }
    function renderLists(isInitialLoad = false) {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        thirtyDaysAgo.setHours(0, 0, 0, 0);

        const activeBills = bills.filter(b => b.status !== 'paid').sort((a, b) => new Date(a.date) - new Date(b.date));
        const pastBills = bills.filter(b => {
            const billDate = new Date(b.date + 'T00:00:00');
            return b.status === 'paid' && billDate >= thirtyDaysAgo;
        }).sort((a, b) => new Date(b.date) - new Date(a.date));
        
        billListBody.innerHTML = ''; noBillsMessage.style.display = activeBills.length === 0 ? 'block' : 'none';
        pastBillsListBody.innerHTML = ''; noPastBillsMessage.style.display = pastBills.length === 0 ? 'block' : 'none';

        activeBills.forEach(bill => billListBody.appendChild(createBillRow(bill, isInitialLoad)));
        pastBills.forEach(bill => pastBillsListBody.appendChild(createBillRow(bill, isInitialLoad)));
        
        const applyScrollable = (tbody, threshold) => {
            const wrapper = tbody.closest('.bill-table-wrapper');
            if (!wrapper) return;
            wrapper.classList.toggle('scrollable', tbody.children.length > threshold);
        };
        applyScrollable(billListBody, 3);
        applyScrollable(pastBillsListBody, 3);
    }
    function renderArchive() {
        archiveBillsListBody.innerHTML = '';
        const allPastBills = bills.filter(b => b.status === 'paid').sort((a, b) => new Date(b.date) - new Date(a.date));

        noArchivedBillsMessage.style.display = allPastBills.length === 0 ? 'block' : 'none';

        allPastBills.forEach(bill => {
            const row = createBillRow(bill, true);
            archiveBillsListBody.appendChild(row);
        });
        
        const wrapper = archiveBillsListBody.closest('.bill-table-wrapper');
        if (wrapper) {
            wrapper.classList.toggle('scrollable', allPastBills.length > 8);
        }
    }
    function createBillRow(bill, isInitialLoad = false) {
        const tr = document.createElement('tr');
        tr.dataset.id = bill.id;
        if (bill.status === 'paid') tr.classList.add('paid');
        else if (bill.status === 'pending') tr.classList.add('pending');
        else tr.classList.add('unpaid');

        const { month, day } = formatDate(bill.date);
        let nameHtml = `<span class="bill-name">${bill.name}</span>`;
        if(bill.isSplit && enableSplitBillMode.checked) { nameHtml += `<span class="split-info-icon" title="Split with ${bill.splitWithName}">⚁</span>`; }
        
        let countdownHtml;
        if (bill.status === 'paid') {
            countdownHtml = `<span class="countdown paid">Paid</span>`;
        } else if (bill.status === 'pending') {
            countdownHtml = `<span class="countdown pending">Pending</span>`;
        } else {
            const countdownText = getCountdown(bill.date);
            const isOverdueClass = countdownText.includes('overdue') ? 'overdue' : '';
            countdownHtml = `<span class="countdown ${isOverdueClass}">${countdownText}</span>`;
        }

        tr.innerHTML = `
            <td><div class="due-date-cell"><div class="date-box"><span class="month">${month}</span><span class="day">${day}</span></div><div class="date-info">${countdownHtml}</div></div></td>
            <td class="bill-details-cell">${nameHtml}<div class="bill-sub-details"><span class="bill-category-badge">${bill.category}</span><span class="bill-frequency-badge">${bill.frequency}</span></div></td>
            <td><div class="bill-notes">${bill.notes || '-'}</div></td>
            <td class="bill-amount-cell"><span class="bill-amount">${formatCurrency(getUserShare(bill))}</span>${(bill.isSplit && enableSplitBillMode.checked) ? `<span class="split-info-total">Total: ${formatCurrency(bill.amount)}</span>` : ''}</td>
            <td class="actions-cell">
                <button class="pay-btn">Paid ✔</button>
                <button class="pending-btn">Pending</button>
                <button class="unpay-btn">Unpaid ↩</button>
                <button class="remove-btn">✖</button>
            </td>`;
        
        if (!isInitialLoad && bill.justAdded) {
            animateEnter(tr);
            delete bill.justAdded;
        }
        return tr;
    }
    function getPaydaysForMonth(year, month) {
        if (!nextPayday.value) return [];
        const paydays = [];
        let currentPayday = new Date(nextPayday.value + 'T00:00:00');
        const frequency = payFrequency.value || 'Bi-Weekly';

        // Find the first payday in or before the current month
        while (currentPayday.getFullYear() > year || (currentPayday.getFullYear() === year && currentPayday.getMonth() > month)) {
            if (frequency === 'Weekly') currentPayday.setDate(currentPayday.getDate() - 7);
            else if (frequency === 'Bi-Weekly') currentPayday.setDate(currentPayday.getDate() - 14);
            else if (frequency === 'Monthly') currentPayday.setMonth(currentPayday.getMonth() - 1);
            else break;
        }
        
        // Iterate through the month and add paydays
        while (currentPayday.getFullYear() < year || (currentPayday.getFullYear() === year && currentPayday.getMonth() <= month)) {
            if (currentPayday.getFullYear() === year && currentPayday.getMonth() === month) {
                paydays.push(currentPayday.getDate());
            }
            if (frequency === 'Weekly') currentPayday.setDate(currentPayday.getDate() + 7);
            else if (frequency === 'Bi-Weekly') currentPayday.setDate(currentPayday.getDate() + 14);
            else if (frequency === 'Monthly') currentPayday.setMonth(currentPayday.getMonth() + 1);
            else break;
        }
        return paydays;
    }

    function getPaydaysInRange(startDate, endDate) {
        if (!nextPayday.value) return [];
        const paydays = [];
        let currentPayday = new Date(nextPayday.value + 'T00:00:00');
        const frequency = payFrequency.value || 'Bi-Weekly';
        
        // Go backward until currentPayday is before the startDate to catch all possible paydays in range
        while (currentPayday > startDate) {
            if (frequency === 'Weekly') currentPayday.setDate(currentPayday.getDate() - 7);
            else if (frequency === 'Bi-Weekly') currentPayday.setDate(currentPayday.getDate() - 14);
            else if (frequency === 'Monthly') {
                // More careful month subtraction
                let d = currentPayday.getDate();
                currentPayday.setMonth(currentPayday.getMonth() - 1);
                // If date changed (e.g. from Mar 31 to Feb 28), reset to last day of month
                if (currentPayday.getDate() !== d) currentPayday.setDate(0);
            }
            else break;
        }

        // Go forward and collect paydays in range
        while (currentPayday <= endDate) {
            if (currentPayday >= startDate) {
                paydays.push(new Date(currentPayday));
            }
            if (frequency === 'Weekly') currentPayday.setDate(currentPayday.getDate() + 7);
            else if (frequency === 'Bi-Weekly') currentPayday.setDate(currentPayday.getDate() + 14);
            else if (frequency === 'Monthly') {
                let d = currentPayday.getDate();
                currentPayday.setMonth(currentPayday.getMonth() + 1);
                if (currentPayday.getDate() !== d) currentPayday.setDate(0);
            }
            else break;
        }
        return paydays;
    }

    function getBillsForDate(targetDate) {
        const targetYear = targetDate.getFullYear();
        const targetMonth = targetDate.getMonth();
        const targetDay = targetDate.getDate();

        return bills.filter(bill => {
            const billDate = new Date(bill.date + 'T00:00:00');
            const billYear = billDate.getFullYear();
            const billMonth = billDate.getMonth();
            const billDay = billDate.getDate();

            if (billDate > targetDate) {
                return false; // Bill starts in the future
            }

            switch (bill.frequency) {
                case 'One-Time':
                    return targetYear === billYear && targetMonth === billMonth && targetDay === billDay;
                case 'Monthly':
                    return billDay === targetDay;
                case 'Quarterly':
                    {
                        if (billDay !== targetDay) return false;
                        const monthDiff = (targetYear - billYear) * 12 + (targetMonth - billMonth);
                        return monthDiff >= 0 && monthDiff % 3 === 0;
                    }
                case 'Annually':
                    return billMonth === targetMonth && billDay === targetDay;
                default:
                    return false;
            }
        });
    }

    function renderCalendar() {
        calendarView.innerHTML = '';
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        const monthName = calendarDate.toLocaleString('default', { month: 'long' });

        const header = document.createElement('div');
        header.className = 'calendar-header';
        header.innerHTML = `
            <button id="prevMonthBtn" title="Previous Month" class="ctrl-btn">‹</button>
            <h2>${monthName} ${year}</h2>
            <span style="display: flex; gap: 8px;">
                <button id="printCalendarBtn" title="Print Calendar" class="ctrl-btn">🖨️</button>
                <button id="nextMonthBtn" title="Next Month" class="ctrl-btn">›</button>
            </span>
        `;
        calendarView.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'calendar-grid-container';
        const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        grid.innerHTML += weekdays.map(day => `<div class="calendar-day-name">${day}</div>`).join('');

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const paydays = getPaydaysForMonth(year, month);
        const today = new Date();

        for (let i = 0; i < firstDayOfMonth; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-day other-month';
            grid.appendChild(emptyCell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                dayCell.classList.add('today');
            }

            const currentDate = new Date(year, month, day);
            const billsOnDay = getBillsForDate(currentDate);

            let dayHeaderHTML = `<div class="day-number">${day}</div>`;
            let dayExtrasHTML = '';
            
            const dailyTotal = billsOnDay.reduce((sum, bill) => sum + (bill.status === 'paid' ? 0 : getUserShare(bill)), 0);
            if (dailyTotal > 0) {
                dayExtrasHTML += `<div class="day-balance negative">${formatCurrency(dailyTotal)}</div>`;
            }
            if (paydays.includes(day)) {
                dayExtrasHTML += `<div class="day-balance">Payday 💰</div>`;
            }

            let billsHTML = '';
            if (billsOnDay.length > 0) {
                billsHTML = billsOnDay.map(bill => {
                    let classes = 'bill-item-calendar';
                    if (bill.status === 'paid') classes += ' paid';
                    else if (bill.status === 'pending') classes += ' pending';
                    if (bill.category === 'Expense') classes += ' expense';
                    return `<div class="${classes}" title="${bill.name} - ${formatCurrency(getUserShare(bill))}">${bill.name}</div>`;
                }).join('');
            }
            
            dayCell.innerHTML = `<div class="day-header">${dayHeaderHTML}<div>${dayExtrasHTML}</div></div><div class="bills-on-day">${billsHTML}</div>`;
            grid.appendChild(dayCell);
        }
        calendarView.appendChild(grid);
    }
    function renderPendingBills() {
        pendingBillsList.innerHTML = '';
        const pending = bills.filter(b => b.status === 'pending')
                               .sort((a, b) => new Date(a.date) - new Date(b.date));

        if (pending.length === 0) {
            pendingBillsList.innerHTML = '<p style="font-size:12px; color: var(--muted); text-align:center; margin-top:10px;">No pending bills.</p>';
            return;
        }

        pending.forEach(bill => {
            const item = document.createElement('div');
            item.className = 'upcoming-item'; // Keep class for styling consistency
            item.innerHTML = `
                <div class="name">${bill.name}</div>
                <div class="details">
                    <div class="amount">${formatCurrency(getUserShare(bill))}</div>
                    <div class="countdown">${getCountdown(bill.date)}</div>
                </div>
            `;
            pendingBillsList.appendChild(item);
        });
    }
    function renderNext30Days() {
        next30DaysList.innerHTML = '';
        const today = new Date();
        today.setHours(0,0,0,0);
        const thirtyDaysFromNow = new Date();
        thirtyDaysFromNow.setDate(today.getDate() + 30);

        const next30 = bills.filter(b => {
            const billDate = new Date(b.date + 'T00:00:00');
            return b.status !== 'paid' && billDate >= today && billDate <= thirtyDaysFromNow;
        }).sort((a, b) => new Date(a.date) - new Date(b.date));

        if (next30.length === 0) {
            next30DaysList.innerHTML = '<p style="font-size:12px; color: var(--muted); text-align:center; margin-top:10px;">No bills due in the next 30 days.</p>';
            return;
        }
        
        next30.forEach(bill => {
            const item = document.createElement('div');
            item.className = 'upcoming-item';
            item.innerHTML = `
                <div class="name">${bill.name}</div>
                <div class="details">
                    <div class="amount">${formatCurrency(getUserShare(bill))}</div>
                    <div class="countdown">${getCountdown(bill.date)}</div>
                </div>
            `;
            next30DaysList.appendChild(item);
        });
    }
    function updateSummary() {
        const balance = parseFloat(currentBalance.value) || 0;
        const pendingTotal = bills.filter(b => b.status === 'pending').reduce((sum, bill) => sum + getUserShare(bill), 0);
        const balanceAfterPending = balance - pendingTotal;

        // Fix for duplicate projected balance display
        const projectedEl = totalAmountEl.parentNode.querySelector('.projected-balance');
        if (projectedEl) {
            projectedEl.remove();
        }

        totalAmountEl.textContent = formatCurrency(balanceAfterPending);
        if (pendingTotal > 0) {
            const originalBalanceEl = document.createElement('div');
            originalBalanceEl.className = 'projected-balance';
            originalBalanceEl.textContent = `Current: ${formatCurrency(balance)}`;
            totalAmountEl.parentNode.appendChild(originalBalanceEl);
        }


        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tenDaysFromNow = new Date();
        tenDaysFromNow.setDate(today.getDate() + 10);

        const dueInNext10Days = bills.filter(b => {
            const billDate = new Date(b.date + 'T00:00:00');
            return b.status === 'unpaid' && billDate >= today && billDate <= tenDaysFromNow;
        });

        const totalDue = dueInNext10Days.reduce((sum, bill) => sum + bill.amount, 0);
        const yourShare = dueInNext10Days.reduce((sum, bill) => sum + getUserShare(bill), 0);

        totalDueNext10DaysEl.textContent = formatCurrency(totalDue);
        yourShareNext10DaysEl.textContent = formatCurrency(yourShare);
        
        // New logic for projected balance
        const paycheck = parseFloat(paycheckAmount.value) || 0;
        const projectedTotalEl = $('projectedBalanceTotal');
        const projectedShareEl = $('projectedBalanceShare');

        if (projectedTotalEl && projectedShareEl) {
            if (paycheck > 0 && nextPayday.value) {
                const paydaysInRange = getPaydaysInRange(today, tenDaysFromNow);
                const upcomingIncome = paydaysInRange.length * paycheck;

                // Projected balance should be based on the balance *after* pending bills are considered
                const projectedBalanceTotal = balanceAfterPending - totalDue + upcomingIncome;
                const projectedBalanceShare = balanceAfterPending - yourShare + upcomingIncome;
                
                projectedTotalEl.textContent = `Balance after 10 days: ${formatCurrency(projectedBalanceTotal)}`;
                projectedShareEl.textContent = `Balance after 10 days: ${formatCurrency(projectedBalanceShare)}`;
            } else {
                projectedTotalEl.textContent = '';
                projectedShareEl.textContent = '';
            }
        }
    }
    
    // --- FEATURES & CLOCK ---
    function syncExperimentalFeatures() {
        const isEnabled = enableSplitBillMode.checked;
        splitBillInputs.style.display = isEnabled ? 'grid' : 'none';
        // $('amountColumnHeader').textContent = isEnabled ? 'Amount (Your Share)' : 'Amount'; // This element was removed
        $('yourShareCard').style.display = isEnabled ? 'flex' : 'none';
        renderApp(true);
    }
    function startClock() { if (!clockInterval) { clockInterval = setInterval(updateClock, 1000); updateClock(); } }
    function stopClock() { if (clockInterval) { clearInterval(clockInterval); clockInterval = null; } }
    function updateClock() {
        const now = new Date();
        const detail = clockDetail.value;
        let timeString;
        if (detail === 'time') timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        else if (detail === 'timeSec') timeString = now.toLocaleTimeString();
        else timeString = now.toLocaleString([], { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        clockDisplay.textContent = timeString;
        checkPayday(now);
    }
    function applyClockSettings() {
        if (enableClock.checked) {
            clockOptionsWrapper.style.display = 'block';
            clockDisplay.style.display = 'block';
            clockDisplay.className = `clock-display glass ${clockPosition.value}`;
            startClock();
        } else {
            clockOptionsWrapper.style.display = 'none';
            clockDisplay.style.display = 'none';
            stopClock();
        }
    }
    function checkPayday(now) {
        if (now.getSeconds() === 0 && now.getMinutes() === 0 && now.getHours() === 8) { // Check at 8am
            const paydayDate = new Date(userFinances.payday + 'T00:00:00');
            if (paydayDate.getDate() === now.getDate() && paydayDate.getMonth() === now.getMonth()) {
                const newBalance = (parseFloat(currentBalance.value) || 0) + (parseFloat(paycheckAmount.value) || 0);
                currentBalance.value = newBalance.toFixed(2);
                saveData();
                updateSummary();
                alert(`Payday! 💰 Your balance has been updated to ${formatCurrency(newBalance)}.`);
            }
        }
    }

    // --- MODAL & EDITING ---
    function openEditModal(billId) {
        const bill = bills.find(b => b.id === billId);
        if (!bill) return;
        editModal.dataset.editingId = billId;
        $('editBillName').value = bill.name;
        $('editBillAmount').value = bill.amount;
        $('editBillDate').value = bill.date;
        $('editBillCategory').innerHTML = $('billCategory').innerHTML;
        $('editBillCategory').value = bill.category;
        $('editBillFrequency').innerHTML = $('billFrequency').innerHTML;
        $('editBillFrequency').value = bill.frequency;
        $('editBillNotes').value = bill.notes || '';
        if (enableSplitBillMode.checked) {
            editSplitBillInputs.style.display = 'block';
            $('editBillSplitName').value = bill.splitWithName || '';
            $('editBillSplitAmount').value = bill.splitWithAmount || '';
        } else {
            editSplitBillInputs.style.display = 'none';
        }
        editModal.classList.add('visible');
    }
    function closeEditModal() { editModal.classList.remove('visible'); }
    function handleSaveEdit() {
        const billId = Number(editModal.dataset.editingId);
        const bill = bills.find(b => b.id === billId);
        if (!bill) return;
        bill.name = $('editBillName').value.trim();
        bill.amount = parseFloat($('editBillAmount').value) || 0;
        bill.date = $('editBillDate').value;
        bill.category = $('editBillCategory').value;
        bill.frequency = $('editBillFrequency').value;
        bill.notes = $('editBillNotes').value.trim();
        if (enableSplitBillMode.checked) {
            const splitName = $('editBillSplitName').value.trim();
            const splitAmount = parseFloat($('editBillSplitAmount').value) || 0;
            if (splitName && splitAmount > 0) {
                bill.isSplit = true;
                bill.splitWithName = splitName;
                bill.splitWithAmount = splitAmount;
            } else {
                bill.isSplit = false;
                bill.splitWithName = '';
                bill.splitWithAmount = 0;
            }
        }
        saveData();
        renderApp(true);
        closeEditModal();
    }
    
    function showDayBreakdown(date) {
        const dayBreakdownModal = $('dayBreakdownModal');
        const dayBreakdownTitle = $('dayBreakdownTitle');
        const dayBreakdownContent = $('dayBreakdownContent');

        dayBreakdownTitle.textContent = `Breakdown for ${date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
        
        const billsOnDay = getBillsForDate(date);
        const paydaysOnDay = getPaydaysForMonth(date.getFullYear(), date.getMonth()).includes(date.getDate());

        let contentHTML = '<h3>Bills Due</h3>';
        if (billsOnDay.length > 0) {
            contentHTML += '<ul>';
            billsOnDay.forEach(bill => {
                contentHTML += `<li>${bill.name} - ${formatCurrency(getUserShare(bill))}</li>`;
            });
            contentHTML += '</ul>';
        } else {
            contentHTML += '<p>No bills due on this day.</p>';
        }

        contentHTML += '<h3>Income</h3>';
        if (paydaysOnDay && paycheckAmount.value > 0) {
            contentHTML += '<ul>';
            contentHTML += `<li>Paycheck - ${formatCurrency(parseFloat(paycheckAmount.value))}</li>`;
            contentHTML += '</ul>';
        } else {
            contentHTML += '<p>No income on this day.</p>';
        }

        dayBreakdownContent.innerHTML = contentHTML;
        dayBreakdownModal.classList.add('visible');
    }

    function closeDayBreakdownModal() {
        $('dayBreakdownModal').classList.remove('visible');
    }

    // --- APPEARANCE & ANIMATIONS ---
    function applyAllAppearance() {
        applyMaterialStyle();
        applyGlassEffect();
        applySlideSpeed();
        updateWallpaper();
        applyAmbianceSettings();
        applyClockSettings();
    }
    function populateStyleSelector() {
        uiStyleSelect.innerHTML = '';
        for (const key in materialPresets.glass.styles) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = materialPresets.glass.styles[key].name;
            uiStyleSelect.appendChild(option);
        }
    }
    function applyMaterialStyle() {
        const isDark = document.documentElement.classList.contains('dark');
        const selectedStyle = uiStyleSelect.value || 'twilight';
        if(materialPresets.glass.styles[selectedStyle]){
            const tint = materialPresets.glass.styles[selectedStyle][isDark ? 'dark' : 'light'];
            document.documentElement.style.setProperty('--glass-tint', tint);
        }
    }
    function applyGlassEffect() {
        const opacity = glassOpacity.value / 100;
        const blur = glassBlurSlider.value;
        document.documentElement.style.setProperty('--glass-alpha', opacity);
        document.documentElement.style.setProperty('--glass-backdrop-blur', `${blur}px`);
        $('glassOpacityPct').textContent = `${glassOpacity.value}%`;
        $('glassBlurPct').textContent = `${blur}px`;
    }
    function updateWallpaper() {
        customBackgroundOptions.style.display = enableCustomBackground.checked ? 'block' : 'none';
        if (!enableCustomBackground.checked) { document.body.style.backgroundImage = ''; return; }
        
        const type = backgroundType.value;
        $('imageWallpaperControls').style.display = type === 'image' ? 'block' : 'none';
        $('colorWallpaperControls').style.display = type === 'color' ? 'block' : 'none';
        gradientSpinControls.style.display = gradientSpinToggle.checked ? 'flex' : 'none';

        if (type === 'image') {
            const wallpaper = localStorage.getItem('summitForecast.wallpaper');
            document.body.style.backgroundImage = wallpaper ? `url(${wallpaper})` : '';
        } else if (type === 'color') {
            document.body.style.backgroundImage = `linear-gradient(${gradientAngle.value}deg, ${wallpaperColor3.value}, ${wallpaperColor2.value})`;
        } else {
            document.body.style.backgroundImage = '';
        }
    }
    const applySlideSpeed = () => {
        document.documentElement.style.setProperty('--slide-duration', `${slideSpeed.value}ms`);
        $('slideSpeedPct').textContent = `${slideSpeed.value}ms`;
    };
    function animateEnter(tr){ if(!enableNaturalSlide.checked) return; tr.classList.add('slide-enter'); requestAnimationFrame(() => { tr.classList.add('slide-enter-active'); setTimeout(() => tr.classList.remove('slide-enter','slide-enter-active'), slideSpeed.value); }); }
    function animateRemove(tr, callback){ if(!enableNaturalSlide.checked){ tr.remove(); callback(); return; } tr.style.height = `${tr.offsetHeight}px`; tr.classList.add('slide-out'); requestAnimationFrame(() => { tr.classList.add('collapsing'); }); setTimeout(() => { if(tr.parentNode) { tr.remove(); } callback(); }, slideSpeed.value); }
    
    function applyAmbianceSettings() {
        ambianceSettings.style.display = enableAmbiance.checked ? 'block' : 'none';
        ambianceControls.style.display = enableAmbiance.checked && ambianceSelect.value !== 'none' ? 'block' : 'none';
        ['snowControls', 'orbsControls', 'starfieldControls'].forEach(c => $(c).style.display = 'none');
        
        ambianceParticles = []; // Clear existing particles
        ctxAmbiance.clearRect(0, 0, ambianceCanvas.width, ambianceCanvas.height);

        if (enableAmbiance.checked) {
            const effect = ambianceSelect.value;
            if (effect === 'none') return;
            
            $(effect + 'Controls').style.display = 'block';
            let density = 100;
            if (effect === 'snowflakes') density = snowDensity.value;
            else if (effect === 'orbs') density = orbsDensity.value;
            else if (effect === 'starfield') density = starfieldDensity.value;

            for (let i = 0; i < density; i++) {
                if (effect === 'snowflakes') ambianceParticles.push(createSnowflake(true));
                else if (effect === 'orbs') ambianceParticles.push(createOrb(true));
                else if (effect === 'starfield') ambianceParticles.push(createStar(true));
            }
        }
    }

    function createSnowflake(isInitial = false) {
        const size = (Math.random() * (snowSize.value / 10) + 1);
        return {
            x: Math.random() * ambianceCanvas.width,
            y: isInitial ? Math.random() * ambianceCanvas.height : -size,
            size: size,
            speed: (Math.random() * (snowSpeed.value / 20) + 0.5),
            opacity: Math.random() * 0.5 + 0.3,
            update: function() { this.y += this.speed; this.x += Math.sin(this.y/50)*0.5; },
            draw: function() { ctxAmbiance.fillStyle = `rgba(255, 255, 255, ${this.opacity})`; ctxAmbiance.beginPath(); ctxAmbiance.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctxAmbiance.fill(); },
            isOutOfBounds: function() { return this.y > ambianceCanvas.height + this.size; }
        };
    }

    function createOrb(isInitial = false) {
        const size = Math.random() * (orbsSize.value / 10) + 5;
        return {
            x: Math.random() * ambianceCanvas.width,
            y: isInitial ? Math.random() * ambianceCanvas.height : ambianceCanvas.height + size,
            size: size,
            speed: (Math.random() * (orbsSpeed.value / 20) + 0.1),
            color: orbsColor.value,
            update: function() { this.y -= this.speed; },
            draw: function() { ctxAmbiance.fillStyle = this.color; ctxAmbiance.globalAlpha = 0.5; ctxAmbiance.beginPath(); ctxAmbiance.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctxAmbiance.fill(); ctxAmbiance.globalAlpha = 1; },
            isOutOfBounds: function() { return this.y < -this.size; }
        };
    }
    
    function createStar(isInitial = false) {
        return {
            x: Math.random() * ambianceCanvas.width,
            y: isInitial ? Math.random() * ambianceCanvas.height: 0,
            size: Math.random() * 1.5 + 0.5,
            speed: (Math.random() * (starfieldSpeed.value / 10) + 0.1),
            update: function() { this.y += this.speed; if (this.y > ambianceCanvas.height) {this.y = 0; this.x = Math.random() * ambianceCanvas.width;} },
            draw: function() { ctxAmbiance.fillStyle = 'rgba(255, 255, 255, 0.8)'; ctxAmbiance.fillRect(this.x, this.y, this.size, this.size); },
            isOutOfBounds: function() { return false; /* handled in update */ }
        };
    }

    function mainLoop() {
        if (gradientSpinToggle.checked && enableCustomBackground.checked && backgroundType.value === 'color') {
            const currentAngle = parseFloat(gradientAngle.value);
            gradientAnimationAngle = (gradientAnimationAngle + (parseFloat(gradientSpinSpeed.value) / 200)) % 360;
            document.body.style.backgroundImage = `linear-gradient(${currentAngle + gradientAnimationAngle}deg, ${wallpaperColor3.value}, ${wallpaperColor2.value})`;
        }

        if (enableAmbiance.checked && ambianceSelect.value !== 'none') {
            ctxAmbiance.clearRect(0, 0, ambianceCanvas.width, ambianceCanvas.height);
            ambianceParticles.forEach((p, index) => {
                p.update();
                p.draw();
                if (p.isOutOfBounds()) ambianceParticles.splice(index, 1);
            });
            
            const effect = ambianceSelect.value;
            let targetDensity = 0;
            if (effect === 'snowflakes') targetDensity = snowDensity.value;
            else if (effect === 'orbs') targetDensity = orbsDensity.value;
            else if (effect === 'starfield') targetDensity = starfieldDensity.value;

            if (ambianceParticles.length < targetDensity) {
                 if (effect === 'snowflakes') ambianceParticles.push(createSnowflake());
                 else if (effect === 'orbs') ambianceParticles.push(createOrb());
                 // Stars replenish themselves
            }
        } else if (ambianceParticles.length > 0) {
            ambianceParticles = [];
            ctxAmbiance.clearRect(0, 0, ambianceCanvas.width, ambianceCanvas.height);
        }
        
        requestAnimationFrame(mainLoop);
    }

    // --- EVENT HANDLERS ---
    const handleAddBill = () => {
        const name = $('billName').value.trim(); if (!name) { alert('Please enter at least a bill name.'); return; }
        const amount = parseFloat($('billAmount').value) || 0; const date = $('billDate').value || new Date().toISOString().split('T')[0];
        const newBill = { id: Date.now(), name, amount, date, category: $('billCategory').value, frequency: $('billFrequency').value, notes: $('billNotes').value.trim(), status: 'unpaid', isSplit: false, justAdded: true };
        if (enableSplitBillMode.checked && $('billSplitName').value.trim() && parseFloat($('billSplitAmount').value) > 0) {
            newBill.isSplit = true; newBill.splitWithName = $('billSplitName').value.trim(); newBill.splitWithAmount = parseFloat($('billSplitAmount').value);
            if (newBill.splitWithAmount >= amount && amount > 0) { alert("The other person's share cannot be >= the total amount."); return; }
        }
        bills.push(newBill); addBillForm.reset(); $('billDate').value = new Date().toISOString().split('T')[0];
        saveData(); renderApp();
    };
    
    const handleAddExpense = (desc, amount) => {
        if (desc && amount > 0) {
            const newExpenseAsBill = {
                id: Date.now(), name: desc, amount: amount,
                date: new Date().toISOString().split('T')[0], category: 'Expense',
                frequency: 'One-Time', notes: 'Logged as a one-time expense.',
                status: 'paid', isSplit: false, justAdded: true
            };
            bills.push(newExpenseAsBill);
            if (!dontAutoDeduct.checked) {
                const currentBalanceVal = parseFloat(currentBalance.value) || 0;
                currentBalance.value = (currentBalanceVal - amount).toFixed(2);
            }
            saveData();
            renderApp();
            expenseForm.reset();
            toggleExpenseView(false); // Go back to quick options
        }
    };

    const handleCustomExpenseSubmit = (e) => {
        e.preventDefault();
        const desc = $('expenseDescription').value.trim();
        const amount = parseFloat($('expenseAmount').value);
        handleAddExpense(desc, amount);
    };

    const handleQuickExpense = (e) => {
        const expenseType = e.target.dataset.expense;
        const amount = parseFloat(prompt(`Enter amount for ${expenseType}:`));
        if (amount) {
            handleAddExpense(expenseType, amount);
        }
    };
    
    const toggleExpenseView = (showCustom) => {
        $('expenseQuickOptions').style.display = showCustom ? 'none' : 'grid';
        $('expenseForm').style.display = showCustom ? 'flex' : 'none';
    };
    const handleListClick = (e) => {
        const tr = e.target.closest('tr'); if (!tr) return;
        const target = e.target;
        if (target.matches('.pay-btn, .unpay-btn, .pending-btn, .remove-btn')) {
            const billId = Number(tr.dataset.id);
            const bill = bills.find(b => b.id === billId);
            if (!bill) return;

            if (target.matches('.pending-btn')) {
                bill.status = 'pending';
                saveData();
                renderApp(true);
            } else if (target.matches('.pay-btn')) {
                const oldStatus = bill.status;
                bill.status = 'paid';
                if (!dontAutoDeduct.checked && oldStatus !== 'paid') {
                    const share = getUserShare(bill);
                    const currentBalanceVal = parseFloat(currentBalance.value) || 0;
                    currentBalance.value = (currentBalanceVal - share).toFixed(2);
                }
                saveData();
                renderApp(true);
            } else if (target.matches('.unpay-btn')) {
                const oldStatus = bill.status;
                bill.status = 'unpaid';
                if (!dontAutoDeduct.checked && oldStatus === 'paid') {
                    const share = getUserShare(bill);
                    const currentBalanceVal = parseFloat(currentBalance.value) || 0;
                    currentBalance.value = (currentBalanceVal + share).toFixed(2);
                }
                saveData();
                renderApp(true);
            } else if (target.matches('.remove-btn')) {
                if (confirm(`Delete bill: "${bill.name}"?`)) {
                    animateRemove(tr, () => {
                        bills = bills.filter(b => b.id !== billId);
                        saveData();
                        updateSummary();
                        renderUpcomingBills();
                        renderNext30Days();
                    });
                }
            }
        }
    };
    const handleListDoubleClick = (e) => { const tr = e.target.closest('tr[data-id]'); if (tr && !e.target.closest('.actions-cell')) openEditModal(Number(tr.dataset.id)); };
    const handleToggleDarkMode = () => { document.documentElement.classList.toggle('dark'); const isDark = document.documentElement.classList.contains('dark'); darkToggle.innerHTML = isDark ? '☀️' : '🌙'; applyMaterialStyle(); saveData(); };
    const handleWallpaperFile = (e) => { const file = e.target.files[0]; if (file && file.size < 5*1024*1024) { const reader = new FileReader(); reader.onload = (e) => { localStorage.setItem('summitForecast.wallpaper', e.target.result); updateWallpaper(); saveData(); }; reader.readAsDataURL(file); } else if (file) alert('Image too large (max 5MB).'); };
    const handleCalendarNav = (e) => {
        const dayCell = e.target.closest('.calendar-day');
        if (dayCell && !dayCell.classList.contains('other-month')) {
            const day = dayCell.querySelector('.day-number').textContent;
            const date = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), day);
            showDayBreakdown(date);
            return;
        }

        let reRender = false;
        if (e.target.closest('#prevMonthBtn')) {
            calendarDate.setMonth(calendarDate.getMonth() - 1);
            reRender = true;
        } else if (e.target.closest('#nextMonthBtn')) {
            calendarDate.setMonth(calendarDate.getMonth() + 1);
            reRender = true;
        } else if (e.target.closest('#printCalendarBtn')) {
            window.print();
        }
        if (reRender) {
            renderCalendar();
        }
    };

    function handleExportProfile() {
        try {
            const bills = localStorage.getItem('summitForecast.bills') || '[]';
            const settings = localStorage.getItem('summitForecast.settings') || '{}';
            const wallpaper = localStorage.getItem('summitForecast.wallpaper') || null;

            const profileData = {
                bills: JSON.parse(bills),
                settings: JSON.parse(settings),
                wallpaper: wallpaper
            };

            const profileContent = JSON.stringify(profileData, null, 2);
            const blob = new Blob([profileContent], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "SummitForecast_Profile.json");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error("Failed to export profile:", error);
            alert("Could not export profile. See console for details.");
        }
    }

    function handleImportProfile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json,.json';
        input.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const profileData = JSON.parse(event.target.result);
                    if (profileData && profileData.bills && profileData.settings) {
                        localStorage.setItem('summitForecast.bills', JSON.stringify(profileData.bills));
                        localStorage.setItem('summitForecast.settings', JSON.stringify(profileData.settings));
                        
                        if (profileData.wallpaper) {
                            localStorage.setItem('summitForecast.wallpaper', profileData.wallpaper);
                        } else {
                            localStorage.removeItem('summitForecast.wallpaper');
                        }

                        alert('Profile imported successfully! The application will now reload.');
                        location.reload();
                    } else {
                        alert('Invalid profile file. Please select a valid Summit Forecast profile.');
                    }
                } catch (error) {
                    console.error("Failed to import profile:", error);
                    alert('Could not import profile. The file may be corrupted or not in the correct format.');
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }
    
    // --- EVENT LISTENERS ---
    addBillBtnHeader.addEventListener('click', () => {
        addBillModal.classList.add('visible');
    });
    closeAddBillModalBtn.addEventListener('click', () => {
        addBillModal.classList.remove('visible');
    });
    archiveBtn.addEventListener('click', () => {
        appView.style.display = 'none';
        archiveView.style.display = 'block';
        renderArchive();
    });
    backFromArchiveBtn.addEventListener('click', () => {
        archiveView.style.display = 'none';
        appView.style.display = 'grid';
    });
    addBtn.addEventListener('click', handleAddBill);
    expenseForm.addEventListener('submit', handleCustomExpenseSubmit);
    billListBody.addEventListener('click', handleListClick);
    pastBillsListBody.addEventListener('click', handleListClick);
    $('customExpenseBtn').addEventListener('click', () => toggleExpenseView(true));
    $('cancelCustomExpenseBtn').addEventListener('click', () => toggleExpenseView(false));
    document.querySelectorAll('.quick-expense-btn').forEach(btn => btn.addEventListener('click', handleQuickExpense));
    billListBody.addEventListener('dblclick', handleListDoubleClick);
    pastBillsListBody.addEventListener('dblclick', handleListDoubleClick);
    saveEditBtn.addEventListener('click', handleSaveEdit);
    closeModalBtn.addEventListener('click', closeEditModal);
    $('closeDayBreakdownModalBtn').addEventListener('click', closeDayBreakdownModal);
    darkToggle.addEventListener('click', handleToggleDarkMode);
    menuBtn.addEventListener('click', () => menuPanel.style.display = 'block');
    closeMenuNotch.addEventListener('click', () => menuPanel.style.display = 'none');
    calendarToggleBtn.addEventListener('click', () => { currentView = currentView === 'list' ? 'calendar' : 'list'; renderApp(true); });
    calendarView.addEventListener('click', handleCalendarNav);
    [currentBalance, paycheckAmount, nextPayday, payFrequency].forEach(el => el.addEventListener('change', () => { saveData(); renderApp(true); }));
    document.querySelectorAll('.menu-panel input, .menu-panel select').forEach(el => { const event = el.type === 'range' || el.type === 'color' ? 'input' : 'change'; el.addEventListener(event, () => { if(el.id === 'enableSplitBillMode') syncExperimentalFeatures(); else applyAllAppearance(); saveData(); }); });
    wallpaperFile.addEventListener('change', handleWallpaperFile);
    $('exportProfileBtn').addEventListener('click', handleExportProfile);
    $('importProfileBtn').addEventListener('click', handleImportProfile);
    window.addEventListener('resize', () => { resizeCanvas(ambianceCanvas); applyAmbianceSettings(); });
    
    // --- INITIALIZATION ---
    resizeCanvas(ambianceCanvas); loadData(); requestAnimationFrame(mainLoop);
})();
</script>
</body>
</html>
