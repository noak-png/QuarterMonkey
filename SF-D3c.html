<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Summit Forecast - Financial Forecaster</title>

<style>
/* ========== Base Theme Variables ========== */
:root {
  --bg: #f0f2f5; --card: #ffffff; --text: #1a1a1a; --muted: #6b7280;
  --accent: #059669; --ok: #16a34a; --danger: #ef4444; --pending: #e0f2fe; --pending-text: #075985; --pending-border: #bae6fd;
  --paid: #d1fae5; --paid-text: #065f46; --border: #dcdfe3;
  --shadow: 0 6px 16px rgba(0,0,0,.08);
  --font-family: system-ui, sans-serif; --font-size: 15px; /* Reduced base font size */
  --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --glass-tint: 255,255,255; --glass-alpha: 0.8; --glass-stroke: rgba(0,0,0,.08);
  --glass-shadow: 0 8px 28px rgba(0,0,0,.12); --glass-backdrop-sat: 150%;
  --glass-backdrop-blur: 8px; --slide-duration: 800ms; --slide-ease: cubic-bezier(.22,.61,.36,1);
  --border-radius: 16px; /* NEW: Controllable corner radius */
  --glass-shadow-blur: 28px; --glass-shadow-alpha: 0.12; /* NEW: Controllable shadow parts */
  --glass-shadow: 0 8px var(--glass-shadow-blur) rgba(0,0,0,var(--glass-shadow-alpha));
}
.dark {
  --bg:#0b0d10; --card:#0f1418; --text:#e6eef6; --muted:#9aa4b2;
  --accent:#10b981; --ok:#22c55e; --danger:#f87171; --pending: #1e293b; --pending-text: #7dd3fc; --pending-border: #384252;
  --paid: #064e3b; --paid-text: #a7f3d0; --border:#1b2430;
  --shadow: 0 14px 36px rgba(0,0,0,.45); --glass-tint: 15,20,24;
  --glass-alpha: 0.65; --glass-stroke: rgba(255,255,255,.08);
  --glass-shadow-blur: 56px; --glass-shadow-alpha: 0.55; /* NEW: Dark mode shadow parts */
  --glass-shadow: 0 18px var(--glass-shadow-blur) rgba(0,0,0,var(--glass-shadow-alpha));
}

/* ========== Global & App Layout ========== */
*{box-sizing:border-box}
html { height: 100%; }
body {
  margin:0; min-height: 100vh; font-family:var(--font-family); font-size:var(--font-size);
  color:var(--text); background:var(--bg); line-height:1.4;
  transition: background .25s ease, color .25s ease;
  background-position:center center; background-repeat:no-repeat; background-size:cover;
  background-attachment:fixed; display: grid; place-items: center; padding: 20px;
}
.glass {
    background: rgba(var(--glass-tint), var(--glass-alpha));
    backdrop-filter: saturate(var(--glass-backdrop-sat)) blur(var(--glass-backdrop-blur));
    -webkit-backdrop-filter: saturate(var(--glass-backdrop-sat)) blur(var(--glass-backdrop-blur));
    border: 1px solid var(--glass-stroke); box-shadow: var(--glass-shadow);
    transform: translateZ(0); /* BUG FIX: Prevents rendering glitches on style change */
}
.app { width:100%; max-width:980px; display:flex; flex-direction:column; gap:20px; z-index: 10; height: calc(100vh - 40px); min-height: 700px; position: relative; }
.title-wrap { width: 100%; padding:10px 16px; border-radius:var(--border-radius); display: flex; justify-content: space-between; align-items: center; }
.title-wrap h1 { margin:0; font-size:24px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
.title-wrap h1 svg { width: 26px; height: 26px; fill: var(--accent); }
.header-controls { display: flex; align-items: center; gap: 8px; }
.ctrl-btn { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 8px; width: 36px; height: 36px; border-radius: calc(var(--border-radius) / 1.5); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
.ctrl-btn.active { background-color: var(--accent); color: white; border-color: var(--accent); }
.ctrl-btn svg { width: 20px; height: 20px; fill: currentColor; }

/* ========== Cards & Grids ========== */
.dashboard-container { display: flex; flex-direction: column; gap: 20px; width: 100%; }
.dashboard-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
.card, .summary-card, .finance-card, #pendingBillsCard, #expenseTrackerCard, #next30DaysCard { padding: 16px; border-radius: var(--border-radius); text-align: center; display: flex; flex-direction: column; }
.summary-card { justify-content: space-between; }
.card { border-radius: var(--border-radius); width:100%; overflow:hidden; padding-bottom:10px; }
h2, h3 { margin: 0 0 10px; font-size: 14px; color: var(--muted); font-weight: 600; }
.card h2 { padding: 0 4px; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin: -4px -4px 12px; }
.card-header h2 { padding: 0; }
.add-bill-container {
    display: flex;
    justify-content: flex-end;
    padding-right: 25%;
    height: 0;
    position: relative;
    z-index: 20;
    margin-top: -20px; /* Counteracts the parent's 'gap' to fix spacing */
}
.add-bill-header-btn {
    background: var(--accent);
    color: white;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: all .2s ease-in-out;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 28px rgba(0,0,0,.18);
    height: 36px; /* 25% smaller than 48px */
    width: auto;
    padding: 0 18px; /* Proportional padding */
    font-size: 14px;
    border-radius: 999px;
    position: relative;
    transform: translateY(-75%); /* This is the key for the 75% floating effect */
}
.add-bill-header-btn svg {
    width: 14px;
    height: 14px;
}
.add-bill-header-btn:hover {
    background: color-mix(in srgb, var(--accent) 90%, black);
    transform: translateY(calc(-75% - 3px)); /* Adjusted hover effect */
    box-shadow: 0 12px 32px rgba(0,0,0,.22);
}
.link-button { background: transparent; border: none; color: var(--accent); cursor: pointer; font-size: 14px; padding: 8px; font-weight: 600; }
.link-button:hover { text-decoration: underline; }

.card-footer {
    display: none;
    padding: 10px 0 0 0;
    text-align: left;
}
.btn-success {
    background-color: var(--ok);
    color: white;
    border: none;
    padding: 10px 16px;
    font-size: 14px;
    font-weight: 600;
    border-radius: calc(var(--border-radius) / 1.5);
    cursor: pointer;
    transition: background-color 0.2s ease;
}
.btn-success:hover {
    background-color: color-mix(in srgb, var(--ok) 90%, black);
}

.summary-card .amount { font-size: 36px; font-weight: 700; line-height: 1.1; }
.summary-card .projected-balance { font-size: 12px; color: var(--muted); margin-top: 4px; height: 1.2em; font-weight: 600; }
.summary-card .amount.paid { color: var(--ok); } .summary-card .amount.unpaid { color: var(--danger); } .summary-card .amount.total { color: var(--accent); }

/* Finance Card - default is <details> now */
.finance-card-header {
    display: flex;
    justify-content: center; /* Changed */
    align-items: center;
    width: 100%;
    position: relative; /* Added */
}
.privacy-btn {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: var(--muted);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    pointer-events: auto !important; /* Keep this for functionality */
}
.privacy-btn:hover {
    background: rgba(128,128,128,0.15);
    color: var(--text);
}
.privacy-btn svg {
    width: 20px;
    height: 20px;
}
.finance-card .stack.blurred {
    filter: blur(5px);
    pointer-events: none;
    user-select: none;
}
.privacy-blurred {
    filter: blur(5px);
    transition: filter 0.2s ease-in-out;
}
details.finance-card { padding: 16px; text-align: left; }
details.finance-card > summary {
    font-size: 14px;
    color: var(--muted);
    font-weight: 600;
    margin: -16px -16px 10px;
    padding: 16px;
    padding-bottom: 10px;
    list-style: none;
    cursor: pointer;
}
details.finance-card > summary::-webkit-details-marker { display: none; }
#billTrackerCard > summary {
    font-size: 14px;
    color: var(--muted);
    font-weight: 600;
    margin: -16px -16px 10px;
    padding: 16px;
    padding-bottom: 10px;
    list-style: none;
    cursor: pointer;
    background: rgba(128,128,128,0.05);
}
#billTrackerCard > summary::-webkit-details-marker { display: none; }
.finance-card .finance-row { display: grid; grid-template-columns: max-content 1fr; gap: 12px; align-items: center; }
.finance-card label { font-weight: 600; font-size: 13px; text-align: right; }
.finance-card input, .finance-card select, #expenseTrackerCard input, #expenseTrackerCard select { flex-grow: 1; padding: 8px 10px; border: 1px solid var(--border); border-radius: calc(var(--border-radius) / 2); background: transparent; color: var(--text); font-size: 14px; width: 100%; min-width: 0; }
#expenseTrackerCard form { display: flex; flex-direction: column; gap: 10px; margin-top: auto; }
#expenseTrackerCard button { background: var(--accent); color: white; border: none; padding: 10px; border-radius: calc(var(--border-radius) / 2); font-weight: 600; cursor: pointer; }

/* Pending & 30-Day Bills */
#pendingBillsList, #next30DaysList { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; overflow-y: auto; padding-right: 5px; min-height: 80px; }
#next30DaysList { max-height: 207px; /* Approx 4 items */ }
#pendingBillsList { max-height: 95px; }
.upcoming-item { display: flex; justify-content: space-between; align-items: center; background: rgba(128,128,128,0.05); padding: 6px 10px; border-radius: calc(var(--border-radius) / 2); }
.upcoming-item .name { font-weight: 600; font-size: 14px; }
.upcoming-item .details { font-size: 13px; text-align: right; }
.upcoming-item .amount { font-weight: 700; font-family: var(--font-mono); }
.upcoming-item .countdown { color: var(--muted); font-size: 11px; }

/* Add Bill Form & Bill List Table */
details#billTrackerCard { /* flex: 1 1 auto; min-height: 0; */ }
.bill-table-wrapper { width: 100%; overflow-y: auto; flex-grow: 1; }
.bill-table-wrapper.scrollable {
    max-height: 300px; /* Approx height of 4-5 rows */
    overflow-y: auto;
    padding-right: 5px;
}
details#addBillSection > summary { list-style: none; cursor: pointer; font-weight: 600; padding: 12px 16px; border-bottom: 1px solid var(--border); margin: -16px -16px 16px; background: rgba(128,128,128,0.05); }
details#addBillSection > summary::-webkit-details-marker { display: none; }
.add-bill-form { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; padding: 0 16px 16px; border-bottom: 1px solid var(--border); align-items: center; }
#billNotes { grid-column: 1 / -1; } #addBtn { grid-column: 1 / -1; }
#splitBillInputs { grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 6px; }
.add-bill-form input, .add-bill-form select { padding: 10px 12px; border: 1px solid var(--border); border-radius: calc(var(--border-radius) / 1.5); background: var(--bg); color: var(--text); outline: none; font-size: 14px; }
.add-bill-form button { padding: 10px 14px; border: none; background: var(--accent); color: white; border-radius: calc(var(--border-radius) / 1.5); cursor: pointer; font-weight: 600; }
table.bill-table { width: 100%; border-collapse: collapse; text-align: left; }
table.bill-table th, table.bill-table td { padding: 12px 16px; font-size: 14px; }
table.bill-table tbody tr { cursor: pointer; border-bottom: 1px dashed var(--border); }
.bill-details-cell { line-height: 1.3; }
.bill-name { font-weight: 600; }
.bill-sub-details { display: flex; gap: 8px; margin-top: 4px; }
.bill-category-badge, .bill-frequency-badge { font-size: 10px; padding: 2px 8px; border-radius: 999px; background: var(--bg); border: 1px solid var(--border); color: var(--muted); font-weight: 500;}
.split-info-icon { font-size: 11px; margin-left: 6px; color: var(--muted); border: 1px solid; padding: 1px 4px; border-radius: 6px; }
.bill-notes {
    font-size: 13px;
    color: var(--muted);
    white-space: pre-wrap; /* Allow wrapping */
    word-break: break-word; /* Break long words */
    max-height: 60px; /* Limit height to about 3-4 lines */
    overflow-y: auto; /* Add scroll for longer notes */
    padding: 4px 8px;
    background-color: rgba(128,128,128,0.05);
    border-radius: 6px;
    line-height: 1.4;
}
.bill-amount-cell .bill-amount { font-weight: 700; }
.bill-amount-cell .split-info-total { font-size: 11px; color: var(--muted); display: block; }
tr.paid { background-color: color-mix(in srgb, var(--ok) 8%, transparent); color: var(--paid-text); }
tr.paid td { box-shadow: inset 0 1px 0 0 var(--ok), inset 0 -1px 0 0 var(--ok); }
tr.paid td:first-child { box-shadow: inset 1px 1px 0 0 var(--ok), inset 0 -1px 0 0 var(--ok); border-radius: calc(var(--border-radius) / 2) 0 0 calc(var(--border-radius) / 2);}
tr.paid td:last-child { box-shadow: inset -1px 1px 0 0 var(--ok), inset 0 -1px 0 0 var(--ok); border-radius: 0 calc(var(--border-radius) / 2) calc(var(--border-radius) / 2) 0;}
tr.paid .split-info-total, tr.paid .split-info-icon, tr.paid .bill-category-badge, tr.paid .bill-frequency-badge { color: var(--paid-text); border-color: currentColor; background: transparent; }
.date-box { text-align: center; border-radius: calc(var(--border-radius) / 2); padding: 4px; width: 48px; flex-shrink: 0; border: 1px solid var(--border); }
.date-box .month { font-size: 10px; font-weight: 600; text-transform: uppercase; display: block; background-color: var(--accent); color: white; border-radius: 5px 5px 0 0; margin: -4px -4px 2px; padding: 2px; }
tr.paid .date-box .month { background-color: var(--ok); }

tr.pending { background-color: color-mix(in srgb, var(--pending) 8%, transparent); color: var(--pending-text); }
tr.pending td { box-shadow: inset 0 1px 0 0 var(--pending-border), inset 0 -1px 0 0 var(--pending-border); }
tr.pending td:first-child { box-shadow: inset 1px 1px 0 0 var(--pending-border), inset 0 -1px 0 0 var(--pending-border); border-radius: calc(var(--border-radius) / 2) 0 0 calc(var(--border-radius) / 2);}
tr.pending td:last-child { box-shadow: inset -1px 1px 0 0 var(--pending-border), inset 0 -1px 0 0 var(--pending-border); border-radius: 0 calc(var(--border-radius) / 2) calc(var(--border-radius) / 2) 0;}
tr.pending .split-info-total, tr.pending .split-info-icon, tr.pending .bill-category-badge, tr.pending .bill-frequency-badge { color: var(--pending-text); border-color: currentColor; background: transparent; }
tr.pending .date-box .month { background-color: var(--pending-text); color: var(--pending); }

.date-box .day { font-size: 20px; font-weight: 700; line-height: 1; display: block; }
.date-info { min-height: 2.4em; display: flex; align-items: center; justify-content: center; }
.countdown.overdue { color: var(--danger); font-weight: 600; }
.countdown.paid { color: var(--ok); font-weight: 600; }
.countdown.pending { color: var(--pending-text); font-weight: 600; }

.actions-cell { text-align: right; white-space: nowrap; cursor: default; width: 1%; }
.actions-cell button { margin-left: 8px; }

/* Action Button Styling for Desktop & Mobile consistency */
.actions-cell button, .mobile-bill-actions button {
    border: none;
    padding: 6px 12px;
    border-radius: calc(var(--border-radius) / 2);
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    color: white;
    transition: background-color 0.2s ease, transform 0.2s ease;
}
.actions-cell button:hover, .mobile-bill-actions button:hover {
    transform: translateY(-2px);
}
.actions-cell .details-btn, .mobile-bill-actions .details-btn { background-color: var(--accent); }
.actions-cell .pay-btn, .mobile-bill-actions .pay-btn { background-color: var(--ok); }
.actions-cell .pending-btn, .mobile-bill-actions .pending-btn { background-color: var(--pending-text); color: var(--pending); }
.dark .actions-cell .pending-btn, .dark .mobile-bill-actions .pending-btn { background-color: var(--pending-border); color: var(--pending-text); }
.actions-cell .unpay-btn, .mobile-bill-actions .unpay-btn { background-color: var(--muted); }
.actions-cell .remove-btn, .mobile-bill-actions .remove-btn { background-color: var(--danger); }

/* Default state for buttons inside a row */
.actions-cell .details-btn,
.actions-cell .unpay-btn,
.actions-cell .pay-btn,
.actions-cell .pending-btn {
    display: none;
}
/* Show buttons based on row status */
tr .details-btn { display: inline-block; }
tr.unpaid .pay-btn,
tr.unpaid .pending-btn { display: inline-block; }
tr.pending .pay-btn,
tr.pending .unpay-btn { display: inline-block; }
tr.paid .unpay-btn { display: inline-block; }

.no-bills-message { padding: 40px; text-align: center; color: var(--muted); }
#pastBillsCard > summary { color: var(--muted); display: flex; justify-content: center; align-items: center; list-style: none; cursor: pointer; font-weight: 600; padding: 16px; padding-bottom: 10px; margin: -16px -16px 10px; background: rgba(128,128,128,0.05); }
#pastBillsCard > summary::-webkit-details-marker { display: none; }
#pastBillsCard[open] { padding-bottom: 16px; }
#pastBillsCard .bill-table-wrapper {
    /* overflow: hidden; */ /* REMOVED FOR SCROLL FIX */
}

/* ========== The Tab Feature ========== */
#theTabCard > summary {
    font-size: 14px;
    color: var(--muted);
    font-weight: 600;
    margin: -16px -16px 10px;
    padding: 16px;
    padding-bottom: 10px;
    list-style: none;
    cursor: pointer;
    background: rgba(128,128,128,0.05);
}
#theTabCard > summary::-webkit-details-marker {
    display: none;
}
.debt-content-wrapper { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; flex-grow: 1; }
.debt-list { display: flex; flex-direction: column; gap: 8px; max-height: 220px; overflow-y: auto; padding-right: 5px; }
.debt-item { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; padding: 10px; background: rgba(128,128,128,0.05); border-radius: calc(var(--border-radius) / 2); border-left: 3px solid var(--accent); }
.debt-item.satisfied { border-left-color: var(--ok); opacity: 0.7; }
.debt-item.satisfied .debt-details { text-decoration: line-through; }
.debt-details { display: flex; flex-direction: column; gap: 2px; }
.debt-details .debt-name { font-weight: 600; }
.debt-details .debt-subtext { font-size: 12px; color: var(--muted); }
.debt-actions button {
    border: none;
    padding: 6px 12px;
    margin-left: 4px;
    border-radius: calc(var(--border-radius) / 2);
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    color: white;
    transition: background-color 0.2s ease, transform 0.2s ease;
}
.debt-actions button:hover {
    transform: translateY(-2px);
}
.debt-actions .pay-btn { background-color: var(--ok); }
.debt-actions .remove-btn { background-color: var(--danger); }
.debt-form-container form { display: flex; flex-direction: column; gap: 10px; }
.debt-form-container h3 { text-align: left; }
.debt-form-container input, .debt-form-container textarea { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: calc(var(--border-radius) / 2); background: var(--bg); color: var(--text); font-size: 14px; }
.debt-form-container textarea { resize: vertical; min-height: 40px; }
.debt-form-container button { background: var(--accent); color: white; border: none; padding: 10px; border-radius: calc(var(--border-radius) / 2); font-weight: 600; cursor: pointer; }

/* ========== Archive View & Filters ========== */
#archive-filters { padding: 16px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
#archive-filters summary { list-style: none; cursor: pointer; font-weight: 600; }
#archive-filters summary::-webkit-details-marker { display: none; }
.filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px; }
.filter-grid label { display: flex; flex-direction: column; text-align: left; font-size: 12px; font-weight: 600; color: var(--muted); }
.filter-grid input, .filter-grid select { margin-top: 4px; padding: 8px 10px; border: 1px solid var(--border); border-radius: calc(var(--border-radius) / 2); background: var(--bg); color: var(--text); }


/* ========== Calendar View ========== */
#calendarView { padding: 16px; }
.calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 0 8px; }
.calendar-header button { background: none; border: 1px solid var(--border); border-radius: calc(var(--border-radius) / 2); cursor: pointer; width: 36px; height: 36px; }
.calendar-grid-container { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: var(--border); border: 1px solid var(--border); border-radius: var(--border-radius); overflow: hidden; }
.calendar-day-name { text-align: center; font-weight: 600; font-size: 12px; padding: 8px 4px; background: var(--bg); color: var(--muted); }
.calendar-day { background: var(--card); min-height: 120px; padding: 4px; font-size: 12px; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; }
.calendar-day.other-month { visibility: hidden; }
.day-number { font-weight: 600; text-align: left; }
.calendar-day.today {
    box-shadow: inset 0 0 0 2px #3b82f6; /* A nice, modern blue for highlighting the current day */
}
.calendar-day.today .day-number {
    /* The green oval was removed as per user request */
}
.day-balance { font-size: 10px; font-weight: 700; color: var(--accent); }
.day-balance.negative { color: var(--danger); font-size: 10px; }
.day-balance-container { text-align: right; height: 1.2em; }
.bills-on-day {
    display: flex;
    flex-direction: column;
    gap: 4px;
    justify-content: center;
    align-items: center;
    min-height: 22px; /* space for bubble */
}
.day-bill-count {
    background-color: var(--accent);
    color: white;
    font-size: 10px;
    font-weight: 700;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease;
}
.calendar-day:hover .day-bill-count {
    transform: scale(1.1);
}
.bill-item-calendar { font-size: 11px; padding: 2px 6px; border-radius: 6px; background-color: var(--accent); color: white; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.bill-item-calendar.expense { background-color: var(--muted); }
.bill-item-calendar.paid {
    background-color: var(--ok);
    text-decoration: line-through;
}

/* ========== Edit & Add Bill Modals ========== */
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: grid; place-items: center; opacity: 0; visibility: hidden; transition: opacity .2s ease, visibility .2s; }
.modal-overlay.visible { opacity: 1; visibility: visible; }
.modal-content { width: 90%; max-width: 500px; padding: 24px; border-radius: var(--border-radius); transform: scale(0.95); transition: transform .2s ease; }
.modal-overlay.visible .modal-content { transform: scale(1); }
.modal-content h2 { margin-top: 0; }
.modal-form, .modal-content form.add-bill-form { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.modal-form label, .modal-content form.add-bill-form label { font-weight: 600; font-size: 14px; text-align: left; grid-column: 1 / -1; margin-bottom: -8px; }
.modal-form .full-width, .modal-content form.add-bill-form .full-width { grid-column: 1 / -1; }
.modal-form input, .modal-form select, .modal-form textarea, .modal-content form.add-bill-form input, .modal-content form.add-bill-form select { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: calc(var(--border-radius) / 2); background: var(--bg); color: var(--text); }
.modal-form textarea { resize: vertical; min-height: 80px; }
.modal-buttons { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; grid-column: 1 / -1; }
.modal-buttons button { padding: 10px 16px; border: none; border-radius: calc(var(--border-radius) / 2); font-weight: 600; cursor: pointer; }
.modal-buttons .save-btn { background: var(--accent); color: white; }
.modal-buttons .cancel-btn { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
.modal-buttons .danger-btn { background: var(--danger); color: white; }
.modal-buttons .special-btn { background: var(--pending-text); color: var(--pending); }
#genericModalContent input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: calc(var(--border-radius) / 1.5);
    background: var(--bg);
    color: var(--text);
    outline: none;
    font-size: 16px;
    margin-top: 8px;
}


#dayBreakdownContent ul {
    list-style: none;
    padding: 0;
    margin: 0;
}
#dayBreakdownContent li {
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
}
#dayBreakdownContent li:last-child {
    border-bottom: none;
}
#dayBreakdownContent h3 {
    margin-top: 16px;
    margin-bottom: 8px;
}
#dayBreakdownContent ul.day-breakdown-list {
    list-style: none;
    padding: 0;
    margin: 10px 0 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
}
#dayBreakdownContent ul.day-breakdown-list li {
    padding: 10px;
    background: rgba(128,128,128,0.05);
    border-radius: calc(var(--border-radius) / 2);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: none;
}
.modal-bill-details {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
}
.modal-bill-amount {
    font-weight: 700;
    font-family: var(--font-mono);
}
.status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
}
.status-indicator.status-paid { background-color: var(--ok); }
.status-indicator.status-unpaid { background-color: var(--danger); }
.status-indicator.status-pending { background-color: var(--pending-text); }
.status-indicator.status-expense { background-color: var(--muted); }
.status-indicator.status-income { background-color: var(--accent); }
.modal-bill-actions {
    display: flex;
    gap: 6px;
}
.modal-bill-actions button {
    border: none;
    padding: 4px 8px;
    border-radius: calc(var(--border-radius) / 2.5);
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
    color: white;
    transition: background-color 0.2s ease, transform 0.2s ease;
}
.modal-bill-actions button:hover {
    transform: translateY(-1px);
}
.modal-bill-actions .pay-btn { background-color: var(--ok); }
.modal-bill-actions .pending-btn { background-color: var(--pending-text); color: var(--pending); }
.dark .modal-bill-actions .pending-btn { background-color: var(--pending-border); color: var(--pending-text); }
.modal-bill-actions .unpay-btn { background-color: var(--muted); }
.modal-bill-actions .dismiss-btn { background-color: var(--danger); }
.modal-bill-actions .details-btn { background-color: var(--accent); padding: 5px 10px; }

/* ========== Natural Slide Animations ========== */
tr.slide-enter { opacity:0; transform:translateY(10px); }
tr.slide-enter-active { transition: opacity var(--slide-duration) var(--slide-ease), transform var(--slide-duration) var(--slide-ease); opacity:1; transform:translateY(0); }
tr.slide-out { transition: opacity calc(var(--slide-duration) / 2) ease, transform calc(var(--slide-duration) / 2) ease; opacity:0; transform:translateX(14px); }
tr.collapsing { overflow:hidden; height:0 !important; padding-top:0 !important; padding-bottom:0 !important; margin:0 !important; border:0 !important; transition: height var(--slide-duration) var(--slide-ease) !important; }

/* ========== Settings Menu (Condensed) ========== */
#ambianceCanvas{ position:fixed; inset:0; pointer-events:none; z-index: 5; }
.menu-panel{ position:fixed; top:78px; right:20px; border-radius:var(--border-radius); padding:14px; width:540px; display:none; z-index:1100; max-height:calc(100vh - 100px); overflow:auto; }
.menu-panel .section, .sub-section { border:1px solid var(--border); border-radius: calc(var(--border-radius) / 1.5); overflow:hidden; margin-top: 10px; }
.menu-panel summary{ list-style:none; cursor:pointer; padding:12px 14px; display:flex; align-items:center; justify-content:space-between; font-weight:700; background:rgba(128,128,128,0.08); border-radius: 8px; }
.sub-section summary { font-weight: 600; font-size: 14px; background: rgba(128,128,128,0.04); padding: 10px 12px; }
.menu-panel .content{ padding:10px 12px 14px; border-top:1px solid var(--border); display:flex; flex-direction:column; gap:10px; }
.slider-row{ display:flex; align-items:center; gap:10px; } .slider-row label{ min-width:148px; } .slider-row input[type=range]{ flex:1; }
.pct{ min-width:48px; text-align:right; font-size:12px; color:var(--muted); }
.shadow-cue { /* NEW */
    width: 50px; height: 30px; border-radius: 5px; background: var(--card); border: 1px solid var(--border);
    transition: box-shadow 0.1s ease-in-out;
}
.menu-notch{ position:sticky; bottom:0; display:flex; justify-content:center; padding:12px 0 2px; margin-top:8px; }
.menu-notch button{ border:none; cursor:pointer; font-weight:600; padding:12px 16px; border-radius:999px; background:var(--card); color:var(--text); border:1px solid var(--border); box-shadow:var(--shadow); }
.stack{ display:flex; flex-direction:column; gap:8px; } .hr{ border:none; border-top:1px solid var(--border); margin:6px 0; }
#resetProfileBtn { background-color: var(--danger); color: white; } /* NEW */

.bottom-nav {
    display: none;
}

@media (max-width: 768px) {
    body { padding: 10px; }
    .app { gap: 16px; height: auto; min-height: initial; }
    .dashboard-container { grid-template-columns: 1fr; }
    details#billTrackerCard { max-height: none; flex: initial; }
    .menu-panel{ right:8px; left:8px; width:auto; top:70px; }
    .calendar-day { min-height: 80px; }
}

/* ========== MOBILE MODE STYLES ========== */
@media (max-width: 768px) {
    /* Base layout fix to prevent overflow */
    .mobile-view {
        display: block; /* Override grid centering */
        padding: 0;
        overscroll-behavior-y: contain;
    }

    /* Set up main layout flow */
    .mobile-view .app {
        padding: 65px 10px 90px; /* Space for sticky header/FAB and body padding */
        max-width: 100%;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        box-sizing: border-box;
        gap: 12px; /* Reduce gap between sections */
    }
    .mobile-view .title-wrap {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        max-width: none;
        width: 100%;
        z-index: 1000;
        border-radius: 0;
        border-bottom: 1px solid var(--border);
        box-shadow: none;
    }

    /* Re-flow dashboard into a single column */
    .mobile-view .dashboard-container {
        display: flex;
        flex-direction: column;
        order: 1; /* Dashboard section first */
    }
    .mobile-view .dashboard-row {
        display: contents; /* Let children be direct flex items */
    }

    /* Order dashboard cards vertically */
    .mobile-view #balanceSummaryCard { order: 1; }
    .mobile-view #dueSummaryCard { order: 2; }
    .mobile-view #financeCard { order: 3; }

    /* Make Finance card collapsible on mobile */
    .mobile-view details.finance-card > summary,
    .mobile-view details#theTabCard > summary {
        cursor: pointer;
        list-style: revert; /* Show dropdown arrow */
        background: rgba(128,128,128,0.05);
    }

    @media (min-width: 769px) {
        #financeCard > summary {
            pointer-events: none;
            cursor: default;
        }
        #financeCard > summary::-webkit-details-marker {
            display: none;
        }
    }

    .mobile-view #theTabCard {
        order: 4;
        text-align: left;
    }
    
    .mobile-view #theTabCard .debt-content-wrapper {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    .mobile-view details.finance-card .stack {
        overflow: hidden;
    }

    /* Order main content sections */
    .mobile-view #billTrackerCard { order: 2; margin-top: 0; }
    .mobile-view .add-bill-container { order: 3; }
    .mobile-view #pastBillsCard {
        order: 5;
        margin-bottom: auto;
    }
    .mobile-view #billTrackerCard > summary,
    .mobile-view #pastBillsCard > summary {
        text-align: left;
        cursor: pointer;
        list-style: revert;
        background: rgba(128,128,128,0.05);
        margin: -16px -16px 10px;
        padding: 16px;
        padding-bottom: 10px;
        display: list-item;
    }
    #pastBillsCard[open] .card-footer {
        display: block;
    }
    .mobile-view .bill-table-wrapper {
      padding-right: 0;
    }

    .mobile-view #archiveView main.card {
        flex-grow: 1;
        height: 70vh;
    }

    /* Floating Action Button (FAB) for "Add Bill" */
    .mobile-view .add-bill-container {
        position: fixed;
        bottom: 80px; /* Adjusted for bottom nav */
        right: 20px;
        left: auto;
        width: auto;
        height: auto;
        z-index: 1050;
        padding-right: 0;
        margin-top: 0;
    }
    .mobile-view .add-bill-header-btn {
        width: auto;
        height: 56px;
        border-radius: 999px;
        padding: 0 24px;
        box-shadow: 0 6px 16px rgba(0,0,0,.2);
        transform: none;
        font-size: 16px;
        font-weight: 700;
    }
    .mobile-view .add-bill-header-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,.25);
    }
    .mobile-view .add-bill-header-btn svg {
        margin-right: 8px;
        width: 20px;
        height: 20px;
    }

    /* Hide non-essential cards in mobile view */
    .mobile-view #expenseTrackerCard,
    .mobile-view #pendingBillsCard,
    .mobile-view #next30DaysCard {
        display: none !important;
    }

    /* --- Bill List Redesign --- */
    .mobile-view .bill-table {
        border-collapse: separate;
        border-spacing: 0 10px;
        margin-top: -10px;
    }
    .mobile-view .bill-table thead {
        display: none;
    }
    .mobile-view .bill-table tbody tr {
        background: transparent;
        border: none;
        padding: 0;
        cursor: default;
        border-bottom: none; /* Override default */
    }
    .mobile-view .bill-table tbody tr td {
        padding: 0 !important;
        box-shadow: none !important;
        display: block;
        border: none !important; /* Override paid/pending borders */
        border-radius: 0 !important;
    }
    .mobile-bill-layout {
        display: grid;
        grid-template:
            "date info amount" auto
            "actions actions actions" auto / 48px 1fr auto;
        gap: 8px 12px;
        padding: 12px;
        border-radius: calc(var(--border-radius) / 1.5);
        background: var(--card);
        border: 1px solid var(--border);
    }
    tr.paid .mobile-bill-layout { border-left: 4px solid var(--ok); }
    tr.pending .mobile-bill-layout { border-left: 4px solid var(--pending-border); }
    tr.unpaid .mobile-bill-layout { border-left: 4px solid var(--danger); }

    .mobile-bill-date {
        grid-area: date;
        align-self: center;
    }
    .mobile-bill-date .date-box { width: 100%; }

    .mobile-bill-info {
        grid-area: info;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: left;
        min-width: 0;
    }
    .mobile-bill-info .bill-name {
        font-weight: 600; font-size: 16px; line-height: 1.2;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .mobile-bill-info .bill-status { margin-top: 4px; font-size: 13px; }

    .mobile-bill-amount {
        grid-area: amount;
        text-align: right;
        align-self: center;
    }
    .mobile-bill-amount .bill-amount { font-size: 18px; font-weight: 700; font-family: var(--font-mono);}
    .mobile-bill-amount .split-info-total { font-size: 10px; }


    .mobile-bill-actions {
        grid-area: actions;
        display: flex; flex-wrap: wrap; justify-content: flex-end;
        gap: 8px; padding-top: 8px; margin-top: 8px;
        border-top: 1px dashed var(--border);
    }

    /* --- Hide desktop elements in mobile view --- */
    .mobile-view .due-date-cell, .mobile-view .bill-details-cell, .mobile-view .bill-notes-cell, .mobile-view .bill-amount-cell, .mobile-view .actions-cell {
        display: none;
    }
    .mobile-view tr td[colspan="5"] {
        display: block;
    }
    
    /* --- Mobile Calendar Optimizations --- */
    .mobile-view #calendarView {
        padding: 10px;
    }
    .mobile-view .calendar-header {
        margin-bottom: 12px;
        padding: 0 4px;
    }
    .mobile-view .calendar-header h2 {
        font-size: 18px;
    }
    .mobile-view .calendar-grid-container {
        grid-template-columns: repeat(7, minmax(0, 1fr));
    }
    .mobile-view .calendar-day-name {
        padding: 6px 2px;
        font-size: 11px;
    }
    .mobile-view .calendar-day {
        min-height: auto;
        aspect-ratio: 1 / 1;
        padding: 3px;
        font-size: 11px;
    }
    .mobile-view .day-number {
        font-size: 11px;
        font-weight: 700;
    }
    .mobile-view .day-balance {
        font-size: 9px;
        text-align: center;
    }
    .mobile-view .bills-on-day {
        gap: 2px;
        overflow: hidden;
    }
    .mobile-view .bill-item-calendar {
        font-size: 10px;
        padding: 1px 4px;
        border-radius: 4px;
    }

    /* Bottom Navigation */
    .mobile-view .bottom-nav {
        display: flex;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: rgba(var(--glass-tint), var(--glass-alpha));
        backdrop-filter: saturate(var(--glass-backdrop-sat)) blur(var(--glass-backdrop-blur));
        -webkit-backdrop-filter: saturate(var(--glass-backdrop-sat)) blur(var(--glass-backdrop-blur));
        border-top: 1px solid var(--glass-stroke);
        z-index: 1000;
        padding-bottom: env(safe-area-inset-bottom); /* For iPhone X notch */
    }
    .mobile-view .bottom-nav-btn {
        flex: 1;
        background: transparent;
        border: none;
        color: var(--muted);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        font-size: 12px;
        cursor: pointer;
        padding-top: 8px;
    }
    .mobile-view .bottom-nav-btn svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
    }
    .mobile-view .bottom-nav-btn.active {
        color: var(--accent);
    }
}

/* ========== Statistics View Specific Styles ========== */
#statisticsView .dashboard-row.summary-metrics {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}
#statisticsView .dashboard-row.charts {
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}
#statisticsView .dashboard-row.tables {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
}
@media (max-width: 768px) {
    .mobile-view #statisticsView .dashboard-row {
        grid-template-columns: 1fr;
    }
    .mobile-view #statisticsView main.dashboard-container {
        padding: 0;
    }
}


@media print {
    body > *:not(#app),
    #app > *:not(#calendarView),
    .menu-panel, #editModal, #archiveView {
        display: none !important;
    }
    .app, body {
        padding: 0;
        margin: 0;
        background: none;
    }
    #calendarView {
        display: block !important;
        max-width: 100% !important;
        box-shadow: none !important;
        border: none !important;
        background: white !important;
        color: black !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    .glass {
        background: transparent !important;
        backdrop-filter: none !important;
        --glass-stroke: #ccc !important;
        border-color: #ccc !important;
    }
    .calendar-header .ctrl-btn {
        display: none !important;
    }
    .calendar-header h2 {
        color: black !important;
    }
    .bill-item-calendar {
        background-color: #eee !important;
        color: #333 !important;
        border: 1px solid #ddd;
    }
    .bill-item-calendar.paid {
        background-color: #e8f5e9 !important;
        color: #2e7d32 !important;
        text-decoration: none;
    }
    .calendar-day.today .day-number {
        background-color: #ddd !important;
        color: black !important;
    }
    :root {
        --text: #000;
        --muted: #555;
        --card: #fff;
        --bg: #fff;
        --border: #ccc;
    }
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf-autotable.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.min.js"></script>
</head>
<body>
  <canvas id="ambianceCanvas"></canvas>
  <div class="app" id="app">
    <header class="title-wrap glass">
      <h1><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2ZM13,17H11V15H13V17ZM13,13H11V7H13V13Z" /></svg>Summit Forecast</h1>
      <div class="header-controls">
        <button id="darkToggle" class="ctrl-btn dark-toggle" title="Toggle Dark Mode">üåô</button>
        <button id="calendarToggleBtn" class="ctrl-btn" title="Toggle Calendar View"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19,19H5V8H19M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M16.53,11.06L15.47,10L10.5,14.97L8.47,12.94L7.41,14L10.5,17.09L16.53,11.06Z"/></svg></button>
        <button id="menuBtn" class="ctrl-btn menu-btn" title="Open Settings"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg></button>
      </div>
    </header>

    <div class="dashboard-container">
        <div class="dashboard-row">
            <div id="balanceSummaryCard" class="summary-card glass"><h3 id="totalAmountLabel">Available Balance</h3><div class="amount total" id="totalAmount">$0.00</div><div class="projected-balance" id="actualBalance"></div></div>
            <div id="dueSummaryCard" class="summary-card glass"><h3 id="totalDueNext10DaysLabel">Your Share (Next 10 Days)</h3><div class="amount unpaid" id="totalDueNext10Days">$0.00</div><div class="projected-balance" id="projected10Day"></div></div>
            <div id="pendingBillsCard" class="glass"><h2>Pending</h2><div id="pendingBillsList"></div></div>
        </div>
        <div class="dashboard-row">
            <div id="next30DaysCard" class="glass"><h2>Next 30 Days</h2><div id="next30DaysList"></div></div>
            <details id="financeCard" class="finance-card glass">
                <summary class="finance-card-header">
                    <span>My Finances</span>
                    <button id="privacyToggleBtn" class="ctrl-btn privacy-btn" title="Toggle Visibility">
                        <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/></svg>
                        <svg class="eye-closed" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.83,9L15,12.17V12A3,3 0 0,0 12,9C11.94,9 11.89,9 11.83,9M7.53,9.8L9.08,11.35C9.03,11.56 9,11.77 9,12A3,3 0 0,0 12,15C12.22,15 12.44,14.97 12.65,14.92L14.2,16.47C13.53,16.8 12.79,17 12,17A5,5 0 0,1 7,12C7,10.79 7.2,9.67 7.53,9.8M2,4.27L4.28,6.55L4.73,7C3.08,8.3 1.78,10 1,12C2.73,16.39 7,19.5 12,19.5C13.55,19.5 15.03,19.2 16.38,18.66L16.81,19.08L19.73,22L21,20.73L3.27,3L2,4.27M12,7A5,5 0 0,1 17,12C17,12.64 16.87,13.26 16.64,13.82L19.55,16.73C21.07,15.5 22.27,13.86 23,12C21.27,7.61 17,4.5 12,4.5C10.6,4.5 9.27,4.75 8.04,5.25L9.9,7.11C10.54,7.03 11.22,7 12,7Z"/></svg>
                    </button>
                </summary>
                <div class="stack">
                    <div class="finance-row"><label for="currentBalance">Balance:</label><input type="number" id="currentBalance" placeholder="$0.00"></div>
                    <div class="finance-row"><label for="dontAutoDeduct">Don't auto-deduct:</label><input type="checkbox" id="dontAutoDeduct" style="width: auto; justify-self: start;"></div>
                    <div class="finance-row"><label for="paycheckAmount">Next/Est Paycheck:</label><input type="number" id="paycheckAmount" placeholder="$0.00"></div>
                    <div class="finance-row"><label for="nextPayday">Next Payday:</label><input type="date" id="nextPayday"></div>
                    <div class="finance-row"><label for="payFrequency">Frequency:</label><select id="payFrequency"><option>Weekly</option><option selected>Bi-Weekly</option><option>Monthly</option></select></div>
                </div>
            </details>
            <div id="expenseTrackerCard" class="glass">
                <h3>Log an Expense</h3>
                <div id="expenseQuickOptions" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <button class="ctrl-btn quick-expense-btn glass" data-expense="Food" style="width:100%; height:auto; padding: 16px 12px;">Food üçî</button>
                    <button class="ctrl-btn quick-expense-btn glass" data-expense="Gas" style="width:100%; height:auto; padding: 16px 12px;">Gas ‚õΩ</button>
                    <button class="ctrl-btn quick-expense-btn glass" data-expense="Coffee" style="width:100%; height:auto; padding: 16px 12px;">Coffee ‚òï</button>
                    <button class="ctrl-btn quick-expense-btn glass" data-expense="Cigarettes" style="width:100%; height:auto; padding: 16px 12px;">Cigarettes üö¨</button>
                    <button class="ctrl-btn quick-expense-btn glass" data-expense="Baseball Cards" style="width:100%; height:auto; padding: 16px 12px;">Cards üÉè</button>
                    <button class="ctrl-btn quick-expense-btn glass" data-expense="Groceries" style="width:100%; height:auto; padding: 16px 12px;">Groceries üõí</button>
                    <button class="ctrl-btn" id="customExpenseBtn" style="width:100%; height:auto; padding: 12px; grid-column: 1 / -1;">Custom</button>
                </div>
                <form id="expenseForm" style="display: none;">
                    <input type="text" id="expenseDescription" placeholder="e.g., Lunch" required>
                    <input type="number" id="expenseAmount" placeholder="$ Amount" required>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button type="button" id="cancelCustomExpenseBtn">Cancel</button>
                        <button type="submit">Log Expense</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="dashboard-row" id="theTabRow" style="display: none;">
            <details id="theTabCard" class="card glass">
                <summary>The Tab</summary>
                <div class="debt-content-wrapper">
                    <div id="debtList" class="debt-list">
                        </div>
                    <div class="debt-form-container">
                        <h3>Log a New Debt</h3>
                        <form id="addDebtForm">
                            <input type="text" id="debtName" placeholder="Who owes you?" required>
                            <input type="number" id="debtAmount" placeholder="Amount ($)" step="0.01" required>
                            <input type="date" id="debtDate" required>
                            <textarea id="debtNotes" placeholder="Notes (e.g., for lunch)"></textarea>
                            <button type="submit">Log Debt</button>
                        </form>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <details id="billTrackerCard" class="card glass" role="main">
      <summary>Upcoming Bills (Next 10 Days)</summary>
      <div>
          <div class="bill-table-wrapper">
            <table class="bill-table" id="billList">
                <thead id="billListHead">
                    <tr><th>Due Date</th><th>Bill Details</th><th>Notes</th><th>Amount</th><th style-align: right;>Actions</th></tr>
                </thead>
                <tbody id="billListBody"></tbody>
            </table>
            <div class="no-bills-message" id="noBillsMessage"><p>No upcoming bills. Add one to get started! üí∏</p></div>
          </div>
      </div>
    </details>

    <div class="add-bill-container">
        <button id="addBillBtnHeader" class="add-bill-header-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="14" height="14" fill="currentColor" style="vertical-align: middle; margin-right: 8px;"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2h6z"></path></svg><span class="add-bill-text">Add Bill</span>
        </button>
    </div>

    <details id="pastBillsCard" class="card glass">
        <summary>Past Bills</summary>
        <div>
            <div class="bill-table-wrapper">
                <table class="bill-table" id="pastBillsTable">
                    <thead><tr><th>Due Date</th><th>Bill Details</th><th>Notes</th><th>Amount</th><th style="text-align: right;">Actions</th></tr></thead>
                    <tbody id="pastBillsListBody"></tbody>
                </table>
                 <div class="no-bills-message" id="noPastBillsMessage" style="display: none;"><p>No paid bills yet.</p></div>
            </div>
            <div class="card-footer">
                <button id="archiveBtn" class="btn-success">View Full Archive</button>
            </div>
        </div>
    </details>

    <div id="calendarView" class="card glass" style="display: none;"></div>
  </div>

  <div id="archiveView" class="app" style="display: none; flex-direction: column;">
    <main class="card glass" role="main">
        <details id="archive-filters">
            <summary>Filter & Search</summary>
            <div class="filter-grid">
                <label>Search Term <input type="text" id="filterSearchTerm" placeholder="e.g., Netflix..."></label>
                <label>Start Date <input type="date" id="filterStartDate"></label>
                <label>End Date <input type="date" id="filterEndDate"></label>
                <label>Category <select id="filterCategory"></select></label>
                <button id="clearFiltersBtn" class="ctrl-btn" style="width: auto; height: 38px; align-self: end; padding: 0 16px;">Clear</button>
            </div>
        </details>
        <div class="bill-table-wrapper" id="archive-table-wrapper">
            <table class="bill-table" id="archiveBillsTable">
                <tbody id="archiveBillsListBody"></tbody>
            </table>
            <div class="no-bills-message" id="noArchivedBillsMessage" style="display: none;"><p>No archived bills found.</p></div>
        </div>
    </main>
    <div class="add-bill-container">
        <button id="backFromArchiveBtn" class="add-bill-header-btn">‚Üê Go Back</button>
    </div>
  </div>

  <div id="statisticsView" class="app" style="display: none; flex-direction: column;">
    <header class="title-wrap glass">
      <h1><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M3.5 18.5C4.22 18.5 4.85 18.22 5.33 17.74L17.74 5.33C18.22 4.85 18.5 4.22 18.5 3.5C18.5 2.67 17.83 2 17 2C16.17 2 15.5 2.67 15.5 3.5C15.5 4.22 15.78 4.85 16.26 5.33L3.85 17.74C3.37 18.22 3 18.83 3 19.5V20H10V18.5H3.5M19 12V15L22 12L19 9V12M17 16V19L20 16L17 13V16M13 16H15V18H13V16M9 12H11V14H9V12M5 8H7V10H5V8Z"/></svg>Statistics</h1>
      <div class="header-controls" style="display: flex; gap: 10px;">
        <select id="statsTimeRange" class="ctrl-btn" style="width: auto; padding: 0 10px;"><option value="7">Last 7 Days</option><option value="30" selected>Last 30 Days</option><option value="90">Last 90 Days</option><option value="365">This Year</option><option value="all">All Time</option></select>
        <select id="statsCategory" class="ctrl-btn" style="width: auto; padding: 0 10px;"><option value="all">All Categories</option></select>
      </div>
    </header>
    <main class="dashboard-container" style="flex-grow: 1; overflow-y: auto; padding: 0 10px 10px; gap: 16px;">
      
      <!-- Key Summary Metrics -->
      <div class="dashboard-row summary-metrics">
        <div class="summary-card glass"><h3>Total Income</h3><div id="statsTotalIncome" class="amount" style="color: var(--ok);">$0.00</div></div>
        <div class="summary-card glass"><h3>Total Expenses</h3><div id="statsTotalExpenses" class="amount" style="color: var(--danger);">$0.00</div></div>
        <div class="summary-card glass"><h3>Net Balance</h3><div id="statsNetBalance" class="amount" style="color: var(--accent);">$0.00</div></div>
        <div class="summary-card glass"><h3>Bills Paid</h3><div id="statsBillsPaid" class="amount">0 / 0</div></div>
      </div>

      <!-- Charts & Visualizations -->
      <div class="dashboard-row charts">
        <div class="card glass" style="min-height: 300px; display: flex; flex-direction: column;">
          <h2>Spending by Category</h2>
          <div class="chart-placeholder" style="flex-grow: 1; display: grid; place-items: center; color: var(--muted); position: relative;"><canvas id="categoryPieChart"></canvas></div>
        </div>
        <div class="card glass" style="min-height: 300px; display: flex; flex-direction: column;">
          <h2>Expenses Over Time</h2>
          <div class="chart-placeholder" style="flex-grow: 1; display: grid; place-items: center; color: var(--muted); position: relative;"><canvas id="expensesLineChart"></canvas></div>
        </div>
        <div class="card glass" style="min-height: 300px; display: flex; flex-direction: column;">
          <h2>Upcoming vs Paid Bills</h2>
          <div class="chart-placeholder" style="flex-grow: 1; display: grid; place-items: center; color: var(--muted); position: relative;"><canvas id="billsBarChart"></canvas></div>
        </div>
        <div class="card glass" style="min-height: 300px; display: flex; flex-direction: column;">
          <h2>Cash Flow Projection</h2>
          <div class="chart-placeholder" style="flex-grow: 1; display: grid; place-items: center; color: var(--muted); position: relative;"><canvas id="cashFlowLineChart"></canvas></div>
        </div>
      </div>

      <!-- Tables/Lists -->
      <div class="dashboard-row tables">
        <div id="topCategoriesCard" class="card glass">
          <h2>Top Expense Categories</h2>
          <div id="topCategoriesList" class="table-placeholder" style="padding: 10px; color: var(--muted); text-align: left;">
            <!-- Dynamic Content -->
          </div>
        </div>
        <div id="largestExpensesCard" class="card glass">
          <h2>Largest Single Expenses</h2>
          <div id="largestExpensesList" class="table-placeholder" style="padding: 10px; color: var(--muted); text-align: left;">
            <!-- Dynamic Content -->
          </div>
        </div>
        <div id="recurringBillsCard" class="card glass">
          <h2>Recurring Bills Overview</h2>
          <div id="recurringBillsList" class="table-placeholder" style="padding: 10px; color: var(--muted); text-align: left;">
            <!-- Dynamic Content -->
          </div>
        </div>
      </div>

      <!-- Debt/Tab Stats -->
      <div class="dashboard-row">
        <div id="debtStatsCard" class="card glass" style="width: 100%;">
          <h2>Debt / "The Tab" Stats</h2>
          <div id="debtStatsList" class="debt-stats-placeholder" style="padding: 10px; color: var(--muted); display: grid; grid-template-columns: 1fr 1fr; gap: 16px; text-align: left;">
            <!-- Dynamic Content -->
          </div>
        </div>
      </div>

    </main>
  </div>

  <div id="editModal" class="modal-overlay"><div class="modal-content glass"><h2 id="editModalTitle">Edit Bill</h2><div class="modal-form"><label for="editBillName">Bill Name</label><input type="text" id="editBillName" class="full-width"><label for="editBillAmount">Total Amount</label><input type="number" step="0.01" id="editBillAmount" class="full-width"><label for="editBillDate">Due Date</label><input type="date" id="editBillDate" class="full-width"><label for="editBillCategory">Category</label><select id="editBillCategory" class="full-width"></select><label for="editBillFrequency">Frequency</label><select id="editBillFrequency" class="full-width"></select><div id="editCustomFrequencyWrapper" class="full-width" style="display: none;"><input type="number" id="editBillCustomFrequency" placeholder="Every X Days" style="width: 100%;"></div><label for="editBillNotes">Notes</label><textarea id="editBillNotes" class="full-width"></textarea><div id="editSplitBillInputs" class="full-width"><hr><label>Split Info</label><input type="text" id="editBillSplitName" placeholder="Split with (Name)"><input type="number" id="editBillSplitAmount" placeholder="Their Share ($)"></div><div class="modal-buttons"><button type="button" class="cancel-btn" id="closeModalBtn">Cancel</button><button type="button" class="save-btn" id="saveEditBtn">Save Changes</button></div></div></div></div>

  <div id="dayBreakdownModal" class="modal-overlay">
    <div class="modal-content glass">
      <h2 id="dayBreakdownTitle">Day Breakdown</h2>
      <div id="dayBreakdownContent"></div>
      <div class="modal-buttons">
        <button type="button" class="cancel-btn" id="closeDayBreakdownModalBtn">Close</button>
      </div>
    </div>
  </div>

  <div id="addBillModal" class="modal-overlay">
    <div class="modal-content glass">
      <h2>Add New Bill</h2>
      <form class="add-bill-form" id="addBillForm" style="border-bottom: none; padding-bottom: 0;">
          <input id="billName" type="text" placeholder="Bill Name (e.g., Netflix)" required class="full-width" />
          <input id="billAmount" type="number" placeholder="Total Amount ($)" step="0.01" min="0" />
          <input id="billDate" type="date" required />
          <select id="billFrequency"><option>One-Time</option><option>Weekly</option><option>Bi-Weekly</option><option selected>Monthly</option><option>Quarterly</option><option>Annually</option><option>Custom</option></select>
          <select id="billCategory"><option>Utilities</option><option>Subscription</option><option>Rent/Mortgage</option><option>Loan</option><option>Insurance</option><option>Groceries</option><option>Personal</option><option>Other</option><option value="Expense">Expense</option></select>
          <div id="customFrequencyWrapper" class="full-width" style="display: none;">
            <input type="number" id="billCustomFrequency" placeholder="Every X Days" style="width: 100%;">
          </div>
          <input id="billNotes" type="text" placeholder="Notes (optional)" class="full-width" />
          <div id="splitBillInputs" class="full-width"><input type="text" id="billSplitName" placeholder="Split with (Name)"><input type="number" id="billSplitAmount" placeholder="Their Share ($)"></div>
          <div class="modal-buttons full-width">
            <button type="button" class="cancel-btn" id="closeAddBillModalBtn">Cancel</button>
            <button id="addBtn" type="button" class="save-btn">Add Bill</button>
          </div>
      </form>
    </div>
  </div>

    <div id="expenseModal" class="modal-overlay">
      <div class="modal-content glass">
        <h2>Log an Expense</h2>
        <div id="expenseModalContent">
            <div id="expenseModalQuickOptions" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <button class="ctrl-btn quick-expense-btn glass" data-expense="Food" style="width:100%; height:auto; padding: 16px 12px;">Food üçî</button>
                <button class="ctrl-btn quick-expense-btn glass" data-expense="Gas" style="width:100%; height:auto; padding: 16px 12px;">Gas ‚õΩ</button>
                <button class="ctrl-btn quick-expense-btn glass" data-expense="Coffee" style="width:100%; height:auto; padding: 16px 12px;">Coffee ‚òï</button>
                <button class="ctrl-btn quick-expense-btn glass" data-expense="Cigarettes" style="width:100%; height:auto; padding: 16px 12px;">Cigarettes üö¨</button>
                <button class="ctrl-btn quick-expense-btn glass" data-expense="Baseball Cards" style="width:100%; height:auto; padding: 16px 12px;">Cards üÉè</button>
                <button class="ctrl-btn quick-expense-btn glass" data-expense="Groceries" style="width:100%; height:auto; padding: 16px 12px;">Groceries üõí</button>
                <button class="ctrl-btn" id="customExpenseModalBtn" style="width:100%; height:auto; padding: 12px; grid-column: 1 / -1;">Custom</button>
            </div>
            <form id="expenseModalForm" style="display: none; flex-direction: column; gap: 10px; margin-top: 10px;">
                <input type="text" id="expenseModalDescription" placeholder="e.g., Lunch" required>
                <input type="number" id="expenseModalAmount" placeholder="$ Amount" required>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button type="button" id="cancelCustomExpenseModalBtn">Cancel</button>
                    <button type="submit">Log Expense</button>
                </div>
            </form>
        </div>
        <div class="modal-buttons" style="margin-top: 10px;">
          <button type="button" class="cancel-btn" id="closeExpenseModalBtn">Close</button>
        </div>
      </div>
    </div>

  <div class="menu-panel glass" id="menuPanel" aria-hidden="true">
    <div class="section"><details><summary>Appearance</summary>
        <div class="content">
          <div class="sub-section"><details><summary>User Interface</summary><div class="content"><div class="stack"><label for="uiStyleSelect">Style</label><select id="uiStyleSelect"></select></div><div class="slider-row"><label for="glassOpacity">Opacity</label><input type="range" id="glassOpacity" min="10" max="100" value="80" /><span class="pct" id="glassOpacityPct"></span></div><div class="slider-row"><label for="glassBlurSlider">Blur</label><input type="range" id="glassBlurSlider" min="0" max="20" value="8" /><span class="pct" id="glassBlurPct"></span></div><div class="slider-row"><label for="cornerRadiusSlider">Corner Radius</label><input type="range" id="cornerRadiusSlider" min="0" max="32" value="16" /><span class="pct" id="cornerRadiusPct"></span></div><div class="slider-row"><label for="glassShadowSlider">Glass Shadow</label><input type="range" id="glassShadowSlider" min="0" max="100" value="50" /><div id="shadowCue" class="shadow-cue"></div></div></div></details></div>
          <div class="sub-section"><details><summary>Animations</summary><div class="content"><label><input type="checkbox" id="enableNaturalSlide"> Natural Slide Animation</label><div class="slider-row"><label for="slideSpeed">Animation Speed</label><input type="range" id="slideSpeed" min="100" max="1500" value="1000"><span class="pct" id="slideSpeedPct"></span></div></div></details></div>
          <div class="sub-section"><details><summary>Background</summary><div class="content"><div class="stack"><label><input type="checkbox" id="enableCustomBackground">Enable Custom Background</label></div><div id="customBackgroundOptions" class="stack" style="display:none;"><div class="hr"></div><div class="stack"><label for="backgroundType">Type</label><select id="backgroundType"><option value="theme" selected>Theme</option><option value="image">Image</option><option value="color">Gradient</option></select></div><div id="imageWallpaperControls" style="display:none; margin-top: 10px;"><input type="file" id="wallpaperFile" accept="image/*" /></div><div id="colorWallpaperControls" class="stack" style="display:none; margin-top: 10px;"><label>Start Color: <input type="color" id="wallpaperColor3" value="#1e1b4b"></label><label>End Color: <input type="color" id="wallpaperColor2" value="#4c1d95"></label><div class="slider-row"><label for="gradientAngle">Angle</label><input type="range" id="gradientAngle" min="0" max="360" value="145"><span class="pct" id="gradientAnglePct"></span></div><div class="stack"><label><input type="checkbox" id="gradientSpinToggle">Enable Spinning</label><div class="slider-row" id="gradientSpinControls" style="display:none;"><label for="gradientSpinSpeed">Speed</label><input type="range" id="gradientSpinSpeed" min="1" max="100" value="10"><span class="pct" id="gradientSpinSpeedPct"></span></div></div></div></div><div class="hr"></div><div class="stack"><label><input type="checkbox" id="enableAmbiance">Enable Live Effects</label><div id="ambianceSettings" class="stack" style="display:none; margin-top: 10px;"><select id="ambianceSelect"><option value="none" selected>None</option><option value="snowflakes">Snowflakes</option><option value="orbs">Orbs</option><option value="starfield">Starfield</option></select><div id="ambianceControls" class="stack" style="display:none; border:1px solid var(--border); border-radius:8px; padding:10px; gap: 10px;"><div id="snowControls" class="stack" style="display:none;"><div class="slider-row"><label>Density</label><input type="range" id="snowDensity" min="0" max="300" value="100"><span class="pct" id="snowDensityPct"></span></div><div class="slider-row"><label>Size</label><input type="range" id="snowSize" min="10" max="40" value="20"><span class="pct" id="snowSizePct"></span></div><div class="slider-row"><label>Speed</label><input type="range" id="snowSpeed" min="10" max="100" value="30"><span class="pct" id="snowSpeedPct"></span></div></div><div id="orbsControls" class="stack" style="display:none;"><div class="slider-row"><label>Density</label><input type="range" id="orbsDensity" min="10" max="150" value="40"><span class="pct" id="orbsDensityPct"></span></div><div class="slider-row"><label>Size</label><input type="range" id="orbsSize" min="20" max="150" value="70"><span class="pct" id="orbsSizePct"></span></div><div class="slider-row"><label>Speed</label><input type="range" id="orbsSpeed" min="5" max="100" value="20"><span class="pct" id="orbsSpeedPct"></span></div><label>Color: <input type="color" id="orbsColor" value="#9aa4b2"></label></div><div id="starfieldControls" class="stack" style="display:none;"><div class="slider-row"><label>Density</label><input type="range" id="starfieldDensity" min="50" max="1500" value="500"><span class="pct" id="starfieldDensityPct"></span></div><div class="slider-row"><label>Speed</label><input type="range" id="starfieldSpeed" min="1" max="100" value="25"><span class="pct" id="starfieldSpeedPct"></span></div></div></div></div></div></div></details></div>
    </div></details></div>
    <div class="section"><details><summary>Utility</summary><div class="content">
      <div class="stack">
        <label><input type="checkbox" id="disableAutoOpenCurrentBills"> Disable auto-opening current bills on startup</label>
        <label><input type="checkbox" id="enableTheTab"> Enable "The Tab"</label>
      </div>
      <div class="hr"></div>
      <div class="sub-section"><details open><summary>Experimental Tools</summary><div class="content"><div class="stack">
        <label for="unpaidDays" style="text-align: left; font-size: 14px; font-weight: 600;">Mark bills unpaid after X days:</label>
        <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px;">
            <input type="number" id="unpaidDays" value="30" style="padding: 8px 10px; border: 1px solid var(--border); border-radius: calc(var(--border-radius) / 2); background: var(--bg); color: var(--text);">
            <button id="unpaidToolBtn" class="ctrl-btn" style="width: auto; height: 38px; padding: 0 16px; background-color: var(--pending-text); color: var(--pending);">Run</button>
        </div>
        <div class="hr"></div>
        <div>
            <p style="font-size:12px;color:var(--muted);margin:4px 0 10px;">Generate a realistic, randomized profile of a heavy user to see the app's full potential.</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button id="demoModeBtn" class="ctrl-btn" style="width:100%; height:auto; padding: 10px; background-color: var(--accent); color: white;">Enable Demo Mode</button>
                <button id="deactivateDemoBtn" class="ctrl-btn" style="width:100%; height:auto; padding: 10px;">Deactivate</button>
            </div>
        </div>
      </div></div></details></div>
      <div class="hr"></div>
      <div class="sub-section"><details><summary>Data Management</summary><div class="content"><div class="stack"><p style="font-size:12px;color:var(--muted);margin:4px 0 0;">Import or export your full application profile. This includes all bills, settings, and appearance customizations.</p><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;"><button id="importProfileBtn" class="ctrl-btn" style="width:100%; height:auto; padding: 10px;">Import Profile</button><button id="exportProfileBtn" class="ctrl-btn" style="width:100%; height:auto; padding: 10px;">Export Profile</button></div><div class="hr"></div><button id="resetProfileBtn" class="ctrl-btn" style="width: 100%; height: auto; padding: 10px; margin-top: 5px;">Reset to Factory Defaults</button></div></div></details></div></div></details></div>
    <div class="menu-notch"><button id="closeMenuNotch">Close</button></div>
  </div>

  <div id="genericModal" class="modal-overlay">
    <div class="modal-content glass">
      <h2 id="genericModalTitle"></h2>
      <div id="genericModalContent">
        <p id="genericModalText" style="line-height: 1.5; margin: 16px 0;"></p>
      </div>
      <div class="modal-buttons" id="genericModalButtons"></div>
    </div>
  </div>

  <div class="bottom-nav">
    <button id="dashboardTabBtn" class="bottom-nav-btn active">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13,3V9H21V3M13,15H21V21H13M3,21H11V11H3M3,3H11V9H3"/></svg>
      <span>Dashboard</span>
    </button>
    <button id="statisticsTabBtn" class="bottom-nav-btn">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3.5 18.5C4.22 18.5 4.85 18.22 5.33 17.74L17.74 5.33C18.22 4.85 18.5 4.22 18.5 3.5C18.5 2.67 17.83 2 17 2C16.17 2 15.5 2.67 15.5 3.5C15.5 4.22 15.78 4.85 16.26 5.33L3.85 17.74C3.37 18.22 3 18.83 3 19.5V20H10V18.5H3.5M19 12V15L22 12L19 9V12M17 16V19L20 16L17 13V16M13 16H15V18H13V16M9 12H11V14H9V12M5 8H7V10H5V8Z"/></svg>
      <span>Statistics</span>
    </button>
  </div>

<script>
// IFFE to encapsulate the entire application
(function(){
    "use strict";
    // --- All JavaScript logic is included below ---

    // --- STATE & DOM ---
    let bills = [], debts = [], userFinances = {}, currentView = 'list', calendarDate = new Date(), activeModalResolve = null, isAnimationRunning = true;
    let touchStartX = 0, touchEndX = 0, touchStartY = 0, touchEndY = 0; // For swipe gestures
    const $ = (s) => document.getElementById(s);
    const billTrackerCard = $('billTrackerCard'), pastBillsCard = $('pastBillsCard'), calendarView = $('calendarView'), calendarToggleBtn = $('calendarToggleBtn'), billListBody = $('billListBody'), pastBillsListBody = $('pastBillsListBody');
    const addBillForm = $('addBillForm');
    const splitBillInputs = $('splitBillInputs');
    const addBtn = $('addBtn'), noBillsMessage = $('noBillsMessage'), noPastBillsMessage = $('noPastBillsMessage'), darkToggle = $('darkToggle'), menuBtn = $('menuBtn'), menuPanel = $('menuPanel'), closeMenuNotch = $('closeMenuNotch');
    const totalAmountEl = $('totalAmount'), totalDueNext10DaysEl = $('totalDueNext10Days');
    const pendingBillsList = $('pendingBillsList'), next30DaysList = $('next30DaysList');
    const currentBalance = $('currentBalance'), paycheckAmount = $('paycheckAmount'), nextPayday = $('nextPayday'), payFrequency = $('payFrequency');
    const expenseForm = $('expenseForm');
    const editModal = $('editModal'), closeModalBtn = $('closeModalBtn'), saveEditBtn = $('saveEditBtn');
    const addBillModal = $('addBillModal'), closeAddBillModalBtn = $('closeAddBillModalBtn');
    const editSplitBillInputs = $('editSplitBillInputs');
    const addBillBtnHeader = $('addBillBtnHeader');
    const archiveView = $('archiveView'), appView = $('app'), archiveBtn = $('archiveBtn'), backFromArchiveBtn = $('backFromArchiveBtn');
    const archiveBillsListBody = $('archiveBillsListBody'), noArchivedBillsMessage = $('noArchivedBillsMessage');
    const ambianceCanvas = $('ambianceCanvas'), ctxAmbiance = ambianceCanvas.getContext('2d');
    const uiStyleSelect = $('uiStyleSelect'), glassOpacity = $('glassOpacity'), glassBlurSlider = $('glassBlurSlider');
    const enableNaturalSlide = $('enableNaturalSlide'), slideSpeed = $('slideSpeed');
    const enableCustomBackground = $('enableCustomBackground'), customBackgroundOptions = $('customBackgroundOptions'), backgroundType = $('backgroundType');
    const wallpaperFile = $('wallpaperFile'), wallpaperColor2 = $('wallpaperColor2'), wallpaperColor3 = $('wallpaperColor3');
    const gradientAngle = $('gradientAngle'), gradientSpinToggle = $('gradientSpinToggle'), gradientSpinControls = $('gradientSpinControls'), gradientSpinSpeed = $('gradientSpinSpeed');
    const enableAmbiance = $('enableAmbiance'), ambianceSettings = $('ambianceSettings'), ambianceControls = $('ambianceControls'), ambianceSelect = $('ambianceSelect');
    const snowDensity = $('snowDensity'), snowSize = $('snowSize'), snowSpeed = $('snowSpeed');
    const orbsDensity = $('orbsDensity'), orbsSize = $('orbsSize'), orbsSpeed = $('orbsSpeed'), orbsColor = $('orbsColor');
    const starfieldDensity = $('starfieldDensity'), starfieldSpeed = $('starfieldSpeed');
    const dontAutoDeduct = $('dontAutoDeduct');
    const cornerRadiusSlider = $('cornerRadiusSlider');
    const glassShadowSlider = $('glassShadowSlider');
    const genericModal = $('genericModal'), genericModalTitle = $('genericModalTitle'), genericModalContent = $('genericModalContent'), genericModalText = $('genericModalText'), genericModalButtons = $('genericModalButtons');
    const filterSearchTerm = $('filterSearchTerm'), filterStartDate = $('filterStartDate'), filterEndDate = $('filterEndDate'), filterCategory = $('filterCategory'), clearFiltersBtn = $('clearFiltersBtn');
    const disableAutoOpenCurrentBills = $('disableAutoOpenCurrentBills');
    const expenseModal = $('expenseModal');
    const enableTheTab = $('enableTheTab'), theTabRow = $('theTabRow'), addDebtForm = $('addDebtForm'), debtList = $('debtList');
    const statisticsView = $('statisticsView'), dashboardTabBtn = $('dashboardTabBtn'), statisticsTabBtn = $('statisticsTabBtn');
    const statsTimeRange = $('statsTimeRange'), statsCategory = $('statsCategory');
    let charts = {};

    let ambianceParticles = [], gradientAnimationAngle = 0;
    const materialPresets = { glass: { styles: { 'default': { name: 'Default', light: '255,255,255', dark: '15,20,24' }, 'twilight': { name: 'Twilight', light: '235, 230, 255', dark: '30, 25, 45' }, 'graphite': { name: 'Graphite', light: '240,240,245', dark: '35,35,40' }, 'emerald': { name: 'Emerald', light: '240,255,245', dark: '20,40,30' }, 'blue': { name: 'Blue', light: '235,245,255', dark: '20,30,45' }, }}};

    // --- UTILITY ---
    const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
    const formatDate = (dateStr) => { const d = new Date(dateStr + 'T00:00:00'); return { month: d.toLocaleString('default', { month: 'short' }).toUpperCase(), day: d.getDate() }; };
    const getCountdown = (dateStr) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const dueDate = new Date(dateStr + 'T00:00:00');
        const diffTime = dueDate.getTime() - today.getTime();
        const diffDays = Math.round(diffTime / 864e5);

        if (diffDays > 1) return `${diffDays} days left`;
        if (diffDays === 1) return 'Due tomorrow';
        if (diffDays === 0) return 'Due today';
        return `${Math.abs(diffDays)} days overdue`;
    };
    const resizeCanvas = (cv) => { const dpr = window.devicePixelRatio || 1; cv.width = window.innerWidth * dpr; cv.height = window.innerHeight * dpr; cv.getContext('2d').setTransform(dpr, 0, 0, dpr, 0, 0); };
    const getUserShare = bill => (bill.isSplit && bill.splitWithAmount) ? bill.amount - bill.splitWithAmount : bill.amount;

    // --- DATA & STATE ---
    function saveData() {
        try {
            localStorage.setItem('summitForecast.bills', JSON.stringify(bills));
            localStorage.setItem('summitForecast.debts', JSON.stringify(debts));
            const settings = { darkMode: document.documentElement.classList.contains('dark'), dontAutoDeduct: dontAutoDeduct.checked, finances: { balance: currentBalance.value, paycheck: paycheckAmount.value, payday: nextPayday.value, frequency: payFrequency.value }, financesBlurred: $('financeCard').querySelector('.stack').classList.contains('blurred'), naturalSlide: { enabled: enableNaturalSlide.checked, speed: slideSpeed.value }, uiStyle: uiStyleSelect.value, glassOpacity: glassOpacity.value, glassBlur: glassBlurSlider.value, cornerRadius: cornerRadiusSlider.value, glassShadow: glassShadowSlider.value, customBg: enableCustomBackground.checked, bgType: backgroundType.value, bgColor2: wallpaperColor2.value, bgColor3: wallpaperColor3.value, bgGradientAngle: gradientAngle.value, bgGradientSpin: gradientSpinToggle.checked, bgGradientSpinSpeed: gradientSpinSpeed.value, ambiance: enableAmbiance.checked, ambianceEffect: ambianceSelect.value, snowDensity: snowDensity.value, snowSize: snowSize.value, snowSpeed: snowSpeed.value, orbsDensity: orbsDensity.value, orbsSize: orbsSize.value, orbsSpeed: orbsSpeed.value, orbsColor: orbsColor.value, starfieldDensity: starfieldDensity.value, starfieldSpeed: starfieldSpeed.value, disableAutoOpenCurrentBills: disableAutoOpenCurrentBills.checked, theTabEnabled: enableTheTab.checked };
            localStorage.setItem('summitForecast.settings', JSON.stringify(settings));
        } catch (error) { console.error("Failed to save data:", error); }
    }
    function loadData() {
        try {
            bills = JSON.parse(localStorage.getItem('summitForecast.bills') || '[]');
            debts = JSON.parse(localStorage.getItem('summitForecast.debts') || '[]');
            bills.forEach(bill => {
                if (typeof bill.paid === 'boolean' && !bill.status) {
                    bill.status = bill.paid ? 'paid' : 'unpaid';
                    delete bill.paid;
                } else if (!bill.status) { bill.status = 'unpaid'; }
                if (bill.status === 'paid' && !bill.paidTimestamp) {
                    bill.paidTimestamp = new Date(bill.date + 'T12:00:00Z').toISOString();
                }
            });

            const settingsData = localStorage.getItem('summitForecast.settings');
            const settings = settingsData ? JSON.parse(settingsData) : {};
            if (settings.darkMode) { document.documentElement.classList.add('dark'); darkToggle.innerHTML = '‚òÄÔ∏è'; } else { darkToggle.innerHTML = 'üåô';}
            dontAutoDeduct.checked = settings.dontAutoDeduct || false;
            userFinances = settings.finances || {};
            currentBalance.value = userFinances.balance || ''; paycheckAmount.value = userFinances.paycheck || ''; nextPayday.value = userFinances.payday || ''; payFrequency.value = userFinances.frequency || 'Bi-Weekly';
            const slideSettings = settings.naturalSlide || {};
            enableNaturalSlide.checked = slideSettings.enabled === false ? false : true; slideSpeed.value = slideSettings.speed || 1000;
            populateStyleSelector();
            uiStyleSelect.value = settings.uiStyle || 'twilight';
            glassOpacity.value = settings.glassOpacity || 80; glassBlurSlider.value = settings.glassBlur || 8;
            cornerRadiusSlider.value = settings.cornerRadius || 16;
            glassShadowSlider.value = settings.glassShadow || 50;
            enableCustomBackground.checked = settings.customBg || false; backgroundType.value = settings.bgType || 'theme';
            wallpaperColor2.value = settings.bgColor2 || '#1e1b4b'; wallpaperColor3.value = settings.bgColor3 || '#4c1d95';
            gradientAngle.value = settings.bgGradientAngle || 145; gradientSpinToggle.checked = settings.bgGradientSpin || false; gradientSpinSpeed.value = settings.bgGradientSpinSpeed || '10';
            enableAmbiance.checked = settings.ambiance || false; ambianceSelect.value = settings.ambianceEffect || 'none';
            disableAutoOpenCurrentBills.checked = settings.disableAutoOpenCurrentBills || false;
            enableTheTab.checked = settings.theTabEnabled || false;
            const ambiance = settings.ambianceSettings || {};
            snowDensity.value = ambiance.snowDensity || 100;
            snowSize.value = ambiance.snowSize || 20;
            snowSpeed.value = ambiance.snowSpeed || 30;
            orbsDensity.value = ambiance.orbsDensity || 40;
            orbsSize.value = ambiance.orbsSize || 70;
            orbsSpeed.value = ambiance.orbsSpeed || 20;
            orbsColor.value = ambiance.orbsColor || '#9aa4b2';
            starfieldDensity.value = settings.starfieldDensity || 500;
            starfieldSpeed.value = settings.starfieldSpeed || 25;

            if (settings.financesBlurred) {
                const financeStack = $('financeCard').querySelector('.stack');
                financeStack.classList.add('blurred');
                $('actualBalance').classList.add('privacy-blurred');
                $('projected10Day').classList.add('privacy-blurred');
                const privacyBtn = $('privacyToggleBtn');
                if (privacyBtn) {
                    privacyBtn.querySelector('.eye-open').style.display = 'none';
                    privacyBtn.querySelector('.eye-closed').style.display = 'block';
                }
            }

        } catch (error) { console.error("Failed to load data:", error); }
        $('billDate').value = new Date().toISOString().split('T')[0];
        $('debtDate').value = new Date().toISOString().split('T')[0];
        applyAllAppearance(); renderApp(true);
        if (window.innerWidth > 768) {
            $('financeCard').setAttribute('open', '');
        }
        if (!disableAutoOpenCurrentBills.checked) {
            billTrackerCard.setAttribute('open', '');
        }
    }

    // --- RENDERING ---
    function renderApp(isInitialLoad = false) {
        const dashboardContainer = document.querySelector('.dashboard-container');
        const addBillContainer = document.querySelector('.add-bill-container');

        if (currentView === 'list') {
            dashboardContainer.style.display = 'flex';
            billTrackerCard.style.display = 'flex';
            addBillContainer.style.display = 'flex';
            pastBillsCard.style.display = 'block';
            calendarView.style.display = 'none';
            calendarToggleBtn.classList.remove('active');
            renderLists(isInitialLoad);
        } else { // calendar view
            dashboardContainer.style.display = 'none';
            billTrackerCard.style.display = 'none';
            addBillContainer.style.display = 'none';
            pastBillsCard.style.display = 'none';
            calendarView.style.display = 'block';
            calendarToggleBtn.classList.add('active');
            renderCalendar();
        }
        updateSummary(); renderPendingBills(); renderNext30Days();
        if(enableTheTab.checked) renderTheTab();
    }
    function renderLists(isInitialLoad = false) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(today.getDate() - 30);

        const tenDaysFromNow = new Date();
        tenDaysFromNow.setDate(today.getDate() + 10);

        const activeBills = bills.filter(b => {
            if (b.status === 'paid') return false;
            if (b.status === 'pending') return true;
            const billDate = new Date(b.date + 'T00:00:00');
            return billDate <= tenDaysFromNow;
        }).sort((a, b) => new Date(a.date) - new Date(b.date));

        const pastBills = bills.filter(b => {
            if (b.status !== 'paid' || !b.paidTimestamp) return false;
            const paidDate = new Date(b.paidTimestamp);
            return paidDate >= thirtyDaysAgo;
        }).sort((a, b) => new Date(b.paidTimestamp) - new Date(a.paidTimestamp));

        billListBody.innerHTML = ''; noBillsMessage.style.display = activeBills.length === 0 ? 'block' : 'none';
        pastBillsListBody.innerHTML = ''; noPastBillsMessage.style.display = pastBills.length === 0 ? 'block' : 'none';

        activeBills.forEach(bill => billListBody.appendChild(createBillRow(bill, isInitialLoad)));
        pastBills.forEach(bill => pastBillsListBody.appendChild(createBillRow(bill, isInitialLoad)));

        const applyScrollable = (tbody, threshold) => {
            const wrapper = tbody.closest('.bill-table-wrapper');
            if (!wrapper) return;
            const isMobile = document.body.classList.contains('mobile-view');
            wrapper.classList.toggle('scrollable', !isMobile && tbody.children.length > threshold);
        };
        applyScrollable(billListBody, 3);
        applyScrollable(pastBillsListBody, 3);
    }
    function renderArchive() {
        archiveBillsListBody.innerHTML = '';

        const searchTerm = filterSearchTerm.value.toLowerCase();
        const startDate = filterStartDate.value;
        const endDate = filterEndDate.value;
        const category = filterCategory.value;

        let filteredBills = bills.filter(b => b.status === 'paid');

        if (searchTerm) {
            filteredBills = filteredBills.filter(b =>
                b.name.toLowerCase().includes(searchTerm) ||
                (b.notes && b.notes.toLowerCase().includes(searchTerm))
            );
        }
        if (startDate) {
            filteredBills = filteredBills.filter(b => b.date >= startDate);
        }
        if (endDate) {
            filteredBills = filteredBills.filter(b => b.date <= endDate);
        }
        if (category) {
            filteredBills = filteredBills.filter(b => b.category === category);
        }

        const sortedBills = filteredBills.sort((a, b) => new Date(b.date) - new Date(a.date));
        noArchivedBillsMessage.style.display = sortedBills.length === 0 ? 'block' : 'none';
        sortedBills.forEach(bill => archiveBillsListBody.appendChild(createBillRow(bill, true)));
    }
    function createBillRow(bill, isInitialLoad = false) {
        const tr = document.createElement('tr');
        tr.dataset.id = bill.id;
        if (bill.status === 'paid') tr.classList.add('paid');
        else if (bill.status === 'pending') tr.classList.add('pending');
        else tr.classList.add('unpaid');

        const { month, day } = formatDate(bill.date);
        const yourShare = getUserShare(bill);
        const amountDisplay = bill.isSplit ? `<span class="bill-amount">${formatCurrency(yourShare)}</span><span class="split-info-total">Total: ${formatCurrency(bill.amount)}</span>` : `<span class="bill-amount">${formatCurrency(bill.amount)}</span>`;
        let nameHtml = `<span class="bill-name">${bill.name}</span>`;
        if(bill.isSplit) { nameHtml += `<span class="split-info-icon" title="Split with ${bill.splitWithName}">‚öÅ</span>`; }
        let countdownHtml;
        if (bill.status === 'paid') {
            countdownHtml = `<span class="countdown paid">Paid</span>`;
        } else if (bill.status === 'pending') {
            countdownHtml = `<span class="countdown pending">Pending</span>`;
        } else {
            const countdownText = getCountdown(bill.date);
            const isOverdueClass = countdownText.includes('overdue') ? 'overdue' : '';
            countdownHtml = `<span class="countdown ${isOverdueClass}">${countdownText}</span>`;
        }

        const isMobile = document.body.classList.contains('mobile-view');

        if (isMobile) {
            let actionsHTML = `<button class="details-btn">Details</button>`;
            if (bill.status === 'unpaid') {
                actionsHTML += `<button class="pay-btn">Paid ‚úî</button><button class="pending-btn">Pending</button>`;
            } else if (bill.status === 'pending') {
                actionsHTML += `<button class="pay-btn">Paid ‚úî</button><button class="unpay-btn">Unpaid ‚Ü©</button>`;
            } else if (bill.status === 'paid') {
                actionsHTML += `<button class="unpay-btn">Unpaid ‚Ü©</button>`;
            }
            actionsHTML += `<button class="remove-btn">‚úñ</button>`;

            tr.innerHTML = `
                <td colspan="5">
                    <div class="mobile-bill-layout">
                        <div class="mobile-bill-date">
                             <div class="date-box">
                                <span class="month">${month}</span>
                                <span class="day">${day}</span>
                            </div>
                        </div>
                        <div class="mobile-bill-info">
                            ${nameHtml}
                            <div class="bill-status">${countdownHtml}</div>
                        </div>
                        <div class="mobile-bill-amount">${amountDisplay}</div>
                        <div class="mobile-bill-actions">${actionsHTML}</div>
                    </div>
                </td>`;
        } else {
            tr.innerHTML = `
                <td><div class="due-date-cell"><div class="date-box"><span class="month">${month}</span><span class="day">${day}</span></div><div class="date-info">${countdownHtml}</div></div></td>
                <td class="bill-details-cell">${nameHtml}<div class="bill-sub-details"><span class="bill-category-badge">${bill.category}</span><span class="bill-frequency-badge">${bill.frequency}</span></div></td>
                <td><div class="bill-notes">${bill.notes || '-'}</div></td>
                <td class="bill-amount-cell">${amountDisplay}</td>
                <td class="actions-cell">
                    <button class="details-btn">Details</button>
                    <button class="pay-btn">Paid ‚úî</button>
                    <button class="pending-btn">Pending</button>
                    <button class="unpay-btn">Unpaid ‚Ü©</button>
                    <button class="remove-btn">‚úñ</button>
                </td>`;
        }

        if (!isInitialLoad && bill.justAdded) {
            animateEnter(tr);
            delete bill.justAdded;
        }
        return tr;
    }
    function getPaydaysForMonth(year, month) {
        if (!nextPayday.value) return [];
        const paydays = [];
        let currentPayday = new Date(nextPayday.value + 'T00:00:00');
        const frequency = payFrequency.value || 'Bi-Weekly';

        while (currentPayday.getFullYear() > year || (currentPayday.getFullYear() === year && currentPayday.getMonth() > month)) {
            if (frequency === 'Weekly') currentPayday.setDate(currentPayday.getDate() - 7);
            else if (frequency === 'Bi-Weekly') currentPayday.setDate(currentPayday.getDate() - 14);
            else if (frequency === 'Monthly') currentPayday.setMonth(currentPayday.getMonth() - 1);
            else break;
        }

        while (currentPayday.getFullYear() < year || (currentPayday.getFullYear() === year && currentPayday.getMonth() <= month)) {
            if (currentPayday.getFullYear() === year && currentPayday.getMonth() === month) {
                paydays.push(currentPayday.getDate());
            }
            if (frequency === 'Weekly') currentPayday.setDate(currentPayday.getDate() + 7);
            else if (frequency === 'Bi-Weekly') currentPayday.setDate(currentPayday.getDate() + 14);
            else if (frequency === 'Monthly') currentPayday.setMonth(currentPayday.getMonth() + 1);
            else break;
        }
        return paydays;
    }

    function getPaydaysInRange(startDate, endDate) {
        if (!nextPayday.value) return [];
        const paydays = [];
        let currentPayday = new Date(nextPayday.value + 'T00:00:00');
        const frequency = payFrequency.value || 'Bi-Weekly';

        // Rewind to before the start date
        while (currentPayday > startDate) {
            if (frequency === 'Weekly') currentPayday.setDate(currentPayday.getDate() - 7);
            else if (frequency === 'Bi-Weekly') currentPayday.setDate(currentPayday.getDate() - 14);
            else if (frequency === 'Monthly') {
                let d = currentPayday.getDate();
                currentPayday.setMonth(currentPayday.getMonth() - 1);
                if (currentPayday.getDate() !== d) currentPayday.setDate(0); // handle end of month
            }
            else break;
        }

        // Fast-forward through the range
        while (currentPayday <= endDate) {
            if (currentPayday >= startDate) {
                paydays.push(new Date(currentPayday));
            }
            if (frequency === 'Weekly') currentPayday.setDate(currentPayday.getDate() + 7);
            else if (frequency === 'Bi-Weekly') currentPayday.setDate(currentPayday.getDate() + 14);
            else if (frequency === 'Monthly') {
                let d = currentPayday.getDate();
                currentPayday.setMonth(currentPayday.getMonth() + 1);
                if (currentPayday.getDate() !== d) currentPayday.setDate(0); // handle end of month
            }
            else break;
        }
        return paydays;
    }

    function getBillsForDate(targetDate) {
        const targetYear = targetDate.getFullYear();
        const targetMonth = targetDate.getMonth();
        const targetDay = targetDate.getDate();

        return bills.filter(bill => {
            const billDate = new Date(bill.date + 'T00:00:00');
            const billYear = billDate.getFullYear();
            const billMonth = billDate.getMonth();
            const billDay = billDate.getDate();

            if (billDate > targetDate && bill.frequency === 'One-Time') {
                return false;
            }

            switch (bill.frequency) {
                case 'One-Time':
                    return targetYear === billYear && targetMonth === billMonth && targetDay === billDay;
                case 'Weekly': {
                    if (targetDate < billDate) return false;
                    const diffTime = targetDate.getTime() - billDate.getTime();
                    const diffDays = Math.round(diffTime / 864e5);
                    return diffDays >= 0 && diffDays % 7 === 0;
                }
                case 'Bi-Weekly': {
                    if (targetDate < billDate) return false;
                    const diffTime = targetDate.getTime() - billDate.getTime();
                    const diffDays = Math.round(diffTime / 864e5);
                    return diffDays >= 0 && diffDays % 14 === 0;
                }
                case 'Monthly':
                    return billDay === targetDay && targetDate >= billDate;
                case 'Quarterly':
                    {
                        if (billDay !== targetDay || targetDate < billDate) return false;
                        const monthDiff = (targetYear - billYear) * 12 + (targetMonth - billMonth);
                        return monthDiff >= 0 && monthDiff % 3 === 0;
                    }
                case 'Annually':
                    return billMonth === targetMonth && billDay === targetDay && targetDate >= billDate;
                case 'Custom': {
                    if (targetDate < billDate || !bill.customFrequencyDays || bill.customFrequencyDays <= 0) return false;
                    const diffTime = targetDate.getTime() - billDate.getTime();
                    const diffDays = Math.round(diffTime / 864e5);
                    return diffDays >= 0 && diffDays % bill.customFrequencyDays === 0;
                }
                default:
                    return false;
            }
        });
    }

    function renderCalendar() {
        calendarView.innerHTML = '';
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        const monthName = calendarDate.toLocaleString('default', { month: 'long' });

        const header = document.createElement('div');
        header.className = 'calendar-header';
        header.innerHTML = `
            <button id="prevMonthBtn" title="Previous Month" class="ctrl-btn">‚Äπ</button>
            <h2>${monthName} ${year}</h2>
            <span style="display: flex; gap: 8px;">
                <button id="printCalendarBtn" title="Print Calendar" class="ctrl-btn">üñ®Ô∏è</button>
                <button id="nextMonthBtn" title="Next Month" class="ctrl-btn">‚Ä∫</button>
            </span>
        `;
        calendarView.appendChild(header);

        const grid = document.createElement('div');
        grid.className = 'calendar-grid-container';
        const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        grid.innerHTML += weekdays.map(day => `<div class="calendar-day-name">${day}</div>`).join('');

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const paydays = getPaydaysForMonth(year, month);
        const today = new Date();
        today.setHours(0,0,0,0);

        for (let i = 0; i < firstDayOfMonth; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-day other-month';
            grid.appendChild(emptyCell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                dayCell.classList.add('today');
            }

            const currentDate = new Date(year, month, day);
            currentDate.setHours(0,0,0,0);

            const allBillsForDay = getBillsForDate(currentDate);
            const oneTimePaidBills = bills.filter(b => b.status === 'paid' && b.frequency === 'One-Time');
            
            const effectiveBills = allBillsForDay.map(bill => {
                if (bill.frequency === 'One-Time') {
                    return { ...bill, displayStatus: bill.status };
                }
                // For recurring bills, check if a corresponding one-time payment was made on this specific day
                const paidInstance = oneTimePaidBills.find(p => {
                    const paidDate = new Date(p.date + 'T00:00:00');
                    return p.name === bill.name && p.amount === bill.amount && paidDate.getTime() === currentDate.getTime();
                });
                return { ...bill, displayStatus: paidInstance ? 'paid' : bill.status };
            });

            // The bubble should only show for bills that are not yet paid.
            const unpaidBillsOnDay = effectiveBills.filter(b => b.displayStatus !== 'paid');

            const dayNumberHTML = `<div class="day-number">${day}</div>`;
            let balanceHTML = '';
            const dailyTotal = effectiveBills.reduce((sum, bill) => {
                return (bill.displayStatus !== 'paid') ? sum + getUserShare(bill) : sum;
            }, 0);

            if (dailyTotal > 0) {
                balanceHTML = `<div class="day-balance negative">${formatCurrency(dailyTotal)}</div>`;
            }

            let billsHTML = '';
            // Use the count of all effective bills for the bubble, so paid items are included in the count
            if (paydays.includes(day)) {
                billsHTML = `<div class="day-bill-count" style="width: 20px; height: 20px; font-size: 14px;">üí∞</div>`;
            } else if (effectiveBills.length > 0) {
                billsHTML = `<div class="day-bill-count">${effectiveBills.length}</div>`;
            }

            dayCell.innerHTML = `
                ${dayNumberHTML}
                <div class="bills-on-day">${billsHTML}</div>
                <div class="day-balance-container">${balanceHTML}</div>
            `;
            grid.appendChild(dayCell);
        }
        calendarView.appendChild(grid);
    }
    function renderPendingBills() {
        pendingBillsList.innerHTML = '';
        const pending = bills.filter(b => b.status === 'pending')
                               .sort((a, b) => new Date(a.date) - new Date(b.date));

        if (pending.length === 0) {
            pendingBillsList.innerHTML = '<p style="font-size:12px; color: var(--muted); text-align:center; margin-top:10px;">No pending bills.</p>';
            return;
        }

        pending.forEach(bill => {
            const item = document.createElement('div');
            item.className = 'upcoming-item';
            item.innerHTML = `
                <div class="name">${bill.name}</div>
                <div class="details">
                    <div class="amount">${formatCurrency(getUserShare(bill))}</div>
                    <div class="countdown">${getCountdown(bill.date)}</div>
                </div>
            `;
            pendingBillsList.appendChild(item);
        });
    }
    function renderNext30Days() {
        next30DaysList.innerHTML = '';
        const today = new Date();
        today.setHours(0,0,0,0);
        const thirtyDaysFromNow = new Date();
        thirtyDaysFromNow.setDate(today.getDate() + 30);

        const next30 = bills.filter(b => {
            const billDate = new Date(b.date + 'T00:00:00');
            return b.status !== 'paid' && billDate >= today && billDate <= thirtyDaysFromNow;
        }).sort((a, b) => new Date(a.date) - new Date(b.date));

        if (next30.length === 0) {
            next30DaysList.innerHTML = '<p style="font-size:12px; color: var(--muted); text-align:center; margin-top:10px;">No bills due in the next 30 days.</p>';
            return;
        }

        next30.forEach(bill => {
            const item = document.createElement('div');
            item.className = 'upcoming-item';
            item.innerHTML = `
                <div class="name">${bill.name}</div>
                <div class="details">
                    <div class="amount">${formatCurrency(getUserShare(bill))}</div>
                    <div class="countdown">${getCountdown(bill.date)}</div>
                </div>
            `;
            next30DaysList.appendChild(item);
        });
    }
    function renderTheTab() {
        debtList.innerHTML = '';
        const sortedDebts = [...debts].sort((a, b) => (a.status === 'satisfied' ? 1 : -1) || new Date(b.date) - new Date(a.date));

        if (sortedDebts.length === 0) {
            debtList.innerHTML = '<p style="font-size:12px; color: var(--muted); text-align:center; margin-top:10px;">No outstanding debts owed to you.</p>';
            return;
        }

        sortedDebts.forEach(debt => {
            const item = document.createElement('div');
            item.className = 'debt-item';
            item.dataset.id = debt.id;
            
            const paidAmount = debt.paidAmount || 0;
            const remainingAmount = debt.amount - paidAmount;
            
            if (remainingAmount <= 0) {
                debt.status = 'satisfied';
            }

            if (debt.status === 'satisfied') {
                item.classList.add('satisfied');
            }

            const payBtn = debt.status !== 'satisfied'
                ? `<button class="pay-btn make-payment-btn" title="Make Payment">Pay</button>`
                : '';

            const amountText = debt.status === 'satisfied' 
                ? `Paid: ${formatCurrency(debt.amount)}` 
                : `Remaining: ${formatCurrency(remainingAmount)} of ${formatCurrency(debt.amount)}`;

            item.innerHTML = `
                <div class="debt-details">
                    <span class="debt-name">${debt.name}</span>
                    <span class="debt-subtext">${amountText}</span>
                    <span class="debt-subtext">On ${debt.date} - ${debt.notes || 'No notes'}</span>
                </div>
                <div class="debt-actions">
                    ${payBtn}
                    <button class="remove-btn dismiss-debt-btn" title="Dismiss Debt">‚úñ</button>
                </div>
            `;
            debtList.appendChild(item);
        });
    }
    function updateSummary() {
        const balance = parseFloat(currentBalance.value) || 0;
        const pendingTotal = bills.filter(b => b.status === 'pending').reduce((sum, bill) => sum + getUserShare(bill), 0);
        const availableBalance = balance - pendingTotal;

        $('totalAmountLabel').textContent = 'Available Balance';
        totalAmountEl.textContent = formatCurrency(availableBalance);

        const actualBalanceEl = $('actualBalance');
        if (pendingTotal > 0) {
            actualBalanceEl.textContent = `Actual: ${formatCurrency(balance)}`;
            actualBalanceEl.style.display = 'block';
        } else {
            actualBalanceEl.style.display = 'none';
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tenDaysFromNow = new Date();
        tenDaysFromNow.setDate(today.getDate() + 10);

        const dueInNext10Days = bills.filter(b => {
            const billDate = new Date(b.date + 'T00:00:00');
            return b.status === 'unpaid' && billDate >= today && billDate <= tenDaysFromNow;
        });

        const totalDue = dueInNext10Days.reduce((sum, bill) => sum + getUserShare(bill), 0);
        totalDueNext10DaysEl.textContent = formatCurrency(totalDue);

        // Projected balance calculation
        const projectedBalanceEl = $('projected10Day');
        const paydaysIn10Days = getPaydaysInRange(today, tenDaysFromNow);
        const incomeIn10Days = paydaysIn10Days.length * (parseFloat(paycheckAmount.value) || 0);
        const projectedBalance = availableBalance - totalDue + incomeIn10Days;
        projectedBalanceEl.textContent = `Est. balance after 10 days: ${formatCurrency(projectedBalance)}`;
        projectedBalanceEl.style.display = 'block';
    }

    // --- MODAL & EDITING ---
    function resolveModal(value) {
        if (activeModalResolve) {
            let returnValue = value;
            const input = $('modal-input');
            if (input) {
                returnValue = (value !== 'cancel') ? input.value : 'cancel';
            }
            activeModalResolve(returnValue);
            activeModalResolve = null;
        }
        genericModal.classList.remove('visible');
    }

    function showModal({ title, text, customHTML = '', buttons = [] }) {
        genericModalTitle.textContent = title;

        if (customHTML) {
            genericModalContent.innerHTML = customHTML;
        } else {
            genericModalContent.innerHTML = `<p id="genericModalText" style="line-height: 1.5; margin: 16px 0; white-space: pre-wrap;">${text}</p>`;
        }

        genericModalButtons.innerHTML = '';
        buttons.forEach(btnInfo => {
            const button = document.createElement('button');
            button.textContent = btnInfo.text;
            button.className = btnInfo.class || 'save-btn';
            button.addEventListener('click', () => resolveModal(btnInfo.value));
            genericModalButtons.appendChild(button);
        });

        genericModal.classList.add('visible');
        const input = $('modal-input');
        if (input) {
            input.focus();
        }

        return new Promise(resolve => {
            activeModalResolve = resolve;
        });
    }

    function openEditModal(billId) {
        const bill = bills.find(b => b.id === billId);
        if (!bill) return;
        $('editModalTitle').textContent = 'Edit Bill'; // Set title for clarity
        editModal.dataset.editingId = billId;
        $('editBillName').value = bill.name;
        $('editBillAmount').value = bill.amount;
        $('editBillDate').value = bill.date;
        $('editBillCategory').innerHTML = $('billCategory').innerHTML;
        $('editBillCategory').value = bill.category;
        $('editBillFrequency').innerHTML = $('billFrequency').innerHTML;
        $('editBillFrequency').value = bill.frequency;
        $('editCustomFrequencyWrapper').style.display = bill.frequency === 'Custom' ? 'grid' : 'none';
        $('editBillCustomFrequency').value = bill.customFrequencyDays || '';
        $('editBillNotes').value = bill.notes || '';
        editSplitBillInputs.style.display = 'block';
        $('editBillSplitName').value = bill.splitWithName || '';
        $('editBillSplitAmount').value = bill.splitWithAmount || '';
        editModal.classList.add('visible');
    }
    function closeEditModal() { editModal.classList.remove('visible'); }
    function handleSaveEdit() {
        const billId = Number(editModal.dataset.editingId);
        const bill = bills.find(b => b.id === billId);
        if (!bill) return;
        bill.name = $('editBillName').value.trim();
        bill.amount = parseFloat($('editBillAmount').value) || 0;
        bill.date = $('editBillDate').value;
        bill.category = $('editBillCategory').value;
        bill.frequency = $('editBillFrequency').value;
        if (bill.frequency === 'Custom') {
            bill.customFrequencyDays = parseInt($('editBillCustomFrequency').value, 10) || 0;
        } else {
            delete bill.customFrequencyDays;
        }
        bill.notes = $('editBillNotes').value.trim();
        const splitName = $('editBillSplitName').value.trim();
        const splitAmount = parseFloat($('editBillSplitAmount').value) || 0;
        if (splitName && splitAmount > 0) {
            bill.isSplit = true;
            bill.splitWithName = splitName;
            bill.splitWithAmount = splitAmount;
        } else {
            bill.isSplit = false;
            bill.splitWithName = '';
            bill.splitWithAmount = 0;
        }
        saveData();
        renderApp(true);
        closeEditModal();
    }

    function showDayBreakdown(date) {
        const dayBreakdownModal = $('dayBreakdownModal');
        const dayBreakdownTitle = $('dayBreakdownTitle');
        const dayBreakdownContent = $('dayBreakdownContent');
        dayBreakdownTitle.textContent = `Breakdown for ${date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;

        // This logic correctly determines the effective list of bills for the day
        const allBillsForDay = getBillsForDate(date);
        
        // Find all one-time paid bills that could correspond to a recurring bill on this day
        const oneTimePaidBills = bills.filter(b => b.status === 'paid' && b.frequency === 'One-Time');
        
        const effectiveBills = allBillsForDay.map(bill => {
            if (bill.frequency === 'One-Time') {
                return { ...bill, displayStatus: bill.status };
            }
            // For recurring bills, check if a corresponding one-time payment was made on this specific day
            const paidInstance = oneTimePaidBills.find(p => {
                const paidDate = new Date(p.date + 'T00:00:00');
                return p.name === bill.name && p.amount === bill.amount && paidDate.getTime() === date.getTime();
            });
            return { ...bill, displayStatus: paidInstance ? 'paid' : bill.status };
        });

        const paydaysOnDay = getPaydaysForMonth(date.getFullYear(), date.getMonth()).includes(date.getDate());
        let contentHTML = '<h3>Bills & Expenses</h3>';

        if (effectiveBills.length > 0) {
            contentHTML += '<ul class="day-breakdown-list">';
            effectiveBills.sort((a,b) => a.name.localeCompare(b.name)).forEach(bill => {
                const isExpense = bill.category === 'Expense';
                let statusClass = bill.displayStatus.toLowerCase();
                if (isExpense && statusClass === 'paid') { statusClass = 'expense'; }

                let actionId = bill.id;
                if (bill.displayStatus === 'paid' && bill.frequency !== 'One-Time') {
                    // This is a paid recurring bill. Find the actual paid instance to get its ID for the 'unpay' action.
                    const oneTimePaidBills = bills.filter(b => b.status === 'paid' && b.frequency === 'One-Time');
                    const paidInstance = oneTimePaidBills.find(p => {
                        const paidDate = new Date(p.date + 'T00:00:00');
                        // `date` is from the outer scope of showDayBreakdown
                        return p.name === bill.name && p.amount === bill.amount && paidDate.getTime() === date.getTime();
                    });
                    if (paidInstance) {
                        actionId = paidInstance.id;
                    }
                }

                let actionsHTML = '<div class="modal-bill-actions">';
                if (!isExpense) {
                    actionsHTML += `<button class="details-btn" data-bill-id="${actionId}">Details</button>`;
                }
                actionsHTML += '</div>';

                contentHTML += `
                    <li data-bill-id="${bill.id}">
                        <span class="modal-bill-details">
                            <span class="status-indicator status-${statusClass}"></span>
                            <div>
                                <span>${bill.name}</span>
                                <small style="display: block; color: var(--muted); text-transform: capitalize;">Status: ${bill.displayStatus}</small>
                            </div>
                        </span>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="modal-bill-amount">${formatCurrency(getUserShare(bill))}</span>
                            ${actionsHTML}
                        </div>
                    </li>`;
            });
            contentHTML += '</ul>';
        } else {
            contentHTML += '<p>No bills or expenses on this day.</p>';
        }

        contentHTML += '<h3>Income</h3>';
        if (paydaysOnDay && paycheckAmount.value > 0) {
            contentHTML += '<ul class="day-breakdown-list">';
            contentHTML += `<li><span class="modal-bill-details"><span class="status-indicator status-income"></span>Paycheck</span><span class="modal-bill-amount">${formatCurrency(parseFloat(paycheckAmount.value))}</span></li>`;
            contentHTML += '</ul>';
        } else {
            contentHTML += '<p>No income on this day.</p>';
        }
        dayBreakdownContent.innerHTML = contentHTML;
        dayBreakdownModal.classList.add('visible');
    }

    function closeDayBreakdownModal() {
        $('dayBreakdownModal').classList.remove('visible');
    }

    // --- APPEARANCE & ANIMATIONS ---
    function applyLayoutMode() {
        const wasMobile = document.body.classList.contains('mobile-view');
        const isMobile = window.innerWidth <= 768;

        if (wasMobile !== isMobile) {
            document.body.classList.toggle('mobile-view', isMobile);

            const addButtonText = addBillBtnHeader.querySelector('.add-bill-text');
            const financeCard = $('financeCard');
            const pastBillsCard = $('pastBillsCard'); 

            if (isMobile) {
                if (addButtonText) addButtonText.textContent = 'Bill / Expense';
            } else {
                financeCard.setAttribute('open', '');
                pastBillsCard.removeAttribute('open'); // Ensure it starts closed on desktop too
                if (addButtonText) addButtonText.textContent = 'Add Bill';
            }
            // The logic for opening/closing the current bills card is now universal
            if (disableAutoOpenCurrentBills.checked) {
                billTrackerCard.removeAttribute('open');
            } else {
                billTrackerCard.setAttribute('open', '');
            }
            // Re-render lists after layout change to apply correct template
            renderLists(true);
        }

        if (!isAnimationRunning) {
            isAnimationRunning = true;
            requestAnimationFrame(mainLoop);
        }
    }

    function applyTheTab() {
        theTabRow.style.display = enableTheTab.checked ? '' : 'none';
        if (enableTheTab.checked) {
            renderTheTab();
        }
    }

    function applyAllAppearance() {
        applyMaterialStyle();
        applyGlassEffect();
        applyCornerRadius();
        applyGlassShadow();
        applySlideSpeed();
        updateWallpaper();
        applyAmbianceSettings();
        applyTheTab();
        applyLayoutMode();
    }
    function populateStyleSelector() {
        uiStyleSelect.innerHTML = '';
        for (const key in materialPresets.glass.styles) {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = materialPresets.glass.styles[key].name;
            uiStyleSelect.appendChild(option);
        }
    }
    function applyMaterialStyle() {
        const isDark = document.documentElement.classList.contains('dark');
        const selectedStyle = uiStyleSelect.value || 'twilight';
        if(materialPresets.glass.styles[selectedStyle]){
            const tint = materialPresets.glass.styles[selectedStyle][isDark ? 'dark' : 'light'];
            document.documentElement.style.setProperty('--glass-tint', tint);
        }
    }
    function applyGlassEffect() {
        const opacity = glassOpacity.value / 100;
        const blur = glassBlurSlider.value;
        document.documentElement.style.setProperty('--glass-alpha', opacity);

        // When opacity is 100%, neutralize backdrop-filter to prevent "see-through" effect
        if (parseInt(glassOpacity.value, 10) >= 100) {
            document.documentElement.style.setProperty('--glass-backdrop-blur', '0px');
            document.documentElement.style.setProperty('--glass-backdrop-sat', '100%');
        } else {
            // Restore user-defined blur and default saturation for the glass effect
            document.documentElement.style.setProperty('--glass-backdrop-blur', `${blur}px`);
            document.documentElement.style.setProperty('--glass-backdrop-sat', '150%');
        }

        $('glassOpacityPct').textContent = `${glassOpacity.value}%`;
        $('glassBlurPct').textContent = `${blur}px`;
    }
    function applyCornerRadius() {
        const radius = cornerRadiusSlider.value;
        document.documentElement.style.setProperty('--border-radius', `${radius}px`);
        $('cornerRadiusPct').textContent = `${radius}px`;
    }
    function applyGlassShadow() {
        const value = glassShadowSlider.value;
        const isDark = document.documentElement.classList.contains('dark');
        const blur = isDark ? 20 + (value / 100) * 60 : 10 + (value / 100) * 40;
        const alpha = isDark ? 0.2 + (value / 100) * 0.4 : 0.08 + (value / 100) * 0.2;
        document.documentElement.style.setProperty('--glass-shadow-blur', `${blur}px`);
        document.documentElement.style.setProperty('--glass-shadow-alpha', alpha.toFixed(3));
        const cue = $('shadowCue');
        const yOffset = isDark ? 18 : 8;
        cue.style.boxShadow = `0 ${yOffset}px ${blur}px rgba(0,0,0,${alpha})`;
    }

    function updateWallpaper() {
        customBackgroundOptions.style.display = enableCustomBackground.checked ? 'block' : 'none';
        if (!enableCustomBackground.checked) { document.body.style.backgroundImage = ''; return; }
        const type = backgroundType.value;
        $('imageWallpaperControls').style.display = type === 'image' ? 'block' : 'none';
        $('colorWallpaperControls').style.display = type === 'color' ? 'block' : 'none';
        gradientSpinControls.style.display = gradientSpinToggle.checked ? 'flex' : 'none';
        if (type === 'image') {
            const wallpaper = localStorage.getItem('summitForecast.wallpaper');
            document.body.style.backgroundImage = wallpaper ? `url(${wallpaper})` : '';
        } else if (type === 'color') {
            document.body.style.backgroundImage = `linear-gradient(${gradientAngle.value}deg, ${wallpaperColor3.value}, ${wallpaperColor2.value})`;
        } else {
            document.body.style.backgroundImage = '';
        }
    }
    const applySlideSpeed = () => {
        $('slideSpeedPct').textContent = `${slideSpeed.value} px/s`;
    };
    function animateEnter(tr){ 
        if(!enableNaturalSlide.checked) return; 
        const speed = parseFloat(slideSpeed.value) || 1000;
        const duration = (tr.offsetHeight / speed) * 1000;
        document.documentElement.style.setProperty('--slide-duration', `${duration}ms`);
        tr.classList.add('slide-enter'); 
        requestAnimationFrame(() => { 
            tr.classList.add('slide-enter-active'); 
            setTimeout(() => tr.classList.remove('slide-enter','slide-enter-active'), duration); 
        }); 
    }
    function animateRemove(tr, callback){ 
        if(!enableNaturalSlide.checked){ tr.remove(); callback(); return; } 
        const speed = parseFloat(slideSpeed.value) || 1000;
        const duration = (tr.offsetHeight / speed) * 1000;
        document.documentElement.style.setProperty('--slide-duration', `${duration}ms`);
        tr.style.height = `${tr.offsetHeight}px`; 
        tr.classList.add('slide-out'); 
        requestAnimationFrame(() => { 
            tr.classList.add('collapsing'); 
        }); 
        setTimeout(() => { 
            if(tr.parentNode) { tr.remove(); } 
            callback(); 
        }, duration);
    }

    function applyAmbianceSettings() {
        ambianceSettings.style.display = enableAmbiance.checked ? 'block' : 'none';
        ambianceControls.style.display = enableAmbiance.checked && ambianceSelect.value !== 'none' ? 'block' : 'none';
        ['snowControls', 'orbsControls', 'starfieldControls'].forEach(c => $(c).style.display = 'none');
        ambianceParticles = [];
        ctxAmbiance.clearRect(0, 0, ambianceCanvas.width, ambianceCanvas.height);
        if (enableAmbiance.checked) {
            const effect = ambianceSelect.value;
            if (effect === 'none') return;
            $(effect + 'Controls').style.display = 'block';
            let density = 100;
            if (effect === 'snowflakes') density = snowDensity.value;
            else if (effect === 'orbs') density = orbsDensity.value;
            else if (effect === 'starfield') density = starfieldDensity.value;
            for (let i = 0; i < density; i++) {
                if (effect === 'snowflakes') ambianceParticles.push(createSnowflake(true));
                else if (effect === 'orbs') ambianceParticles.push(createOrb(true));
                else if (effect === 'starfield') ambianceParticles.push(createStar(true));
            }
        }
    }

    function createSnowflake(isInitial = false) {
        const size = (Math.random() * (snowSize.value / 10) + 1);
        return { x: Math.random() * ambianceCanvas.width, y: isInitial ? Math.random() * ambianceCanvas.height : -size, size: size, speed: (Math.random() * (snowSpeed.value / 20) + 0.5), opacity: Math.random() * 0.5 + 0.3, update: function() { this.y += this.speed; this.x += Math.sin(this.y/50)*0.5; }, draw: function() { ctxAmbiance.fillStyle = `rgba(255, 255, 255, ${this.opacity})`; ctxAmbiance.beginPath(); ctxAmbiance.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctxAmbiance.fill(); }, isOutOfBounds: function() { return this.y > ambianceCanvas.height + this.size; } };
    }

    function createOrb(isInitial = false) {
        const size = Math.random() * (orbsSize.value / 10) + 5;
        return { x: Math.random() * ambianceCanvas.width, y: isInitial ? Math.random() * ambianceCanvas.height : ambianceCanvas.height + size, size: size, speed: (Math.random() * (orbsSpeed.value / 20) + 0.1), color: orbsColor.value, update: function() { this.y -= this.speed; }, draw: function() { ctxAmbiance.fillStyle = this.color; ctxAmbiance.globalAlpha = 0.5; ctxAmbiance.beginPath(); ctxAmbiance.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctxAmbiance.fill(); ctxAmbiance.globalAlpha = 1; }, isOutOfBounds: function() { return this.y < -this.size; } };
    }

    function createStar(isInitial = false) {
        return { x: Math.random() * ambianceCanvas.width, y: isInitial ? Math.random() * ambianceCanvas.height: 0, size: Math.random() * 1.5 + 0.5, speed: (Math.random() * (starfieldSpeed.value / 10) + 0.1), update: function() { this.y += this.speed; if (this.y > ambianceCanvas.height) {this.y = 0; this.x = Math.random() * ambianceCanvas.width;} }, draw: function() { ctxAmbiance.fillStyle = 'rgba(255, 255, 255, 0.8)'; ctxAmbiance.fillRect(this.x, this.y, this.size, this.size); }, isOutOfBounds: function() { return false; } };
    }

    function mainLoop() {
        if (!isAnimationRunning) return;

        if (gradientSpinToggle.checked && enableCustomBackground.checked && backgroundType.value === 'color') {
            const currentAngle = parseFloat(gradientAngle.value);
            gradientAnimationAngle = (gradientAnimationAngle + (parseFloat(gradientSpinSpeed.value) / 200)) % 360;
            document.body.style.backgroundImage = `linear-gradient(${currentAngle + gradientAnimationAngle}deg, ${wallpaperColor3.value}, ${wallpaperColor2.value})`;
        }

        if (enableAmbiance.checked && ambianceSelect.value !== 'none') {
            ctxAmbiance.clearRect(0, 0, ambianceCanvas.width, ambianceCanvas.height);
            ambianceParticles.forEach((p, index) => {
                p.update();
                p.draw();
                if (p.isOutOfBounds()) ambianceParticles.splice(index, 1);
            });
            const effect = ambianceSelect.value;
            let targetDensity = 0;
            if (effect === 'snowflakes') targetDensity = snowDensity.value;
            else if (effect === 'orbs') targetDensity = orbsDensity.value;
            else if (effect === 'starfield') targetDensity = starfieldDensity.value;
            if (ambianceParticles.length < targetDensity) {
                 if (effect === 'snowflakes') ambianceParticles.push(createSnowflake());
                 else if (effect === 'orbs') ambianceParticles.push(createOrb());
            }
        } else if (ambianceParticles.length > 0) {
            ambianceParticles = [];
            ctxAmbiance.clearRect(0, 0, ambianceCanvas.width, ambianceCanvas.height);
        }
        requestAnimationFrame(mainLoop);
    }

    // --- EVENT HANDLERS ---
    const handleAddBill = async () => {
        const name = $('billName').value.trim();
        if (!name) {
            await showModal({ title: 'Missing Information', text: 'Please enter at least a bill name.', buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]});
            return;
        }
        const amount = parseFloat($('billAmount').value) || 0;
        const date = $('billDate').value || new Date().toISOString().split('T')[0];
        const newBill = { id: Date.now(), name, amount, date, category: $('billCategory').value, frequency: $('billFrequency').value, notes: $('billNotes').value.trim(), status: 'unpaid', isSplit: false, justAdded: true };
        if (newBill.frequency === 'Custom') {
            newBill.customFrequencyDays = parseInt($('billCustomFrequency').value, 10) || 0;
        }
        const splitName = $('billSplitName').value.trim();
        const splitAmount = parseFloat($('billSplitAmount').value);
        if (splitName && splitAmount > 0) {
            newBill.isSplit = true; newBill.splitWithName = splitName; newBill.splitWithAmount = splitAmount;
            if (newBill.splitWithAmount >= amount && amount > 0) {
                await showModal({ title: 'Invalid Split', text: "The other person's share cannot be greater than or equal to the total amount.", buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]});
                return;
            }
        }
        bills.push(newBill); addBillForm.reset(); $('billDate').value = new Date().toISOString().split('T')[0];
        addBillModal.classList.remove('visible');
        saveData(); renderApp();
    };

    const handleAddExpense = (desc, amount, modalToClose = null) => {
        if (desc && amount > 0) {
            const newExpenseAsBill = { id: Date.now(), name: desc, amount: amount, date: new Date().toISOString().split('T')[0], category: 'Expense', frequency: 'One-Time', notes: 'Logged as a one-time expense.', status: 'paid', isSplit: false, justAdded: true, paidTimestamp: new Date().toISOString() };
            bills.push(newExpenseAsBill);
            if (!dontAutoDeduct.checked) {
                const currentBalanceVal = parseFloat(currentBalance.value) || 0;
                currentBalance.value = (currentBalanceVal - amount).toFixed(2);
            }
            saveData(); renderApp();
            expenseForm.reset();
            toggleExpenseView(false);

            if (modalToClose) {
                modalToClose.classList.remove('visible');
            }
        }
    };

    const handleCustomExpenseSubmit = (e) => { e.preventDefault(); const desc = $('expenseDescription').value.trim(); const amount = parseFloat($('expenseAmount').value); handleAddExpense(desc, amount); };
    const handleQuickExpense = async (e) => {
        const expenseType = e.target.closest('.quick-expense-btn').dataset.expense;
        const result = await showModal({
            title: `Log Expense: ${expenseType}`,
            customHTML: `<label for="modal-input" style="font-size: 14px; color: var(--muted);">Enter Amount:</label><input type="number" id="modal-input" placeholder="0.00" step="0.01" required>`,
            buttons: [
                { text: 'Log Expense', value: 'log', class: 'save-btn' },
                { text: 'Cancel', value: 'cancel', class: 'cancel-btn' },
            ]
        });

        const amount = parseFloat(result);
        if (result !== 'cancel' && amount > 0) {
            const modalToClose = e.target.closest('.modal-overlay');
            handleAddExpense(expenseType, amount, modalToClose);
        }
    };
    const toggleExpenseView = (showCustom, isModal = false) => {
        const quickOpts = isModal ? $('expenseModalQuickOptions') : $('expenseQuickOptions');
        const form = isModal ? $('expenseModalForm') : $('expenseForm');
        quickOpts.style.display = showCustom ? 'none' : 'grid';
        form.style.display = showCustom ? 'flex' : 'none';
    };

    const handleListClick = async (e) => {
        const tr = e.target.closest('tr'); if (!tr) return;
        const billId = Number(tr.dataset.id);
        const bill = bills.find(b => b.id === billId);
        if (!bill) return;
        const target = e.target;

        if (target.matches('.details-btn')) {
            openEditModal(billId);
            return;
        }

        if (target.matches('.pay-btn')) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = new Date(bill.date + 'T00:00:00');
            const diffDays = Math.round((dueDate.getTime() - today.getTime()) / 864e5);
            if (diffDays > 10) {
                await showModal({ title: 'Notice', text: 'Bills cannot be marked as paid more than 10 days in advance.', buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]});
                return;
            }
            const oldStatus = bill.status;
            const isRecurring = bill.frequency !== 'One-Time';
            const paidTimestamp = new Date().toISOString();

            if (!isRecurring) {
                bill.status = 'paid';
                bill.paidTimestamp = paidTimestamp;
            } else {
                const paidInstance = { ...bill, id: Date.now(), status: 'paid', frequency: 'One-Time', notes: bill.notes || 'Recurring payment.', paidTimestamp: paidTimestamp };
                bills.push(paidInstance);
                const nextDueDate = new Date(bill.date + 'T00:00:00');
                if (bill.frequency === 'Weekly') nextDueDate.setDate(nextDueDate.getDate() + 7);
                else if (bill.frequency === 'Bi-Weekly') nextDueDate.setDate(nextDueDate.getDate() + 14);
                else if (bill.frequency === 'Monthly') nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                else if (bill.frequency === 'Quarterly') nextDueDate.setMonth(nextDueDate.getMonth() + 3);
                else if (bill.frequency === 'Annually') nextDueDate.setFullYear(nextDueDate.getFullYear() + 1);
                else if (bill.frequency === 'Custom' && bill.customFrequencyDays > 0) {
                    nextDueDate.setDate(nextDueDate.getDate() + bill.customFrequencyDays);
                }
                bill.date = nextDueDate.toISOString().split('T')[0];
                bill.status = 'unpaid';
            }
            if (!dontAutoDeduct.checked && oldStatus !== 'paid') {
                const share = getUserShare(bill);
                currentBalance.value = ((parseFloat(currentBalance.value) || 0) - share).toFixed(2);
            }
            saveData(); renderApp(true);
        } else if (target.matches('.pending-btn')) {
            bill.status = 'pending'; saveData(); renderApp(true);
        } else if (target.matches('.unpay-btn')) {
            if (bill.status === 'pending') { bill.status = 'unpaid'; saveData(); renderApp(true); return; }
            const share = getUserShare(bill);
            const choice = await showModal({
                title: 'Confirm Un-Pay',
                text: `This will delete the payment record for "${bill.name}" and add ${formatCurrency(share)} back to your balance (if auto-deduct is enabled). Are you sure?`,
                buttons: [
                    { text: 'Yes, Un-Pay', value: 'confirm', class: 'danger-btn' },
                    { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
                ]
            });

            if (choice === 'confirm') {
                if (!dontAutoDeduct.checked) {
                    currentBalance.value = ((parseFloat(currentBalance.value) || 0) + share).toFixed(2);
                }
                animateRemove(tr, () => { bills = bills.filter(b => b.id !== billId); saveData(); renderApp(true); });
            }
        } else if (target.matches('.remove-btn')) {
            const choice = await showModal({
                title: `Manage "${bill.name}"`,
                text: `Delete this bill permanently (including future occurrences), or just dismiss this single occurrence without affecting your balance?`,
                buttons: [
                    { text: 'Delete Bill', value: 'delete', class: 'danger-btn' },
                    { text: 'Dismiss Bill', value: 'dismiss', class: 'special-btn' },
                    { text: 'Cancel', value: 'cancel', class: 'cancel-btn' },
                ]
            });

            if (choice === 'delete') {
                animateRemove(tr, () => {
                    bills = bills.filter(b => b.id !== billId);
                    saveData();
                    renderApp(true);
                });
            } else if (choice === 'dismiss') {
                const isRecurring = bill.frequency === 'Monthly' || bill.frequency === 'Quarterly' || bill.frequency === 'Annually';
                const paidTimestamp = new Date().toISOString();
                if (!isRecurring) {
                    bill.status = 'paid';
                    bill.paidTimestamp = paidTimestamp;
                } else {
                    const dismissedInstance = { ...bill, id: Date.now(), status: 'paid', frequency: 'One-Time', notes: `Dismissed for this cycle.`, paidTimestamp: paidTimestamp };
                    bills.push(dismissedInstance);
                    const nextDueDate = new Date(bill.date + 'T00:00:00');
                    if (bill.frequency === 'Monthly') nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                    else if (bill.frequency === 'Quarterly') nextDueDate.setMonth(nextDueDate.getMonth() + 3);
                    else if (bill.frequency === 'Annually') nextDueDate.setFullYear(nextDueDate.getFullYear() + 1);
                    bill.date = nextDueDate.toISOString().split('T')[0];
                }
                saveData();
                renderApp(true);
            }
        }
    };

    const handleModalActionClick = async (e) => {
        const target = e.target.closest('.modal-bill-actions button');
        if (!target) return;

        const billId = Number(target.dataset.billId);
        const bill = bills.find(b => b.id === billId);
        if (!bill) return;

        if (target.matches('.details-btn')) {
            closeDayBreakdownModal();
            openEditModal(billId);
            return;
        }

        if (target.matches('.pay-btn')) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dueDate = new Date(bill.date + 'T00:00:00');
            const diffDays = Math.round((dueDate.getTime() - today.getTime()) / 864e5);
            if (diffDays > 10) {
                await showModal({ title: 'Notice', text: 'Bills cannot be marked as paid more than 10 days in advance.', buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]});
                return;
            }
            const oldStatus = bill.status;
            const isRecurring = bill.frequency !== 'One-Time';
            const paidTimestamp = new Date().toISOString();

            if (!isRecurring) {
                bill.status = 'paid';
                bill.paidTimestamp = paidTimestamp;
            } else {
                const paidInstance = { ...bill, id: Date.now(), status: 'paid', frequency: 'One-Time', notes: bill.notes || 'Recurring payment.', paidTimestamp: paidTimestamp };
                bills.push(paidInstance);
                const nextDueDate = new Date(bill.date + 'T00:00:00');
                if (bill.frequency === 'Weekly') nextDueDate.setDate(nextDueDate.getDate() + 7);
                else if (bill.frequency === 'Bi-Weekly') nextDueDate.setDate(nextDueDate.getDate() + 14);
                else if (bill.frequency === 'Monthly') nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                else if (bill.frequency === 'Quarterly') nextDueDate.setMonth(nextDueDate.getMonth() + 3);
                else if (bill.frequency === 'Annually') nextDueDate.setFullYear(nextDueDate.getFullYear() + 1);
                else if (bill.frequency === 'Custom' && bill.customFrequencyDays > 0) {
                    nextDueDate.setDate(nextDueDate.getDate() + bill.customFrequencyDays);
                }
                bill.date = nextDueDate.toISOString().split('T')[0];
                bill.status = 'unpaid';
            }
            if (!dontAutoDeduct.checked && oldStatus !== 'paid') {
                const share = getUserShare(bill);
                currentBalance.value = ((parseFloat(currentBalance.value) || 0) - share).toFixed(2);
            }
        } else if (target.matches('.pending-btn')) {
            bill.status = 'pending';
        } else if (target.matches('.unpay-btn')) {
            if (bill.status === 'pending') {
                bill.status = 'unpaid';
            } else {
                const share = getUserShare(bill);
                 const choice = await showModal({
                    title: 'Confirm Un-Pay',
                    text: `This will delete the payment record for "${bill.name}" and add ${formatCurrency(share)} back to your balance (if auto-deduct is enabled). Are you sure?`,
                    buttons: [
                        { text: 'Yes, Un-Pay', value: 'confirm', class: 'danger-btn' },
                        { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
                    ]
                });

                if (choice === 'confirm') {
                    if (!dontAutoDeduct.checked) {
                        currentBalance.value = ((parseFloat(currentBalance.value) || 0) + share).toFixed(2);
                    }
                    bills = bills.filter(b => b.id !== billId);
                } else {
                    return; // Do not re-render if cancelled
                }
            }
        }

        saveData();
        closeDayBreakdownModal();
        renderApp(true);
    };

    const handleListDoubleClick = (e) => { const tr = e.target.closest('tr[data-id]'); if (tr && !e.target.closest('.actions-cell, .mobile-bill-actions')) openEditModal(Number(tr.dataset.id)); };
    const handleToggleDarkMode = () => { document.documentElement.classList.toggle('dark'); const isDark = document.documentElement.classList.contains('dark'); darkToggle.innerHTML = isDark ? '‚òÄÔ∏è' : 'üåô'; applyMaterialStyle(); applyGlassShadow(); saveData(); };
    const handleWallpaperFile = async (e) => {
        const file = e.target.files[0];
        if (file && file.size < 5*1024*1024) {
            const reader = new FileReader();
            reader.onload = (e) => {
                localStorage.setItem('summitForecast.wallpaper', e.target.result);
                updateWallpaper();
                saveData();
            };
            reader.readAsDataURL(file);
        } else if (file) {
            await showModal({ title: 'File Too Large', text: 'Please select an image smaller than 5MB.', buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]});
        }
    };
    const handleCalendarNav = (e) => {
        const dayCell = e.target.closest('.calendar-day');
        if (dayCell && !dayCell.classList.contains('other-month')) {
            const day = dayCell.querySelector('.day-number').textContent;
            const date = new Date(calendarDate.getFullYear(), calendarDate.getMonth(), day);
            showDayBreakdown(date); return;
        }
        let reRender = false;
        if (e.target.closest('#prevMonthBtn')) { calendarDate.setMonth(calendarDate.getMonth() - 1); reRender = true; }
        else if (e.target.closest('#nextMonthBtn')) { calendarDate.setMonth(calendarDate.getMonth() + 1); reRender = true; }
        else if (e.target.closest('#printCalendarBtn')) { window.print(); }
        if (reRender) { renderCalendar(); }
    };

    function handleExportProfile() {
        try {
            const profileData = { bills: JSON.parse(localStorage.getItem('summitForecast.bills') || '[]'), debts: JSON.parse(localStorage.getItem('summitForecast.debts') || '[]'), settings: JSON.parse(localStorage.getItem('summitForecast.settings') || '{}'), wallpaper: localStorage.getItem('summitForecast.wallpaper') || null };
            const blob = new Blob([JSON.stringify(profileData, null, 2)], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", "SummitForecast_Profile.json");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) { console.error("Failed to export profile:", error); showModal({ title: 'Error', text: 'Could not export profile.', buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]}); }
    }

    function handleImportProfile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json,.json';
        input.onchange = e => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const profileData = JSON.parse(event.target.result);
                    if (profileData && profileData.bills && profileData.settings) {
                        localStorage.setItem('summitForecast.bills', JSON.stringify(profileData.bills));
                        localStorage.setItem('summitForecast.settings', JSON.stringify(profileData.settings));
                    if (profileData.debts) {
                        localStorage.setItem('summitForecast.debts', JSON.stringify(profileData.debts));
                    }
                        if (profileData.wallpaper) { localStorage.setItem('summitForecast.wallpaper', profileData.wallpaper); }
                        else { localStorage.removeItem('summitForecast.wallpaper'); }
                        await showModal({ title: 'Success', text: 'Profile imported successfully! The application will now reload.', buttons: [{ text: 'Reload', value: 'ok', class: 'save-btn' }]});
                        location.reload();
                    } else {
                        await showModal({ title: 'Error', text: 'Invalid profile file.', buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]});
                    }
                } catch (error) {
                    console.error("Failed to import profile:", error);
                    await showModal({ title: 'Error', text: 'Could not import profile.', buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]});
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    async function handleUnpaidTool() {
        const days = parseInt($('unpaidDays').value, 10);
        if (isNaN(days) || days < 0) {
            await showModal({
                title: 'Invalid Input',
                text: 'Please enter a valid number of days.',
                buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]
            });
            return;
        }

        const confirmRes = await showModal({
            title: 'Confirm Action',
            text: `Are you sure? This will mark ALL bills due after ${days} day(s) from now as 'unpaid'. This includes recurring bills and cannot be easily undone.`,
            buttons: [
                { text: 'Yes, Mark as Unpaid', value: 'confirm', class: 'danger-btn' },
                { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
            ]
        });

        if (confirmRes === 'confirm') {
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() + days);
            targetDate.setHours(0, 0, 0, 0);

            let changes = 0;
            bills.forEach(bill => {
                const billDate = new Date(bill.date + 'T00:00:00');
                if (billDate >= targetDate) {
                    if(bill.status !== 'unpaid') {
                        bill.status = 'unpaid';
                        delete bill.paidTimestamp;
                        changes++;
                    }
                }
            });
            saveData();
            renderApp(true);
            await showModal({
                title: 'Success',
                text: `${changes} bill(s) were marked as unpaid.`,
                buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]
            });
        }
    }

    async function handleResetProfile() {
        const choice = await showModal({
            title: 'Confirm Reset',
            text: 'Are you sure you want to reset EVERYTHING to factory defaults? All bills, financial info, and appearance settings will be permanently deleted.',
            buttons: [
                { text: 'Yes, Reset Everything', value: 'confirm', class: 'danger-btn' },
                { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
            ]
        });

        if (choice === 'confirm') {
            localStorage.removeItem('summitForecast.bills');
            localStorage.removeItem('summitForecast.settings');
            localStorage.removeItem('summitForecast.wallpaper');
            localStorage.removeItem('summitForecast.debts');
            await showModal({ title: 'Profile Reset', text: 'Your profile has been reset. The application will now reload.', buttons: [{ text: 'Reload', value: 'ok', class: 'save-btn' }]});
            location.reload();
        }
    }

    // --- DEMO MODE ---
    function generateDemoProfile() {
        // --- Helpers ---
        const rand = (min, max) => Math.random() * (max - min) + min;
        const randInt = (min, max) => Math.floor(rand(min, max + 1));
        const oneOf = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const toYMD = (date) => date.toISOString().split('T')[0];
        let idCounter = Date.now();

        // --- Config ---
        const demoBills = [];
        const demoDebts = [];
        let demoSettings = {};
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const lookbackStartDate = new Date(today);
        lookbackStartDate.setFullYear(today.getFullYear() - 1);

        // 1. Finances
        const annualSalary = rand(75000, 95000);
        const paycheck = parseFloat((annualSalary / 26).toFixed(2));
        let nextPayday = new Date(today);
        // Find the next Friday. If today is Friday, it's a potential payday.
        nextPayday.setDate(nextPayday.getDate() + (5 - nextPayday.getDay() + 7) % 7);
        if (randInt(0, 1) === 1) { // 50% chance the next payday is one week later
            nextPayday.setDate(nextPayday.getDate() + 7);
        }

        demoSettings.finances = {
            balance: rand(paycheck * 0.8, paycheck * 2.2).toFixed(2),
            paycheck: paycheck,
            payday: toYMD(nextPayday),
            frequency: 'Bi-Weekly'
        };
        demoSettings.theTabEnabled = true;

        // 2. Recurring Bills & Their History
        const recurringBillTemplates = [
            { name: 'Mortgage', amount: rand(1400, 1800), day: 1, category: 'Rent/Mortgage', frequency: 'Monthly' },
            { name: 'Car Payment', amount: rand(450, 600), day: 15, category: 'Loan', frequency: 'Monthly' },
            { name: 'Car Insurance', amount: rand(100, 180), day: 20, category: 'Insurance', frequency: 'Monthly' },
            { name: 'Wisconsin Public Service', amount: rand(80, 250), day: randInt(5, 25), category: 'Utilities', frequency: 'Monthly' },
            { name: 'Spectrum Internet', amount: rand(80, 100), day: randInt(5, 25), category: 'Utilities', frequency: 'Monthly' },
            { name: 'Green Bay Water Utility', amount: rand(50, 90), day: randInt(5, 25), category: 'Utilities', frequency: 'Quarterly' },
            { name: 'AT&T Cell Phone', amount: rand(80, 130), day: randInt(5, 25), category: 'Subscription', frequency: 'Monthly' },
            { name: 'Netflix/Hulu Bundle', amount: rand(25, 45), day: randInt(5, 25), category: 'Subscription', frequency: 'Monthly' },
            { name: 'Planet Fitness', amount: rand(25, 45), day: randInt(5, 25), category: 'Personal', frequency: 'Monthly' },
        ];

        recurringBillTemplates.forEach(billTmpl => {
            // Find the next due date for this bill
            let nextDueDate = new Date(today);
            nextDueDate.setDate(billTmpl.day);
            if (nextDueDate < today) {
                if (billTmpl.frequency === 'Monthly') {
                    nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                } else if (billTmpl.frequency === 'Quarterly') {
                    nextDueDate.setMonth(nextDueDate.getMonth() + 3);
                }
            }

            // Create the main recurring bill (the one that shows up as upcoming)
            demoBills.push({
                id: idCounter++,
                name: billTmpl.name,
                amount: parseFloat(billTmpl.amount.toFixed(2)),
                date: toYMD(nextDueDate),
                category: billTmpl.category,
                frequency: billTmpl.frequency,
                status: 'unpaid',
                notes: 'Recurring payment'
            });

            // Now, generate the history of 'paid' bills for this recurring item
            let historicalDueDate = new Date(nextDueDate);
            while (historicalDueDate > lookbackStartDate) {
                // Move to the PREVIOUS due date
                if (billTmpl.frequency === 'Monthly') {
                    historicalDueDate.setMonth(historicalDueDate.getMonth() - 1);
                } else if (billTmpl.frequency === 'Quarterly') {
                    historicalDueDate.setMonth(historicalDueDate.getMonth() - 3);
                }

                if (historicalDueDate < lookbackStartDate) break;
                
                // Create a paid, one-time bill for this historical date
                const paidAmount = billTmpl.amount * rand(0.95, 1.05); // slight variation
                demoBills.push({
                    id: idCounter++,
                    name: billTmpl.name, // Same name to link them conceptually
                    amount: parseFloat(paidAmount.toFixed(2)),
                    date: toYMD(historicalDueDate),
                    category: billTmpl.category,
                    frequency: 'One-Time', // Historical entries are always one-time
                    status: 'paid',
                    paidTimestamp: historicalDueDate.toISOString(),
                    notes: 'Recurring payment history'
                });
            }
        });

        // 3. Historical One-Off Paid Expenses (for realism)
        const expenseTemplates = {
            Groceries: { names: ["Woodman's", "Pick 'n Save", "Festival Foods", "Meijer", "Aldi"], amount: [70, 220], perWeek: 1.2 },
            Gas: { names: ["Kwik Trip", "Shell", "BP", "Costco Gas"], amount: [40, 70], perWeek: 1 },
            Food: { names: ["Kroll's East", "Hinterland Brewery", "Chipotle", "Culver's", "Titletown Gameday"], amount: [15, 85], perWeek: 3 },
            Coffee: { names: ["Starbucks", "Colectivo Coffee", "Kwik Trip Coffee"], amount: [4, 12], perWeek: 3 },
            Personal: { names: ["Target", "Amazon Order", "Walmart", "Bay Park Square Mall"], amount: [40, 400], perWeek: 0.5 },
            Entertainment: { names: ["Resch Center Event", "Concert Ticket", "Packers Game", "Lambeau Field Tour"], amount: [50, 300], perWeek: 0.2 }
        };

        for (let d = new Date(lookbackStartDate); d <= today; d.setDate(d.getDate() + 1)) {
            Object.entries(expenseTemplates).forEach(([category, config]) => {
                if (Math.random() < config.perWeek / 7) {
                    const expenseDate = new Date(d);
                    const amount = rand(config.amount[0], config.amount[1]);
                    demoBills.push({
                        id: idCounter++,
                        name: oneOf(config.names),
                        amount: parseFloat(amount.toFixed(2)),
                        date: toYMD(expenseDate),
                        category: category,
                        frequency: 'One-Time',
                        status: 'paid',
                        paidTimestamp: expenseDate.toISOString(),
                        notes: 'One-time expense'
                    });
                }
            });
        }
        
        // 4. "The Tab" Debts
        const friends = ['Aaron', 'Jordy', 'Davante', 'Clay'];
        for(let i=0; i < randInt(2, 4); i++) {
            const debtDate = new Date(today);
            debtDate.setDate(debtDate.getDate() - randInt(1, 45));
            demoDebts.push({
                id: idCounter++,
                name: oneOf(friends),
                amount: randInt(10, 50),
                date: toYMD(debtDate),
                notes: oneOf(['For lunch', 'Concert ticket', 'Drinks at Hinterland']),
                status: 'outstanding',
                paidAmount: 0
            });
        }

        // 5. Save to localStorage
        localStorage.setItem('summitForecast.bills', JSON.stringify(demoBills));
        localStorage.setItem('summitForecast.debts', JSON.stringify(demoDebts));
        const existingSettings = JSON.parse(localStorage.getItem('summitForecast.settings') || '{}');
        const finalSettings = {...existingSettings, ...demoSettings};
        localStorage.setItem('summitForecast.settings', JSON.stringify(finalSettings));
    }


    // --- EVENT HANDLERS ---
    $('billFrequency').addEventListener('change', () => {
        $('customFrequencyWrapper').style.display = $('billFrequency').value === 'Custom' ? 'grid' : 'none';
    });
    $('editBillFrequency').addEventListener('change', () => {
        $('editCustomFrequencyWrapper').style.display = $('editBillFrequency').value === 'Custom' ? 'grid' : 'none';
    });

    // --- EVENT LISTENERS ---
    const privacyToggleBtn = $('privacyToggleBtn');
    if (privacyToggleBtn) {
        privacyToggleBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent the summary from toggling
            e.preventDefault();
            const financeStack = $('financeCard').querySelector('.stack');
            const isBlurred = financeStack.classList.toggle('blurred');
            $('actualBalance').classList.toggle('privacy-blurred', isBlurred);
            $('projected10Day').classList.toggle('privacy-blurred', isBlurred);
            privacyToggleBtn.querySelector('.eye-open').style.display = isBlurred ? 'none' : 'block';
            privacyToggleBtn.querySelector('.eye-closed').style.display = isBlurred ? 'block' : 'none';
            saveData(); // Save the new state
        });
    }
    addBillBtnHeader.addEventListener('click', async () => {
        if (document.body.classList.contains('mobile-view')) {
            const choice = await showModal({
                title: 'What would you like to add?',
                text: '',
                buttons: [
                    { text: 'Add a Bill', value: 'bill', class: 'save-btn' },
                    { text: 'Log an Expense', value: 'expense', class: 'special-btn' },
                    { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
                ]
            });
            if (choice === 'bill') {
                addBillModal.classList.add('visible');
            } else if (choice === 'expense') {
                toggleExpenseView(false, true); // Reset to quick options
                expenseModal.classList.add('visible');
            }
        } else {
            addBillModal.classList.add('visible');
        }
    });
    closeAddBillModalBtn.addEventListener('click', () => addBillModal.classList.remove('visible'));
    archiveBtn.addEventListener('click', () => {
        appView.style.display = 'none';
        archiveView.style.display = 'flex';
        const categories = [...new Set(bills.map(b => b.category))].sort();
        filterCategory.innerHTML = '<option value="">All Categories</option>';
        categories.forEach(c => filterCategory.innerHTML += `<option value="${c}">${c}</option>`);
        renderArchive();
    });
    backFromArchiveBtn.addEventListener('click', () => { archiveView.style.display = 'none'; appView.style.display = 'grid'; });
    addBtn.addEventListener('click', handleAddBill);
    expenseForm.addEventListener('submit', handleCustomExpenseSubmit);
    billListBody.addEventListener('click', handleListClick);
    pastBillsListBody.addEventListener('click', handleListClick);
    archiveBillsListBody.addEventListener('dblclick', async (e) => {
        const tr = e.target.closest('tr[data-id]');
        if (tr) {
            const billId = Number(tr.dataset.id);
            const bill = bills.find(b => b.id === billId);
            if (bill && bill.paidTimestamp) {
                const paidDate = new Date(bill.paidTimestamp);
                const formattedDate = paidDate.toLocaleString([], { dateStyle: 'long', timeStyle: 'short' });
                await showModal({
                    title: `"${bill.name}"`,
                    text: `Marked as Paid on: ${formattedDate}`,
                    buttons: [{ text: 'Close', value: 'close', class: 'cancel-btn' }]
                });
            }
        }
    });
    archiveBillsListBody.addEventListener('click', async (e) => {
        if (e.target.matches('.remove-btn')) {
            const tr = e.target.closest('tr');
            if (!tr) return;
            const billId = Number(tr.dataset.id);
            const bill = bills.find(b => b.id === billId);
            if (!bill) return;

            const choice = await showModal({
                title: 'Confirm Deletion',
                text: `Are you sure you want to permanently delete this paid record for "${bill.name}"? This cannot be undone.`,
                buttons: [
                    { text: 'Delete Record', value: 'delete', class: 'danger-btn' },
                    { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
                ]
            });

            if (choice === 'delete') {
                animateRemove(tr, () => {
                    bills = bills.filter(b => b.id !== billId);
                    saveData();
                    renderArchive();
                });
            }
        }
    });

    [filterSearchTerm, filterStartDate, filterEndDate, filterCategory].forEach(el => {
        el.addEventListener('input', renderArchive);
    });
    clearFiltersBtn.addEventListener('click', () => {
        filterSearchTerm.value = '';
        filterStartDate.value = '';
        filterEndDate.value = '';
        filterCategory.value = '';
        renderArchive();
    });

    $('customExpenseBtn').addEventListener('click', () => toggleExpenseView(true));
    $('cancelCustomExpenseBtn').addEventListener('click', () => toggleExpenseView(false));
    document.querySelectorAll('.quick-expense-btn').forEach(btn => btn.addEventListener('click', handleQuickExpense));

    // Expense Modal Listeners
    $('closeExpenseModalBtn').addEventListener('click', () => expenseModal.classList.remove('visible'));
    $('expenseModal').querySelectorAll('.quick-expense-btn').forEach(btn => btn.addEventListener('click', handleQuickExpense));
    $('customExpenseModalBtn').addEventListener('click', () => toggleExpenseView(true, true));
    $('cancelCustomExpenseModalBtn').addEventListener('click', () => toggleExpenseView(false, true));
    $('expenseModalForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const desc = $('expenseModalDescription').value.trim();
        const amount = parseFloat($('expenseModalAmount').value);
        handleAddExpense(desc, amount, expenseModal);
        $('expenseModalForm').reset();
    });


    billListBody.addEventListener('dblclick', handleListDoubleClick);
    pastBillsListBody.addEventListener('dblclick', handleListDoubleClick);
    saveEditBtn.addEventListener('click', handleSaveEdit);
    closeModalBtn.addEventListener('click', closeEditModal);
    $('closeDayBreakdownModalBtn').addEventListener('click', closeDayBreakdownModal);
    $('dayBreakdownModal').addEventListener('click', handleModalActionClick);
    darkToggle.addEventListener('click', handleToggleDarkMode);
    menuBtn.addEventListener('click', () => { menuPanel.style.display = menuPanel.style.display === 'block' ? 'none' : 'block'; });
    closeMenuNotch.addEventListener('click', () => menuPanel.style.display = 'none');
    calendarToggleBtn.addEventListener('click', () => { currentView = currentView === 'list' ? 'calendar' : 'list'; renderApp(true); });
    calendarView.addEventListener('click', handleCalendarNav);

    // Swipe navigation for calendar on mobile
    function handleSwipeGesture() {
        const swipeThreshold = 50; // minimum distance for a swipe in pixels
        if (document.body.classList.contains('mobile-view') && currentView === 'calendar') {
            if (touchEndX < touchStartX - swipeThreshold) {
                // Swiped left
                calendarDate.setMonth(calendarDate.getMonth() + 1);
                renderCalendar();
            } else if (touchEndX > touchStartX + swipeThreshold) {
                // Swiped right
                calendarDate.setMonth(calendarDate.getMonth() - 1);
                renderCalendar();
            }
        }
    }

    function handleMainViewSwipe() {
        // Ensure there was a touchstart event
        if (touchStartX === 0) return;

        const swipeThreshold = 50;
        const verticalThreshold = 75; // Don't swipe if scrolling vertically

        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;

        // Reset coordinates for the next swipe
        touchStartX = 0;
        touchStartY = 0;

        if (Math.abs(deltaX) < swipeThreshold || Math.abs(deltaY) > verticalThreshold) {
            // Not a long enough horizontal swipe, or it's mostly a vertical scroll
            return;
        }

        const isDashboardActive = dashboardTabBtn.classList.contains('active');
        const isStatisticsActive = statisticsTabBtn.classList.contains('active');

        if (isDashboardActive && deltaX < 0) { // Swiped left
            statisticsTabBtn.click();
        } else if (isStatisticsActive && deltaX > 0) { // Swiped right
            dashboardTabBtn.click();
        }
    }
    calendarView.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    calendarView.addEventListener('touchend', e => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipeGesture();
    }, { passive: true });

    // Swipe navigation for main views
    const setupSwipeListener = (element) => {
        element.addEventListener('touchstart', e => {
            // Do not start a swipe if the user is interacting with a form element or a scrollable area
            if (e.target.closest('input, select, textarea, button, [contenteditable]')) return;
            if (e.target.closest('.scrollable, .bill-table-wrapper, #pendingBillsList, #next30DaysList, .debt-list')) return;

            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });

        element.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            touchEndY = e.changedTouches[0].screenY;
            handleMainViewSwipe();
        }, { passive: true });
    };
    setupSwipeListener(appView);
    setupSwipeListener(statisticsView);

    [currentBalance, paycheckAmount, nextPayday, payFrequency, dontAutoDeduct].forEach(el => el.addEventListener('input', () => { saveData(); updateSummary(); }));
    document.querySelectorAll('.menu-panel input, .menu-panel select').forEach(el => {
        const event = el.type === 'range' || el.type === 'color' ? 'input' : 'change';
        el.addEventListener(event, () => {
            applyAllAppearance();
            saveData();
        });
    });
    wallpaperFile.addEventListener('change', handleWallpaperFile);
    $('exportProfileBtn').addEventListener('click', handleExportProfile);
    $('importProfileBtn').addEventListener('click', handleImportProfile);
    $('resetProfileBtn').addEventListener('click', handleResetProfile);
    $('unpaidToolBtn').addEventListener('click', handleUnpaidTool);

    $('demoModeBtn').addEventListener('click', async () => {
        const choice = await showModal({
            title: 'Enable Demo Mode?',
            text: 'This will replace your current profile with a randomized, pre-populated one.\n\nYour current data will be lost. This action cannot be undone.',
            buttons: [
                { text: 'Enable Demo', value: 'confirm', class: 'danger-btn' },
                { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
            ]
        });

        if (choice === 'confirm') {
            generateDemoProfile();
            await showModal({ 
                title: 'Demo Mode Enabled', 
                text: 'The application will now reload with the demo profile.', 
                buttons: [{ text: 'Reload', value: 'ok', class: 'save-btn' }]
            });
            location.reload();
        }
    });

    $('deactivateDemoBtn').addEventListener('click', handleResetProfile);

    window.addEventListener('resize', () => { resizeCanvas(ambianceCanvas); applyAmbianceSettings(); applyLayoutMode(); });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
             if (activeModalResolve) {
                const lastButton = genericModalButtons.lastElementChild;
                if (lastButton && lastButton.classList.contains('cancel-btn')) {
                    lastButton.click();
                }
             } else if (editModal.classList.contains('visible')) {
                closeEditModal();
             } else if (addBillModal.classList.contains('visible')) {
                addBillModal.classList.remove('visible');
             } else if (expenseModal.classList.contains('visible')) {
                expenseModal.classList.remove('visible');
             } else if ($('dayBreakdownModal').classList.contains('visible')) {
                closeDayBreakdownModal();
             }
        }
    });

    addDebtForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newDebt = {
            id: Date.now(),
            name: $('debtName').value.trim(),
            amount: parseFloat($('debtAmount').value),
            date: $('debtDate').value,
            notes: $('debtNotes').value.trim(),
            status: 'outstanding',
            paidAmount: 0
        };
        if (newDebt.name && newDebt.amount > 0 && newDebt.date) {
            debts.push(newDebt);
            addDebtForm.reset();
            $('debtDate').value = new Date().toISOString().split('T')[0];
            saveData();
            renderTheTab();
        }
    });

    debtList.addEventListener('click', async (e) => {
        const target = e.target.closest('button');
        if (!target) return;

        const item = target.closest('.debt-item');
        const debtId = Number(item.dataset.id);
        const debt = debts.find(d => d.id === debtId);
        if (!debt) return;

        if (target.classList.contains('make-payment-btn')) {
            const paidAmount = debt.paidAmount || 0;
            const remainingAmount = debt.amount - paidAmount;

            const paymentResult = await showModal({
                title: `Pay Tab for ${debt.name}`,
                customHTML: `
                    <p style="margin-bottom: 12px;">Remaining balance: <strong>${formatCurrency(remainingAmount)}</strong></p>
                    <label for="modal-input" style="display: block; margin-bottom: 4px; font-size: 14px; color: var(--muted);">Enter payment amount:</label>
                    <input type="number" id="modal-input" placeholder="${remainingAmount.toFixed(2)}" value="${remainingAmount.toFixed(2)}" step="0.01" required>`,
                buttons: [
                    { text: 'Make Payment', value: 'pay', class: 'save-btn' },
                    { text: 'Cancel', value: 'cancel', class: 'cancel-btn' },
                ]
            });
            
            const paymentAmount = parseFloat(paymentResult);

            if (paymentResult !== 'cancel' && !isNaN(paymentAmount) && paymentAmount > 0) {
                if (paymentAmount > remainingAmount + 0.001) { // Add a small tolerance for floating point issues
                     await showModal({
                        title: 'Invalid Amount',
                        text: 'Payment cannot be greater than the remaining balance.',
                        buttons: [{ text: 'OK', value: 'ok', class: 'save-btn' }]
                    });
                    return;
                }
                
                if (!dontAutoDeduct.checked) {
                    const currentBalanceVal = parseFloat(currentBalance.value) || 0;
                    currentBalance.value = (currentBalanceVal + paymentAmount).toFixed(2);
                }
                
                debt.paidAmount = (debt.paidAmount || 0) + paymentAmount;
                if (debt.paidAmount >= debt.amount) {
                    debt.status = 'satisfied';
                }
                saveData();
                renderTheTab();
                updateSummary();
            }
        } else if (target.classList.contains('dismiss-debt-btn')) {
            const choice = await showModal({
                title: 'Confirm Dismissal',
                text: `Are you sure you want to permanently remove this debt record for "${debt.name}"? This action cannot be undone.`,
                buttons: [
                    { text: 'Yes, Remove It', value: 'confirm', class: 'danger-btn' },
                    { text: 'Cancel', value: 'cancel', class: 'cancel-btn' }
                ]
            });

            if (choice === 'confirm') {
                debts = debts.filter(d => d.id !== debtId);
                saveData();
                renderTheTab();
            }
        }
    });

    function getDateRange(timeRange) {
        const endDate = new Date();
        let startDate = new Date();
        endDate.setHours(23, 59, 59, 999); // End of today

        switch (String(timeRange)) {
            case '7':
                startDate.setDate(endDate.getDate() - 7);
                break;
            case '30':
                startDate.setDate(endDate.getDate() - 30);
                break;
            case '90':
                startDate.setDate(endDate.getDate() - 90);
                break;
            case '365':
                startDate.setFullYear(endDate.getFullYear() - 1);
                break;
            case 'all':
                // Find the date of the earliest bill to set as start date
                startDate = bills.length > 0 ? new Date(bills.map(b => new Date(b.date)).sort((a, b) => a - b)[0]) : new Date();
                break;
        }
        startDate.setHours(0, 0, 0, 0); // Start of the day
        return { startDate, endDate };
    }

    function getFilteredStatsData(startDate, endDate, category) {
        return bills.filter(bill => {
            if (bill.status !== 'paid' || !bill.paidTimestamp) return false;
            const paidDate = new Date(bill.paidTimestamp);
            const categoryMatch = category === 'all' || bill.category === category;
            return paidDate >= startDate && paidDate <= endDate && categoryMatch;
        });
    }

    function calculateIncome(startDate, endDate) {
        if (!paycheckAmount.value || !nextPayday.value) return 0;
        const paydaysInRange = getPaydaysInRange(startDate, endDate);
        const paycheck = parseFloat(paycheckAmount.value) || 0;
        return paydaysInRange.length * paycheck;
    }
    
    function populateStatsCategoryFilter() {
        const selectedValue = statsCategory.value;
        while (statsCategory.options.length > 1) { statsCategory.remove(1); }
        const categories = [...new Set(bills.map(b => b.category))].sort();
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            statsCategory.appendChild(option);
        });
        if (statsCategory.querySelector(`option[value="${selectedValue}"]`)) {
            statsCategory.value = selectedValue;
        }
    }

    function getThemeColors() {
        const style = getComputedStyle(document.documentElement);
        return {
            accent: style.getPropertyValue('--accent').trim(),
            ok: style.getPropertyValue('--ok').trim(),
            danger: style.getPropertyValue('--danger').trim(),
            muted: style.getPropertyValue('--muted').trim(),
            text: style.getPropertyValue('--text').trim(),
            card: style.getPropertyValue('--card').trim(),
            border: style.getPropertyValue('--border').trim()
        };
    }

    function renderCategoryPieChart(data, colors) {
        const ctx = $('categoryPieChart').getContext('2d');
        if (!ctx || data.length === 0) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fillStyle = colors.muted;
            ctx.textAlign = 'center';
            ctx.fillText('No data for this period', ctx.canvas.width / 2, ctx.canvas.height / 2);
            return;
        }
        charts.categoryPieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.map(([cat]) => cat),
                datasets: [{
                    data: data.map(([, total]) => total),
                    backgroundColor: [colors.accent, colors.ok, '#3b82f6', '#f97316', '#8b5cf6'],
                    borderColor: colors.card,
                    borderWidth: 2,
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: colors.text } } } }
        });
    }

    function renderExpensesLineChart(bills, income, startDate, endDate, colors) {
        const ctx = $('expensesLineChart').getContext('2d');
        if (!ctx) return;

        const labels = [];
        const datePoints = {};
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const dateString = d.toISOString().split('T')[0];
            labels.push(dateString);
            datePoints[dateString] = { expenses: 0, income: 0 };
        }

        bills.forEach(bill => {
            const dateString = new Date(bill.paidTimestamp).toISOString().split('T')[0];
            if (datePoints[dateString]) {
                datePoints[dateString].expenses += getUserShare(bill);
            }
        });
        
        const paydaysInRange = getPaydaysInRange(startDate, endDate);
        paydaysInRange.forEach(pd => {
            const dateString = pd.toISOString().split('T')[0];
            if (datePoints[dateString]) {
                datePoints[dateString].income += (parseFloat(paycheckAmount.value) || 0);
            }
        });

        charts.expensesLineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Expenses', data: Object.values(datePoints).map(p => p.expenses), borderColor: colors.danger, backgroundColor: colors.danger+'33', fill: true, tension: 0.2 },
                    { label: 'Income', data: Object.values(datePoints).map(p => p.income), borderColor: colors.ok, backgroundColor: colors.ok+'33', fill: true, tension: 0.2 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: colors.text } }, x: { ticks: { color: colors.text } } }, plugins: { legend: { labels: { color: colors.text } } } }
        });
    }

    function renderBillsBarChart(bills, colors) {
        const ctx = $('billsBarChart').getContext('2d');
        if (!ctx) return;
        
        const statusCounts = bills.reduce((acc, bill) => {
            acc[bill.status] = (acc[bill.status] || 0) + 1;
            return acc;
        }, { paid: 0, unpaid: 0, pending: 0 });

        charts.billsBarChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Paid', 'Unpaid', 'Pending'],
                datasets: [{
                    label: 'Bill Status',
                    data: [statusCounts.paid, statusCounts.unpaid, statusCounts.pending],
                    backgroundColor: [colors.ok, colors.danger, colors.accent]
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { ticks: { color: colors.text, stepSize: 1 } }, y: { ticks: { color: colors.text } } }, plugins: { legend: { display: false } } }
        });
    }

    function renderCashFlowLineChart(colors) {
        const ctx = $('cashFlowLineChart').getContext('2d');
        if (!ctx) return;

        let balance = parseFloat(currentBalance.value) || 0;
        const projectionDays = 90;
        const labels = [];
        const data = [];
        
        let currentDate = new Date();
        currentDate.setHours(0,0,0,0);
        const endDate = new Date(currentDate);
        endDate.setDate(currentDate.getDate() + projectionDays);
        
        const paydays = getPaydaysInRange(currentDate, endDate);
        const recurringBills = bills.filter(b => b.frequency !== 'One-Time' && b.status !== 'paid');

        for (let i = 0; i <= projectionDays; i++) {
            labels.push(currentDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}));
            
            // Add income
            if (paydays.some(pd => pd.getTime() === currentDate.getTime())) {
                balance += (parseFloat(paycheckAmount.value) || 0);
            }

            // Subtract bills due
            const billsDueToday = getBillsForDate(currentDate);
            billsDueToday.forEach(bill => {
                 if (recurringBills.some(rb => rb.id === bill.id)) {
                    balance -= getUserShare(bill);
                 }
            });
            
            data.push(balance);
            currentDate.setDate(currentDate.getDate() + 1);
        }

        charts.cashFlowLineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: 'Projected Balance', data: data, borderColor: colors.accent, backgroundColor: colors.accent+'33', fill: true, tension: 0.3 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: colors.text } }, x: { ticks: { color: colors.text } } } }
        });
    }

    function renderStatistics() {
        // Destroy existing charts
        Object.values(charts).forEach(chart => {
            if(chart) chart.destroy();
        });

        const timeRange = statsTimeRange.value;
        const category = statsCategory.value;
        const { startDate, endDate } = getDateRange(timeRange);
        const themeColors = getThemeColors();

        // --- Calculations ---
        const filteredPaidBills = getFilteredStatsData(startDate, endDate, category);
        const totalIncome = calculateIncome(startDate, endDate);
        const totalExpenses = filteredPaidBills.reduce((sum, bill) => sum + getUserShare(bill), 0);
        const netBalance = totalIncome - totalExpenses;
        
        const allBillsInRange = bills.filter(b => {
             const billDate = new Date(b.date + 'T00:00:00');
             const categoryMatch = category === 'all' || b.category === category;
             return billDate >= startDate && billDate <= endDate && categoryMatch;
        });
        const paidBillsCount = filteredPaidBills.length;
        const totalBillsCount = allBillsInRange.length;

        // --- Update Summary Cards ---
        $('statsTotalIncome').textContent = formatCurrency(totalIncome);
        $('statsTotalExpenses').textContent = formatCurrency(totalExpenses);
        $('statsNetBalance').textContent = formatCurrency(netBalance);
        $('statsNetBalance').style.color = netBalance >= 0 ? 'var(--ok)' : 'var(--danger)';
        $('statsBillsPaid').textContent = `${paidBillsCount} / ${totalBillsCount}`;

        // --- Update Tables ---
        const categories = filteredPaidBills.reduce((acc, bill) => {
            const category = bill.category || 'Uncategorized';
            if (category === 'Expense') return acc;
            acc[category] = (acc[category] || 0) + getUserShare(bill);
            return acc;
        }, {});
        const topCategories = Object.entries(categories).sort(([, a], [, b]) => b - a).slice(0, 5);
        $('topCategoriesList').innerHTML = topCategories.length > 0 ? topCategories.map(([cat, total], i) => `<p>${i + 1}. ${cat}: <strong>${formatCurrency(total)}</strong></p>`).join('') : '<p>No expense data for this period.</p>';

        const largestExpenses = [...filteredPaidBills];
        const largestByName = new Map();
        for (const bill of largestExpenses) {
            const existing = largestByName.get(bill.name);
            if (!existing || getUserShare(bill) > getUserShare(existing)) {
                largestByName.set(bill.name, bill);
            }
        }
        const uniqueLargestExpenses = Array.from(largestByName.values()).sort((a, b) => getUserShare(b) - getUserShare(a)).slice(0, 5);
        $('largestExpensesList').innerHTML = uniqueLargestExpenses.length > 0 ? uniqueLargestExpenses.map((bill, i) => `<p>${i + 1}. ${bill.name}: <strong>${formatCurrency(getUserShare(bill))}</strong></p>`).join('') : '<p>No expenses logged for this period.</p>';

        const recurringBills = bills.filter(b => b.frequency !== 'One-Time' && b.category !== 'Expense');
        const recurringOverview = recurringBills.reduce((acc, bill) => {
            const freq = bill.frequency;
            if (!acc[freq]) { acc[freq] = { total: 0, count: 0 }; }
            acc[freq].total += bill.amount;
            acc[freq].count++;
            return acc;
        }, {});
        $('recurringBillsList').innerHTML = Object.keys(recurringOverview).length > 0 ? Object.entries(recurringOverview).map(([freq, { total, count }]) => `<p>${freq}: <strong>${formatCurrency(total / count)}</strong> (avg)</p>`).join('') : '<p>No recurring bills set up.</p>';
            
        if(enableTheTab.checked) {
            const totalOwedToYou = debts.reduce((sum, debt) => sum + (debt.amount - (debt.paidAmount || 0)), 0);
            const debtsByPerson = debts.reduce((acc, debt) => {
                const remaining = debt.amount - (debt.paidAmount || 0);
                if (remaining > 0.001) { acc[debt.name] = (acc[debt.name] || 0) + remaining; }
                return acc;
            }, {});
            $('debtStatsList').innerHTML = `<div><h4>Owed to You: <strong style="color: var(--ok)">${formatCurrency(totalOwedToYou)}</strong></h4><h4>You Owe Others: <strong style="color: var(--danger)">${formatCurrency(0)}</strong></h4><small style="color: var(--muted)">(Tracking debts you owe is not yet supported)</small></div><div><h4>Breakdown by Person (Owed to You):</h4>${Object.keys(debtsByPerson).length > 0 ? Object.entries(debtsByPerson).map(([name, amount]) => `<p>${name}: <strong>${formatCurrency(amount)}</strong></p>`).join('') : '<p>No outstanding debts.</p>'}</div>`;
            $('debtStatsCard').style.display = 'block';
        } else {
            $('debtStatsCard').style.display = 'none';
        }

        // --- Render Charts ---
        renderCategoryPieChart(topCategories, themeColors);
        renderExpensesLineChart(filteredPaidBills, totalIncome, startDate, endDate, themeColors);
        renderBillsBarChart(allBillsInRange, themeColors);
        renderCashFlowLineChart(themeColors);
    }

    dashboardTabBtn.addEventListener('click', () => {
        if (dashboardTabBtn.classList.contains('active')) return;

        appView.style.display = 'flex';
        archiveView.style.display = 'none';
        statisticsView.style.display = 'none';

        dashboardTabBtn.classList.add('active');
        statisticsTabBtn.classList.remove('active');
        
        // Ensure the correct view (list/calendar) is rendered within the main app
        renderApp(true); 
    });

    statisticsTabBtn.addEventListener('click', () => {
        if (statisticsTabBtn.classList.contains('active')) return;

        statisticsView.style.display = 'flex';
        appView.style.display = 'none';
        archiveView.style.display = 'none';

        statisticsTabBtn.classList.add('active');
        dashboardTabBtn.classList.remove('active');

        populateStatsCategoryFilter();
        renderStatistics();
    });

    [statsTimeRange, statsCategory].forEach(el => el.addEventListener('change', renderStatistics));

    // --- INITIALIZATION ---
    function setupAccordionAnimation(details) {
        // On desktop, the finance card should not be collapsible via click.
        if (details.id === 'financeCard' && window.innerWidth > 768) {
            return;
        }

        const summary = details.querySelector('summary');
        // Use nextElementSibling for direct child, which is more reliable for this structure.
        const content = summary.nextElementSibling; 

        if (!summary || !content) return;

        let isAnimating = false;

        summary.addEventListener('click', (e) => {
            if (!enableNaturalSlide.checked) {
                return; // Allow default behavior
            }

            e.preventDefault();
            if (isAnimating) return;

            isAnimating = true;

            if (details.hasAttribute('open')) {
                // Closing animation
                const height = content.scrollHeight;
                const speed = parseFloat(slideSpeed.value) || 1000;
                const duration = (height / speed) * 1000;

                content.style.height = `${height}px`;
                content.style.overflow = 'hidden';
                content.style.transition = `height ${duration}ms var(--slide-ease)`;
                
                requestAnimationFrame(() => {
                    content.style.height = '0px';
                });

                setTimeout(() => {
                    details.removeAttribute('open');
                    content.style.height = '';
                    content.style.transition = '';
                    content.style.overflow = '';
                    isAnimating = false;
                }, duration);
            } else {
                // Opening animation
                details.setAttribute('open', '');
                const height = content.scrollHeight;
                const speed = parseFloat(slideSpeed.value) || 1000;
                const duration = (height / speed) * 1000;

                content.style.height = '0px';
                content.style.overflow = 'hidden';
                content.style.transition = `height ${duration}ms var(--slide-ease)`;

                requestAnimationFrame(() => {
                    content.style.height = `${height}px`;
                });

                setTimeout(() => {
                    content.style.height = ''; // Let it be auto
                    content.style.transition = '';
                    content.style.overflow = '';
                    isAnimating = false;
                }, duration);
            }
        });
    }

    // Initialize all accordions
    document.querySelectorAll('#billTrackerCard, #pastBillsCard, #financeCard, #theTabCard, #archive-filters, .menu-panel details').forEach(setupAccordionAnimation);

    function setupBillAccordions() {
        if (window.innerWidth <= 768) return;

        const upcomingBills = $('billTrackerCard');
        const pastBills = $('pastBillsCard');

        upcomingBills.addEventListener('toggle', () => {
            if (upcomingBills.open) {
                pastBills.removeAttribute('open');
            }
        });

        pastBills.addEventListener('toggle', () => {
            if (pastBills.open) {
                upcomingBills.removeAttribute('open');
            }
        });
    }
    setupBillAccordions();

    resizeCanvas(ambianceCanvas); loadData(); requestAnimationFrame(mainLoop);
})();
</script>
</body>
</html>